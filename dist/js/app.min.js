(function () {
	'use strict';
	angular.module('rssreader', ['ui.router', 'ngAnimate', 'ngValidate', 'ngFileUpload', 'ngTouch', 'favicon', 'dndLists', 'satellizer', 'angular-jwt', '720kb.socialshare', 'ui.bootstrap'])
		.config(['$stateProvider', '$urlRouterProvider', '$authProvider', function ($stateProvider, $urlRouterProvider, $authProvider) {
			$urlRouterProvider.otherwise('home');
			$stateProvider
				.state('home', {
					url: '/home',
					templateUrl: './partials/home.html',
					controller: 'HomeController'
				})
				.state('404', {
					url: '/not-found',
					templateUrl: './partials/static/404_page.html',
					controller: ['$scope', function ($state) {
					}]
				})
				.state('login', {
					url: '/login',
					templateUrl: './partials/auth/login.html',
					controller: 'AuthController',
					onEnter: ['$state', 'authService', function ($state, authService) {
						if (authService.isLoggedIn()) {
							$state.go('home');
						}
					}]
				})
				.state('register', {
					url: '/register',
					templateUrl: './partials/auth/register.html',
					controller: 'AuthController',
					onEnter: ['$state', 'authService', function ($state, authService) {
						if (authService.isLoggedIn()) {
							$state.go('home');
						}
					}]
				})
				.state('profile', {
					url: '/profile',
					templateUrl: './partials/auth/profile.html',
					controller: 'ProfileController',
					resolve: {
						profilePromise: ['profileService', function(profileService){
							return profileService.getProfile();
						}]
					},
					onEnter: ['$state', 'authService', function ($state, authService) {
						if (!authService.isLoggedIn()) {
							authService.logOut();
							$state.go('home');
						}
					}]
				})
				.state("dashboard", {
					url: '/dashboard',
					views: {
						'': {
							templateUrl: './partials/dashboard/dashboard.html',
							controller: 'DashboardController'
						},
						'sidebar@dashboard': {
							templateUrl: './partials/dashboard/sidebar.html',
							controller: 'SidebarController'
						},
						'feedHead@dashboard': {
							templateUrl: './partials/dashboard/feed-head.html',
							controller: 'DashboardController'
						}
					},
					resolve: {
						profilePromise: ['profileService', function(profileService){
							return profileService.getProfile();
						}],
						feedPromise: ['feedsService', function (feedsService) {
							return feedsService.getAllFeeds();
						}]
					},
					onEnter: ['articlesService', 'dashboardService', function (articlesService, dashboardService) {
						articlesService.getAllArticles();
					}]
				})
				.state("dashboard.list", {
					url: '/list',
					templateUrl: './partials/list/list.html',
					controller: 'ArticlesController'
				})
				.state("dashboard.th-list", {
					url: '/th-list',
					templateUrl: './partials/list/th-list.html',
					controller: 'ArticlesController'
				})
				.state("dashboard.th-large", {
					url: '/th-large',
					templateUrl: './partials/list/th-large.html',
					controller: 'ArticlesController'
				})
				.state("dashboard.addFeed", {
					url: '/add',
					templateUrl: './partials/dashboard/add-feed.html',
					controller: 'FeedsController',
					onEnter: ['dashboardService', function (dashboardService) {
						dashboardService.setTitle("Add Feed");
					}]
				})
				.state("dashboard.article", {
					url: '/article/:feed/:link',
					templateUrl: './partials/dashboard/article.html',
					controller: 'ArticlesController'
				});
			$authProvider.facebook({
				clientId: '173686319709284',
				name: 'facebook',
				url: '/auth/facebook',
				authorizationEndpoint: 'https://www.facebook.com/v2.5/dialog/oauth',
				redirectUri: window.location.origin + '/',
				requiredUrlParams: ['display', 'scope'],
				scope: ['email'],
				scopeDelimiter: ',',
				display: 'popup',
				oauthType: '2.0',
				popupOptions: {
					width: 580,
					height: 400
				}
			});

			$authProvider.google({
				clientId: '806677097865-va2i3kq96mmu8i00t9k6q92ks1s9tg0l.apps.googleusercontent.com',
				url: '/auth/google',
				authorizationEndpoint: 'https://accounts.google.com/o/oauth2/auth',
				redirectUri: 'http://localhost:8080',
				requiredUrlParams: ['scope'],
				optionalUrlParams: ['display'],
				scope: ['profile', 'email'],
				scopePrefix: 'openid',
				scopeDelimiter: ' ',
				display: 'popup',
				oauthType: '2.0',
				popupOptions: {
					width: 452,
					height: 633
				}
			});

			$authProvider.twitter({
				url: '/auth/twitter',
				authorizationEndpoint: 'https://api.twitter.com/oauth/authenticate',
				redirectUri: window.location.origin,
				oauthType: '1.0',
				popupOptions: {
					width: 495,
					height: 645
				}
			});

		}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').controller('ArticlesController', ['$scope', '$state', '$stateParams', 'toasterService', 'dateFilter', 'feedsService', 'articlesService', 'dashboardService', function ($scope, $state, $stateParams, toasterService, dateFilter, feedsService, articlesService, dashboardService) {
		$scope.obj = {};
		$scope.newCatObj = {};
		$scope.categories = feedsService.allFavsCategories;
		$scope.error = null;
		$scope.modalShown = false;
		$scope.articles = articlesService.articles;
		$scope.isFavourites = articlesService.checkIfFavourites;
		$scope.favForAdd = null;
		$scope.favForRemove = null;
		$scope.articleForShare = null;
		$scope.articleForRead = null;
		$scope.addingNewFavCategory = false;

		if ($stateParams.feed !== undefined && $stateParams.link !== undefined) {
		    dashboardService.isReadingArticle = true;
		    articlesService.setReadArticle($scope, $stateParams.feed, $stateParams.link);
		}
		else {
		    dashboardService.isReadingArticle = false;
		    if (feedsService.feedsDictionary.length < 1 && !$scope.isFavourites()) {
		        $state.go("dashboard.addFeed");
		    }
		}

		$scope.getArticles = function () {
		    return articlesService.articles;
		}

		$scope.getSortParam = function () {
			var sortParam = dashboardService.getSortParam();
			if (sortParam.type === 'feed') {
				return ['feed', 'date'];
			}
			return sortParam;
		}

		$scope.checkIfNew = function () {
			if ($scope.obj.category.toUpperCase() == 'custom'.toUpperCase()) {
				$scope.addingNewFavCategory = true;
			}
			else {
				$scope.addingNewFavCategory = false;
				$scope.newCatObj.category = null;
			}
		}
        
		$scope.addFavourite = function (article) {
			$scope.error = null;
			$scope.modalShown = !$scope.modalShown;
			$scope.favForAdd = article;
		}
		
        $scope.confirmAddFavourite = function () {
			$scope.error = '';
			if ($scope.newCatObj.category) {
				$scope.obj.category = $scope.newCatObj.category;
			}
			if ($scope.obj.category) {
				if (!$scope.newCatObj.category && $scope.obj.category.toUpperCase() == 'custom'.toUpperCase()) {
					$scope.error = "Enter new category name";
					return;
				}
			}
            
			$scope.favForAdd.category = $scope.obj.category;
			articlesService.addFavourite($scope.favForAdd).then(function (res) {
				$scope.addingNewCategory = false;
				toasterService.success("Article marked as favourite");
				$state.reload("dashboard");
			}, function (err) {
				console.log(err);
				if (!err.data)
					$scope.error = err.message;
				else $scope.error = err.data.message;
			});
		}

        $scope.cancelAddFavourite = function () {
			$scope.modalShown = false;
			$scope.favForAdd = {};
		}

		$scope.share = function (article) {
			$scope.error = null;
			//$scope.modalShareShown = !$scope.modalShareShown;
			$scope.articleForShare = article;
		}

		$scope.cancelSharing = function () {
			$scope.modalShareShown = false;
			$scope.articleForShare = {};
		}

        $scope.removeFavourite = function (article) {
			$scope.favForRemove = article;
			toasterService.confirm({
				message: "Remove this article?",
				confirm: "confirmRemoveFavourite"
			}, $scope);
		}

        $scope.confirmRemoveFavourite = function () {
			articlesService.removeFavourite($scope.favForRemove).then(function (res) {
				toasterService.info("Article removed from favourites");
				$state.reload("dashboard");
			}, function (err) {
				console.log(err);
			});
		}

        $scope.getArticleDate = function (date) {
		    if (!date) {
		        return;
		    };
			return dateFilter(new Date(date), "dd/MM/yy HH:mm");
		}

		$scope.readArticle = function (article) {
		    dashboardService.isReadingArticle = true;
			$state.go("dashboard.article", {feed: article.feed, link: article.link});
		}
	}]);
})();
(function() {
	
	angular.module('rssreader').config(['$validatorProvider', function($validatorProvider) {
		$validatorProvider.addMethod("pattern", function(value, element) {
			return this.optional(element) || /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*(_|[^\w])).{6,20}/.test(value);
		}, "Password must contain(a-z,A-Z,0-9,!@#)");
	}]).
	controller('AuthController', ['$scope', '$state', 'authService', 'profileService', '$window', 'dashboardService', '$auth', 'transfer', 'jwtHelper', 'toasterService', function ($scope, $state, authService, profileService, $window,  dashboardService, $auth, transfer, jwtHelper, toasterService) {
		$scope.user = {};
		$scope.test = 5;
		$scope.session;

		var ERRORS = {
			field_required: 'This field is required',
			email_example: 'Please, use example: jacksparrow@gmail.com',
			min_6symbl: 'Please, enter at least 6 characters',
			min_9symbl: 'Please, enter at least 9 characters',
			max_20symbl: 'Please, enter no more then 40 characters',
			reg_exp: 'Password must contain(a-z,A-Z,0-9,!@#)'
		}

		$scope.register = function (form) {
			if (form.validate()) {
				authService.register($scope.user).error(function (error) {
					$scope.error = error;
				}).then(function (response) {
					console.log(response);
					toasterService.success('You have successfully registered');
					$state.go('dashboard.' + dashboardService.getViewMode(), {
						id: authService.userID()
					});
				});
			}
		};

		$scope.logIn = function (form) {
			if (form.validate()) {
				console.log($scope.user);
				authService.logIn($scope.user, $scope.session).error(function (error) {
					$scope.error = error;
				}).then(function () {
					if (!$scope.session) {
						$scope.onExit = function () {
							auth.logOut();
						};
						$state.go('dashboard.' + dashboardService.getViewMode(), {
							id: authService.userID()
						});
						toasterService.success('You have successfully login');
						$window.onbeforeunload = $scope.onExit;
					} else {
						$state.go('dashboard.' + dashboardService.getViewMode(), {
							id: authService.userID()
						});
						toasterService.success('You have successfully login');
					}
				});
			}
		};

		$scope.authenticate = function (provider) {
			$auth.authenticate(provider).then(function (response) {
				authService.saveToken(response.data.token);
				toasterService.success('You have successfully authenticated');
				$state.go('dashboard.' + dashboardService.getViewMode(), {
					id: authService.userID()
				});
			})
		}

		$scope.validationLoginOptions = {
			rules: {
				mail: {
					required: true,
					email: true
				},
				pwd: {
					required: true
				}
			},
			messages: {
				mail: {
					required: ERRORS.field_required,
					email: ERRORS.email_example
				},

				pwd: {
					required: ERRORS.field_required
				}
			}
		};

		$scope.validationRegistrOptions = {
			rules: {
				mail: {
					required: true,
					email: true,
					minlength: 9,
					maxlength: 40,
				},
				pwd: {
					required: true,
					minlength: 6,
					maxlength: 20,
					pattern: true
				},
				reppwd: {
					required: true
				}
			},
			messages: {
				mail: {
					required: ERRORS.field_required,
					email: ERRORS.email_example,
					minlength: ERRORS.min_9symbl,
					maxlength: ERRORS.max_20symbl
				},

				pwd: {
					required: ERRORS.field_required,
					minlength: ERRORS.min_6symbl,
					maxlength: ERRORS.max_20symbl,
					pattern: ERRORS.reg_exp
				},

				reppwd: {
					required: ERRORS.field_required
				}
			}
		}
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').controller('DashboardController', ['$scope', '$state', 'dashboardService', 'feedsService', 'toasterService', function ($scope, $state, dashboardService, feedsService, toasterService) {
		$scope.loadingIcon = dashboardService.isLoading;
		$scope.sidebar = dashboardService.checkSidebar;
		$scope.headTitle = dashboardService.getTitle;
		$scope.feed = dashboardService.getFeedId;
		$scope.alertMsg = dashboardService.alertMsg;
		$scope.successMsg = dashboardService.successMsg;
		$scope.checkIfReading = function () {
		    return dashboardService.isReadingArticle;
		};

		$scope.toggleSidebar = function () {
			dashboardService.sidebar = !dashboardService.sidebar;
		}
		$scope.hideSidebar = function () {
			dashboardService.sidebar = false;
		}
		$scope.showSidebar = function () {
			dashboardService.sidebar = true;
		}

		$scope.hideViewBtns = function () {
			if ($scope.headTitle() === "Add Feed" || feedsService.feedsDictionary.length == 0) {
				return true;
			} else {
				return false;
			}
		}
		$scope.checkIfToggled = function (mode) {
			return dashboardService.getViewMode() === mode;
		}
        
		$scope.checkSortType = function (type, order) {
			var sortType = dashboardService.getSortParam();
			if (type == sortType.type && order == sortType.order) {
				return true;
			}
			else return false;
		}
        
		$scope.onViewChange = function (view) {
			switch (view) {
				case 'view-mode1':
					dashboardService.setViewMode(0);
					break;
				case 'view-mode2':
					dashboardService.setViewMode(1);
					break;
				case 'view-mode3':
					dashboardService.setViewMode(2);
					break;
			}
			$state.go('dashboard.' + dashboardService.getViewMode());
		}
		var timer;
		$scope.onFeedDelete = function () {
			toasterService.confirm({
				message: "Remove this feed?",
				confirm: "confirmFeedDelete"
			}, $scope);
		}
		$scope.confirmFeedDelete = function () {
			feedsService.removeFeed(dashboardService.getFeedId())
				.then(function (res) {
					toasterService.info("Feed has been deleted");
					$state.reload("dashboard");
				}, function (err) {
					console.log(err);
				});
		}
		$scope.currentSortTitle = function () {
			var sortParam = dashboardService.getSortParam();
			switch (sortParam.type) {
			    case 'date': {
			        if (sortParam.order == 1){
			            return "Newest";
			        }
			        else {
			            return "Oldest";
			        }
			    }
			        break;
			    case 'feed': {
			        return "By Feed";            
			    }
			        break;
			}
		}
		var sortTypeElement;
		$scope.setSortParam = function (e, type, order) {
			if (sortTypeElement) {
				sortTypeElement.removeClass('selected');
			}
			sortTypeElement = angular.element(e.currentTarget);
			sortTypeElement.addClass('selected');
			dashboardService.setSortParam(type, order);
		}
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').controller('FeedsController', ['$scope', '$state', '$http', 'toasterService', 'feedsService', 'dashboardService', 'articlesService', 'authService', function ($scope, $state, $http, toasterService, feedsService, dashboardService, articlesService, authService) {
		$scope.obj = {};
		$scope.feeds = feedsService.feedsDictionary;
		$scope.categories = feedsService.allCategories;
		$scope.addingNewCategory = false;
		$scope.newCategory = null;
		$scope.checkIfNew = function () {
			if ($scope.obj.category.toUpperCase() == 'custom'.toUpperCase()) {
				$scope.addingNewCategory = true;
			}
			else {
				$scope.addingNewCategory = false;
				$scope.newCategory = null;
			}
		}
		$scope.addFeed = function () {
			$scope.error = '';
			if ($scope.newCategory) {
				$scope.obj.category = $scope.newCategory;
			}
			if (!$scope.obj.category) {
			    $scope.error = "Choose category";
			    return;
			}
			if (!$scope.newCategory && $scope.obj.category.toUpperCase() == 'custom'.toUpperCase()) {
				$scope.error = "Enter new category name";
				return;
			}
			feedsService.addFeed($scope.obj)
				.then(function (res) {
					$scope.addingNewCategory = false;
					toasterService.success("Feed successfully added");
                    $state.go('dashboard.' + dashboardService.getViewMode(), {}, { reload: true });
				}, function (err) {
					if (!err.data)
						$scope.error = err.message;
					else $scope.error = err.data.message;
				});
		}
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').controller('HomeController', ['$scope', '$state', 'authService', 'dashboardService', 'feedsService', function ($scope, $state, authService, dashboardService, feedsService) {
		$scope.isLoggedIn = authService.isLoggedIn;
		$scope.currentUser = authService.currentUser;
		$scope.onFeeds = function () {
			if (authService.isLoggedIn()) {
				$state.go('dashboard.' + dashboardService.getViewMode(), {
					id: authService.userID()
				});
			} else {
				$state.go('home');
			}
		}
		$scope.onFeeds();
		$scope.onRegister = function () {
			$state.go('register');
		}
		$scope.onLogin = function () {
			$state.go('login');
		}
	}]);
})();
(function () {
	angular.module('rssreader').controller('IndexController', ['$scope', 'authService', '$window', 'themeService', function ($scope, authService, $window, themeService) {
		$scope.layout = themeService.getTheme;
		$scope.text = "some text";
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').controller('NavbarController', ['$scope', '$state','profileService', 'authService', 'dashboardService', 'transfer', 'accountInfo', '$auth',
		function ($scope, $state,profileService, authService, dashboardService, transfer, accountInfo, $auth) {
			// $scope.profile = profileService.profile;
			$scope.isLoggedIn = authService.isLoggedIn;
			$scope.isDashboard = function () {
				return /dashboard/.test($state.current.name);
			}
			$scope.currentUser = profileService.refreshProfileData;
			$scope.toggleSidebar = function () {
			    $scope.hideMobileNavbar();
				dashboardService.sidebar = !dashboardService.sidebar;
				$scope.getProfile();
			}

			$scope.hideSidebar = function () {
				dashboardService.sidebar = false;
			}

			$scope.hideMobileNavbar = function () {
			    angular.element(document.querySelector("#bs-example-navbar-collapse-1")).removeClass('in');
			}

			$scope.logOut = function () {
			    $scope.hideMobileNavbar();
				authService.logOut();
				$state.go("home");
			}

			$scope.onEmblem = function () {
			    $scope.hideMobileNavbar();
				if (authService.isLoggedIn()) {
					if ($scope.isDashboard()) {
						$state.reload('dashboard');
					}
					else $state.go("dashboard." + dashboardService.getViewMode());
				} else {
					$state.go("home");
				}
			}
			$scope.goToProgile = function () {
			    $state.go("profile");
			    $scope.hideMobileNavbar();
			}
			$scope.getProfile = function () {
				accountInfo.getProfile().then(function (response) {
					if ($auth.isAuthenticated()) {
						var lenght = response.data.user.length;
						for (var i = 0; i < lenght; i++) {
							if (response.data.user[i].email === $auth.getPayload().email) {
								$scope.profile = response.data.user[i];
							}
						}
					}
				})
			};
			$scope.getProfile();
			$scope.getImage = function(){
				return profileService.getImage();
			};
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').config(['$validatorProvider', function ($validatorProvider) {
		$validatorProvider.addMethod("pattern", function (value, element) {
			return this.optional(element) || /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*(_|[^\w])).{6,20}/.test(value);
		}, "Please specify the correct domain for your documents");
	}]).controller('ProfileController', ['Upload', '$http', '$state', 'profileService', '$scope',
		'authService', '$window', 'themeService', 'dashboardService', '$auth', 'accountInfo', 'toasterService',
		function (Upload, $http, $state, profileService, $scope,
			authService, $window, themeService, dashboardService, $auth, accountInfo, toasterService) {
			$scope.currentUser = profileService.refreshProfileData;
			
			$scope.link = function (provider) {
				$auth.link(provider).then(function () {
					toasterService.info('You have successfully linked a ' + provider + ' account');
					profileService.getProfile();
				});
			};

			$scope.unlink = function (provider) {
				$http.post('/auth/unlink', {
					id: profileService.refreshProfileData()._id,
					provider: provider
				}).then(function (response) {
					toasterService.info('You have unlinked a ' + provider + ' account');
					profileService.getProfile();
				});
			};

			$scope.updateProfile = function () {
				profileService.getProfile();
			};

			$scope.newUserData = {
				email: profileService.refreshProfileData().email,
				currentPass: "",
				newPass: "",
				newPassRepeat: ""
			}

			$scope.submit = function () { //function to call on form submit
				if ($scope.upload_form.file.$valid && $scope.file) { //check if from is valid
					$scope.upload($scope.file); //call upload function
				}
			};

			$scope.upload = function (file) {
				console.log($scope.file);
				Upload.upload({
					url: '/upload', //webAPI exposed to upload the file
					data: {
						file: file,
						user: authService.userID()
					} //pass file as data, should be user ng-model
				}).then(function (resp) { //upload function returns a promise
					if (resp.data.error_code === 0) { //validate success
						profileService.getProfile();
					} else {
						$window.alert('an error occured');
					}
				}, function (resp) { //catch error
					console.log('Error status: ' + resp.status);
					$window.alert('Error status: ' + resp.status);
				}, function (evt) {
					console.log(evt);
					var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);
					console.log('progress: ' + progressPercentage + '% ' + evt.config.data.file.name);
					$scope.progress = 'progress: ' + progressPercentage + '% '; // capture upload progress
				});
			};

			var PROFILE_ERRORS = {
				field_required: 'This field is required',
				email_example: 'Please, use example: jacksparrow@gmail.com',
				min_6symbl: 'Please,enter at least 6 characters',
				min_9symbl: 'Please,enter at least 9 characters',
				max_20symbl: 'Please,no more then 20 characters',
				reg_exp: 'Password must contain(a-z,A-Z,0-9,!@#)'
			};

			$scope.changePass = function (form) {
				if (form.validate()) {
					console.log("Submit change password");
					return $http.post('/changePassword', $scope.newUserData, {
						headers: {
							Authorization: 'Bearer ' + authService.getToken()
						}
					}).success(function (data) {
						toasterService.success('You have successfully changed pswd');
						authService.saveToken(data.token);
						$state.go('dashboard.' + dashboardService.getViewMode(), {
							id: authService.userID()
						});
					}).error(function (err) {
						$scope.err = err;
						console.log(err.message);
					});
				}
			};

			$scope.changePassValidation = {
				rules: {
					currentPassword: {
						required: true
					},
					newPassword: {
						required: true,
						minlength: 6,
						maxlength: 40,
						pattern: true
					},
					repeatNewPassword: {
						required: true
					}
				},
				messages: {
					currentPassword: {
						required: PROFILE_ERRORS.field_required,
						email: PROFILE_ERRORS.email_example,
						minlength: PROFILE_ERRORS.min_9symbl,
						maxlength: PROFILE_ERRORS.max_20symbl
					},
					newPassword: {
						required: PROFILE_ERRORS.field_required,
						minlength: PROFILE_ERRORS.min_6symbl,
						maxlength: PROFILE_ERRORS.max_20symbl,
						pattern: PROFILE_ERRORS.reg_exp
					},
					repeatNewPassword: {
						required: PROFILE_ERRORS.field_required
					}
				}
			};

			$scope.updateTheme = function () {
				themeService.layout = $scope.layout;
			};

			$scope.layout = themeService.layout;
			$scope.layouts = themeService.layouts;
		}
	]);
})();

(function () {
	'use strict';
	angular.module('rssreader').controller('SidebarController', ['$scope', '$state', 'feedsService', 'articlesService', 'dashboardService', function ($scope, $state, feedsService, articlesService, dashboardService) {
		$scope.feedsListDragableTypes = ['feeds'];
		$scope.favsListDragableTypes = ['favs'];
		$scope.currentArticlesType = dashboardService.currentArticlesType;
		$scope.currentSelectedItem;
		$scope.feeds = feedsService.feedsDictionary;
		$scope.favs = feedsService.favouritesDictionary;
		$scope.onFeedsDrag = function (index) {
			dashboardService.loadingIcon = true;
			$scope.feeds.splice(index, 1);
			feedsService.setFeedsOrder().then(function (resp) {
				dashboardService.loadingIcon = false;
			});
		}
		$scope.onFavsDrag = function (index) {
			dashboardService.loadingIcon = true;
			$scope.favs.splice(index, 1);
			feedsService.setFavsOrder().then(function (resp) {
				dashboardService.loadingIcon = false;
			});
		}
		$scope.getAll = function ($event) {
			setArticlesType(angular.element($event.currentTarget).parent(), 'all');
			// if there is only one category and feed, return this feed articles
			if ($scope.feeds.length === 1 && $scope.feeds[0].values.length === 1) {
				articlesService.getArticlesByFeed($scope.feeds[0].values[0]);
			} else {
				articlesService.getAllArticles();
			}
			$state.go("dashboard." + dashboardService.getViewMode());
		}
		$scope.getByFeed = function ($event, feed) {
			setArticlesType(angular.element($event.currentTarget).parent());
			articlesService.getArticlesByFeed(feed);
			$state.go("dashboard." + dashboardService.getViewMode());
		}
		$scope.getByCat = function ($event, cat, index) {
			setArticlesType(angular.element($event.currentTarget).parent(), 'category', cat);
			if ($event.currentTarget.attributes[4]) {
				if ($event.currentTarget.attributes[4].value == 'true') {
					angular.element($event.currentTarget).removeClass('chevron-down');
				}
				if ($event.currentTarget.attributes[4].value == 'false') {
					angular.element($event.currentTarget).addClass('chevron-down');
				}
			}
			else {
				angular.element($event.currentTarget).addClass('chevron-down');
			}
			// if there is only one feed within selected category, return its articles
			if ($scope.feeds[arguments[2]].values.length == 1) {
				articlesService.getArticlesByFeed($scope.feeds[arguments[2]].values[0]);
			} else {
				articlesService.getArticlesByCat(arguments[1]);
			}
			$state.go("dashboard." + dashboardService.getViewMode());
		}
		$scope.getFavourites = function ($event) {
			setArticlesType(angular.element($event.currentTarget).parent(), 'favourites');
			if ($event.currentTarget.attributes[4]) {
				if ($event.currentTarget.attributes[4].value == 'true') {
					angular.element($event.currentTarget).removeClass('chevron-down');
				}
				if ($event.currentTarget.attributes[4].value == 'false') {
					angular.element($event.currentTarget).addClass('chevron-down');
				}
			}
			else {
				angular.element($event.currentTarget).addClass('chevron-down');
			}
			articlesService.getFavourites();
			$state.go("dashboard." + dashboardService.getViewMode());
		}
		$scope.getFavArticlesByCat = function ($event, cat) {
			setArticlesType(angular.element($event.currentTarget).parent(), 'category', cat);
			if ($event.currentTarget.attributes[4]) {
				if ($event.currentTarget.attributes[4].value == 'true') {
					angular.element($event.currentTarget).removeClass('chevron-down');
				}
				if ($event.currentTarget.attributes[4].value == 'false') {
					angular.element($event.currentTarget).addClass('chevron-down');
				}
			}
			else {
				angular.element($event.currentTarget).addClass('chevron-down');
			}
			articlesService.getFavArticlesByCat(arguments[1]);
			$state.go("dashboard." + dashboardService.getViewMode());
		}
		$scope.getFavArticle = function ($event, article) {
			setArticlesType(angular.element($event.currentTarget).parent());
			articlesService.getFavArticle(article);
			$state.go("dashboard." + dashboardService.getViewMode());
		}
		$scope.hideFavourites = function () {
			return $scope.favs.length;
		}

		$scope.checkIfEmpty = function () {
			if (feedsService.feedsDictionary.length == 0) {
				return false;
			} else return true;
		}
		$scope.toggle = false;
		
		var setArticlesType = function (element, type, value) {
			if (type && value) {
				dashboardService.setCurrentArticlesType(type, value);
			}
			if ($scope.currentSelectedItem) {
				$scope.currentSelectedItem.removeClass('selected');
			}
			$scope.currentSelectedItem = element;
			$scope.currentSelectedItem.addClass('selected');
		}
	}]);
})();
angular.module('rssreader').directive('modal', [function () {
	return {
		restrict: 'E',
		scope: {
			show: '='
		},
		replace: true,
		transclude: true,
		link: function (scope, element, attrs) {
			scope.modalStyle = {};

			scope.hideModal = function () {
				scope.show = false;
			};
		},
		templateUrl: '../partials/modals/modal.html'
	};
}]);

angular.module('rssreader').directive('pwCheck', [function() {
		return {
			require: 'ngModel',
			link: function(scope, elem, attrs, ctrl) {
				var firstPassword = '#' + attrs.pwCheck;
				elem.add(firstPassword).on('keyup', function() {
					scope.$apply(function() {
						if (elem.val() === "") {
							return;
						}
						var v = elem.val() === $(firstPassword).val();
						ctrl.$setValidity('pwmatch', v);
					});
				});
			}
		}
	}]);
angular.module('rssreader').directive('checkStrength', [function() {
	return {
		replace: false,
		restrict: 'EACM',
		link: function(scope, iElement, iAttrs) {
			var strength = {
				colors: ['#F00', '#F90', '#FF0', '#9F0', '#0F0'],
				mesureStrength: function(p) {
					if (p) {
						var _force = 0,
							_regex = /[#@$-/:-?-~!"^_`]/g,
							_lowerLetters = /[a-z]+/.test(p),
							_upperLetters = /[A-Z]+/.test(p),
							_numbers = /[0-9]+/.test(p),
							_symbols = _regex.test(p),
							_flags = [_lowerLetters, _upperLetters, _numbers, _symbols],
							_passedMatches = $.grep(_flags, function(el) {
								return el === true;
							}).length;

                            _force += 2 * p.length + ((p.length >= 10) ? 1 : 0);
                            _force += _passedMatches * 10;

                            // penality (short password)
                            _force = (p.length <= 5) ? Math.min(_force, 10) : _force;
                            // penality (poor variety of characters)
                            _force = (_passedMatches == 1) ? Math.min(_force, 10) : _force;
                            _force = (_passedMatches == 2) ? Math.min(_force, 20) : _force;
                            _force = (_passedMatches == 3) ? Math.min(_force, 40) : _force;

						return _force;

					} else {
						return scope.user.password = '';
					}
				},
				getColor: function(s) {
					var idx = 0;
					if (s <= 10) { idx = 0; } else if (s <= 20) { idx = 1; } else if (s <= 30) { idx = 2; } else if (s <= 40) { idx = 3; } else { idx = 4; }

					return { idx: idx + 1, col: this.colors[idx] };
				}
			};
			scope.$watch(iAttrs.checkStrength, function() {
				if (scope.user.password === '') {
					iElement.css({ "display": "none" });
				} else {
					var c = strength.getColor(strength.mesureStrength(scope.user.password));
					iElement.css({ "display": "block" });
					iElement.children('li')
						.css({ "background": "#DDD" })
						.slice(0, c.idx)
						.css({ "background": c.col });
				}
			});
		},
		template: '<li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li>'
	};
}]);
angular.module('rssreader').directive('toaster', ['$timeout', 'toasterService', function ($timeout, toasterService) {
	return {
		restrict: 'E',
		transclude: true,
		link: function (scope, element, attrs) { 
			if (attrs.overlay) {
				scope.overlay = true;
			}
			else {
				scope.overlay = false;
			}
			if (attrs.delay) {
				scope.delay = attrs.delay;
			}
			else {
				scope.delay = 5000;
			}
			scope.toasterStyle = {};
			scope.confirm = function () {
				scope.$parent[attrs.confirm]();
				scope.hideToaster();
			}
			scope.reject = function () {
				scope.hideToaster();
			}
			scope.hideToaster = function () {
				$timeout.cancel(scope.timer);
				scope.$destroy();
				toasterService.removeToaster(element);
			};
			scope.timer = $timeout(function () {
				scope.hideToaster();
			}, scope.delay);
		},
		templateUrl: '../partials/modals/toaster.html'
	};
}]);
(function () {
	'use strict';
	angular.module('rssreader')
	.factory('accountInfo', ['$http', function ($http) {
		return {
			getProfile: function () {
				return $http.get('/api/me');
			},
			updateProfile: function (profileData) {
				return $http.put('/api/me', profileData);
			}
		};
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').factory('articlesService', ['$http', '$state', '$q', 'authService', '$timeout', 'dashboardService', 'feedsService', function ($http, $state, $q, authService, $timeout, dashboardService, feedsService) {
		var ARTICLES_NUM = 50,
			temp_articles = [],
			defer = $q.defer(),
			promises = [],
			obj = {
				articles: [],
				articleForRead: null,
				isFavourites: false,
				checkIfFavourites: function () {
					return obj.isFavourites;
				},
				setReadArticle: function ($scope, feed, link) {
					for (var i = 0; i < obj.articles.length; i++) {
						if (obj.articles[i].link === link) {
							$scope.articleForRead = obj.articles[i];
							return;
						}
					}
					return getFeedDataById(feed).success(function (res) {
						obj.resetArticles();
						var feedObj = res;
						return fetchArticles(feedObj).then(function (res) {
							for (var i = 0; i < temp_articles.length; i++) {
								if (temp_articles[i].link === link) {
									$scope.articleForRead = temp_articles[i];
								}
							}
							if (!$scope.articleForRead) {
								$state.go("404");
							}
						});
					}).catch(function (err) {
						obj.resetArticles();
						return getArticleDataByLink(link).then(function (res) {
							dashboardService.loadingIcon = false;
							$scope.articleForRead = res.data;
						}).catch(function (err) {
							dashboardService.loadingIcon = false;
							if (err.status === 404) {
								$state.go("404");
							}
						});
						if (err.status === 404) {
							$state.go("404");
						}
						else $state.go("dashboard." + dashboardService.getViewMode());
					});
				},
				getAllArticles: function () {
					obj.resetArticles();
					dashboardService.setTitle("All");
					angular.forEach(feedsService.feedsDictionary, function (value, key) {
						angular.forEach(value.values, function (value, key) {
							promises.push(fetchArticles(value));
						});
					});
					$q.all(promises).then(function () {
						obj.articles = temp_articles;
						dashboardService.loadingIcon = false;
					});

				},
				getArticlesByFeed: function (feed) {
					obj.resetArticles();
					dashboardService.setTitle(feed.title);
					dashboardService.setFeedId(feed._id);
					fetchArticles(feed).then(function () {
						obj.articles = temp_articles;
					});
				},
				getArticlesByCat: function (cat) {
					obj.resetArticles();
					dashboardService.setTitle(cat);
					angular.forEach(feedsService.feedsDictionary, function (value, key) {
						if (value.key === cat) {
							angular.forEach(value.values, function (value, key) {
								promises.push(fetchArticles(value));
							});
						}
					});
					$q.all(promises).then(function () {
						obj.articles = temp_articles;
					});
				},
				getFavourites: function () {
					obj.resetArticles();
					obj.isFavourites = true;
					dashboardService.setTitle("Favourites");
					angular.forEach(feedsService.favouritesDictionary, function (value, key) {
						angular.forEach(value.values, function (value, key) {
							obj.articles.push(value);
						});
					});
					dashboardService.loadingIcon = false;
				},
				getFavArticlesByCat: function (cat) {
					obj.resetArticles();
					obj.isFavourites = true;
					dashboardService.setTitle("Favourites: " + cat);
					angular.forEach(feedsService.favouritesDictionary, function (value, key) {
						if (value.key === cat) {
							angular.forEach(value.values, function (value, key) {
								obj.articles.push(value);
							});
						}
					});
					dashboardService.loadingIcon = false;
				},
				getFavArticle: function (article) {
					obj.resetArticles();
					obj.isFavourites = true;
					dashboardService.setTitle("Favourites");
					obj.articles.push(article);
					dashboardService.loadingIcon = false;
				},
				addFavourite: function (article) {
					dashboardService.loadingIcon = true;
					return $http.post('/users/' + authService.userID() + '/addFavArticle', article, {
						headers: {
							Authorization: 'Bearer ' + authService.getToken()
						}
					}).then(function (res) {
						dashboardService.loadingIcon = false;
					});
				},
				removeFavourite: function (article) {
					dashboardService.loadingIcon = true;
					return $http.delete('/users/' + authService.userID() + '/deleteFavFeed/' + article._id, {
						headers: {
							Authorization: 'Bearer ' + authService.getToken()
						}
					}).then(function (res) {
						dashboardService.loadingIcon = false;
					});
				},
				resetArticles: function () {
					dashboardService.loadingIcon = true;
					temp_articles.length = 0;
					obj.articles.length = 0;
					obj.isFavourites = false;
					dashboardService.resetFeedId();
					promises.length = 0;
				},
				// Additional method for unit testing
				getArticlesFetcher: function () {
					return fetchArticles;
				}
			},
			getImage = function (item, format) {
				var source = "";
				if (format === "RSS") {
					if (!item.getElementsByTagName('enclosure').length) {
						try {
							source = $(item).find('media\\:content, content')[0].getAttribute('url');
						} catch (err) {
							source = "";
						}
						if (source == "" || source == undefined) {
							try {
								var content = document.createElement('div');
								content.innerHTML = item.getElementsByTagName('description')[0].textContent;
								source = $(content).find('img')[0].src;
							} catch (err) {
								source = "";
							}
						}
					} else {
						source = item.getElementsByTagName('enclosure')[0].getAttribute('url');
					}
				} else if (format === "ATOM") {
					if (!item.getElementsByTagName('enclosure').length) {
						try {
							var content = document.createElement('div');
							content.innerHTML = item.getElementsByTagName('content')[0].textContent;
							source = $(content).find('img')[0].src;
						} catch (err) {
							source = "";
						}
					}
				}
				return source;
			},
			getContent = function (item, format) {
				var content = "";
				if (format === "RSS") {
					try {
						content = document.createElement('div');
						content.innerHTML = item.getElementsByTagName('description')[0].textContent;
						content = $(content).text();
					} catch (err) { }
				} else if (format === "ATOM") {
					content = $(item.getElementsByTagName('content')[0].childNodes[0].data).text();
				}
				return content;
			},
			fetchArticles = function (feed) {
				return $http.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=" + ARTICLES_NUM + "&q=" + encodeURIComponent(feed.rsslink) + "&method=JSONP&callback=JSON_CALLBACK&output=xml")
					.then(function (response) {
						var parser = new DOMParser(),
							xmlDoc = parser.parseFromString(response.data.responseData.xmlString, "text/xml"),
							items = [];
						if (feed.format === "RSS") {
							items = xmlDoc.getElementsByTagName('item');
							for (var i = 0; i < items.length; i++) {
								var articleObj = {
									title: items[i].getElementsByTagName('title')[0].innerHTML,
									link: items[i].getElementsByTagName('link')[0].textContent,
									img: getImage(items[i], feed.format),
									content: getContent(items[i], feed.format),
									date: Date.parse(items[i].getElementsByTagName('pubDate')[0].textContent),
									feed: feed._id
								};
								articleObj.content = articleObj.content || articleObj.title;
								temp_articles.push(articleObj);
							}
						} else if (feed.format === "ATOM") {
							items = xmlDoc.getElementsByTagName('entry');
							for (var i = 0; i < items.length; i++) {
								var articleObj = {
									title: items[i].getElementsByTagName('title')[0].textContent,
									link: items[i].getElementsByTagName('id')[0].textContent,
									img: getImage(items[i], feed.format),
									content: getContent(items[i], feed.format),
									date: Date.parse(items[i].getElementsByTagName('published')[0].textContent),
									feed: feed._id
								};
								articleObj.content = articleObj.content || articleObj.title;
								temp_articles.push(articleObj);
							}
						}
						dashboardService.loadingIcon = false;
						return response.data;
					});
			},
			getFeedDataById = function (id) {
				return $http.post('/users/' + authService.userID() + '/getFeedData', { id: id }, {
					headers: {
						Authorization: 'Bearer ' + authService.getToken()
					}
				});
			},
			getArticleDataByLink = function (link) {
				return $http.post('/users/' + authService.userID() + '/getFavArticle', { link: link }, {
					headers: {
						Authorization: 'Bearer ' + authService.getToken()
					}
				});
			}
		return obj;
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').factory('authService', ['$http', '$window', '$auth', 'transfer', 'jwtHelper', 'toasterService', 'profileService', function ($http, $window, $auth, transfer, jwtHelper, toasterService, profileService) {
		var auth = {
			saveToken: function (token) {
				$auth.setToken(token);
			},
			getToken: function () {
				return $auth.getToken();
			},
			isLoggedIn: function () {
				return $auth.isAuthenticated();
			},
			currentUser: function () {
				return  profileService.refreshProfileData().email;
			},
			userID: function () {
				if (auth.isLoggedIn()) {
					var payload = $auth.getPayload();
					return payload.sub;
				}
			},
			register: function (user) {
				return $http.post('/register', user).success(function (data) {
					auth.saveToken(data.token);
				}).error(function (err) {
					console.log(err.message);
				});
			},
			logIn: function (user) {
				return $http.post('/login', user).success(function (data) {
					auth.saveToken(data.token);
				}).error(function (err) {
					console.log(err.message);
				});
			},
			logOut: function () {
		$auth.removeToken();
			$auth.logout();
			}
		}
		return auth;
	}]);
})();

angular.module('rssreader').service('dashboardService', ['$window', function ($window) {
	var that = this;
	this.DEFAULT_VIEW = 2;
	this.loadingIcon = false;
	this.currentArticlesType = 'all';
	this.currentArticlesValue = $window.localStorage.category;
	this.isReadingArticle = false;

	this.sortParam = {
		type: 'date',
		order: 0
	};
	if ($window.localStorage.sortType) {
		this.sortParam.type = $window.localStorage.sortType;
		if ($window.localStorage.sortOrder) {
			this.sortParam.order = +$window.localStorage.sortOrder;
		}
	}
	else {
		$window.localStorage.sortType = this.sortParam.type;
		$window.localStorage.sortOrder = this.sortParam.order;
	}
	this.setSortParam = function (type, order) {
		this.sortParam.type = type;
		this.sortParam.order = order;
		$window.localStorage.sortType = this.sortParam.type;
		$window.localStorage.sortOrder = this.sortParam.order;
	}
	this.getSortParam = function () {
		return that.sortParam;
	}

    if (!$window.localStorage.articlesType) {
		$window.localStorage.articlesType = that.currentArticlesType;
	}

	if ($window.localStorage.category) {
		currentArticlesValue = $window.localStorage.category;
	}

	this.setCurrentArticlesType = function (type, value) {
		that.currentArticlesValue = null;
		that.currentArticlesType = type;
		$window.localStorage.articlesType = that.currentArticlesType;
		if (value) {
			that.currentArticlesValue = value;
			$window.localStorage.category = that.currentArticlesValue;
		}
	}
	this.getCurrentArticlesType = function () {
		that.currentArticlesType = $window.localStorage.articlesType;
		return that.currentArticlesType;
	}
	if (!$window.localStorage.viewMode) {
		$window.localStorage.viewMode = this.DEFAULT_VIEW;
	}
	this.isLoading = function () {
		return that.loadingIcon;
	};
	this.sidebar = false;
	this.checkSidebar = function () {
		return that.sidebar;
	}
	this.modalShown = false;
	this.currentViewMode = $window.localStorage.viewMode;
	this.viewModes = [
		'list',
		'th-list',
		'th-large'
	];
	this.resetViewMode = function () {
		$window.localStorage.viewMode = this.DEFAULT_VIEW;
	}
	this.setViewMode = function (index) {
		$window.localStorage.viewMode = index;
		if (index > that.viewModes.length - 1) {
			throw new Error("View mode you are trying to set is not defined");
		} else {
			that.currentViewMode = $window.localStorage.viewMode;
		}
	}
	this.getViewMode = function () {
		that.currentViewMode = $window.localStorage.viewMode;
		return that.viewModes[that.currentViewMode];
	}
	this.title = '';
	this.setTitle = function (title) {
		if (title == "Add Feed") {
			this.resetFeedId();
		}
		that.title = title;
	}
	this.getTitle = function () {
		return that.title;
	}

	this.currentFeed = '';
	this.getFeedId = function () {
		return that.currentFeed;
	}
	this.setFeedId = function (id) {
		that.currentFeed = id;
	}
	this.resetFeedId = function () {
		that.currentFeed = '';
	}
}]);
angular.module('rssreader').service('feedsService', ['$http', '$state', 'authService', 'dashboardService', function ($http, $state, authService, dashboardService) {
	that = this;
	this.feedsDictionary = [];
	this.favouritesDictionary = [];
	this.allArticles = [];
	this.CATEGORIES = ["News", "IT", "Sport", "Design", "Movies", "Music", "Culture", "Nature", "Economics", "Science"];
	this.allCategories = function () {
		var res = that.CATEGORIES.concat(getCustomCategories());
		res.push("Custom");
		return res;
	}
	this.allFavsCategories = function () {
		var res = that.CATEGORIES.concat(getFavsCustomCategories());
		res.push("Custom");
		return res;
	}
	var getCustomCategories = function () {
		var currentFeedsCats = (function () {
			var res = [];
			for (var i = 0; i < that.feedsDictionary.length; i++) {
				res.push(that.feedsDictionary[i].key);
			}
			return res;
		})();
		return currentFeedsCats.filter(function (elem, i, array) {
			return that.CATEGORIES.indexOf(elem) == -1;
		});
	}

	var getFavsCustomCategories = function () {
		var currentFeedsCats = (function () {
			var res = [];
			for (var i = 0; i < that.favouritesDictionary.length; i++) {
				res.push(that.favouritesDictionary[i].key);
			}
			return res;
		})();
		return currentFeedsCats.filter(function (elem, i, array) {
			return (that.CATEGORIES.indexOf(elem) == -1 && elem != 'Unsorted');
		});
	}
	this.getAllFeeds = function () {
		return $http.get('/users/' + authService.userID(), {
			headers: {
				Authorization: 'Bearer ' + authService.getToken()
			}
		}).then(function (res) {
			angular.copy(res.data, that.feedsDictionary);
			that.getAllFavourites().then(function (res) {
				angular.copy(res.data, that.favouritesDictionary);
			});
		});
	}
	this.getAllFavourites = function () {
		return $http.get('/users/' + authService.userID() + "/favourites", {
			headers: {
				Authorization: 'Bearer ' + authService.getToken()
			}
		});
	}
	var checkRssFormat = function (xmlDoc) {
		//Determine if RSS
		if (xmlDoc.getElementsByTagName('rss').length) {
			return 'RSS';
			//Determine if ATOM
		} else if (xmlDoc.getElementsByTagName('feed').length) {
			return 'ATOM';
		}
		return -1;
	}
	var generateFeed = function (doc, feed, format) {
		var feedObj = {};
		if (format === 'RSS') {
			var channel = doc.getElementsByTagName('channel')[0];
			feedObj.title = channel.getElementsByTagName('title')[0].childNodes[0].nodeValue;
			feedObj.description = channel.getElementsByTagName('description')[0].childNodes[0] ? channel.getElementsByTagName('description')[0].childNodes[0].nodeValue : '';
			feedObj.link = channel.getElementsByTagName("link")[0].childNodes[0].nodeValue;
			feedObj.rsslink = feed.link;
			feedObj.category = feed.category;
		} else if (format === 'ATOM') {
			feedObj.title = doc.getElementsByTagName('title')[0].childNodes[0].nodeValue;
			feedObj.description = '';
			feedObj.link = doc.getElementsByTagName('link')[0].getAttribute('href');
			feedObj.rsslink = feed.link;
			feedObj.category = feed.category;
		}
		feedObj.format = format;
		return feedObj;
	}
	this.getFeedGenerator = function () {
		return generateFeed;
	}
	this.getRssChecker = function () {
		return checkRssFormat;
	}
	this.addFeed = function (feed) {
		return $http.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&q=" + encodeURIComponent(feed.link) + "&method=JSON&callback=JSON_CALLBACK&output=xml")
			.then(function (response) {
				if (feed.link === undefined) {
					throw new Error("Enter Rss feed link");
				}
				if (feed.category === undefined) {
					throw new Error("Choose category");
				}
				if (response.data.responseData === null) {
					throw new Error("URL is incorrect or does not contain RSS Feed data");
				}
				var parser = new DOMParser();
				xmlDoc = parser.parseFromString(response.data.responseData.xmlString, "text/xml");
				var format = checkRssFormat(xmlDoc);
				if (format === -1) {
					throw new Error("URL is incorrect or does not contain RSS Feed data");
				} else {
					var feedObj = generateFeed(xmlDoc, feed, format);
					return $http.post('/users/' + authService.userID() + '/addFeed', feedObj, {
						headers: {
							Authorization: 'Bearer ' + authService.getToken()
						}
					});
				}
				return response.data;
			});
	}

	this.removeFeed = function (feedId) {
		return $http.delete('/users/' + authService.userID() + '/deleteFeed/' + feedId, {
			headers: {
				Authorization: 'Bearer ' + authService.getToken()
			}
		});
	}

	this.setFeedsOrder = function () {
		var obj = {
			newCategories: []
		}
		for (var i = 0; i < that.feedsDictionary.length; i++) {
			obj.newCategories.push(that.feedsDictionary[i].key);
		}
		return $http.post('/users/' + authService.userID() + '/setCategoryOrder', obj, {
			headers: {
				Authorization: 'Bearer ' + authService.getToken()
			}
		});
	}

	this.setFavsOrder = function () {
		var obj = {
			newCategories: []
		}
		for (var i = 0; i < that.favouritesDictionary.length; i++) {
			obj.newCategories.push(that.favouritesDictionary[i].key);
		}
		return $http.post('/users/' + authService.userID() + '/setFavsCategoryOrder', obj, {
			headers: {
				Authorization: 'Bearer ' + authService.getToken()
			}
		});
	}
}]);
(function() {
	'use strict';
	angular.module('rssreader')
		.factory('profileService', ['$window', 'Upload', 'accountInfo', '$auth',
			function($window, Upload, accountInfo, $auth) {
				var obj = {
					profile: {},
					getProfile: function() {
						if ($auth.isAuthenticated()) {
							return accountInfo.getProfile().then(function(response) {
								var length = response.data.user.length;
								for (var i = 0; i < length; i++) {
									if (response.data.user[i].email === $auth.getPayload().email) {
										obj.profile = response.data.user[i];
									}
								}
							});
						}
					},
					refreshProfileData: function() {
						return obj.profile;
					}
				}
				return obj;
			}
		]);
})();
(function () {
	'use strict';
	angular.module('rssreader').service('themeService', ['authService', '$window', function (authService, $window) {
		var that = this;
		this.layout = 'style';
		this.getTheme = function () {
			return that.layout !== undefined ? that.layout : "style";
		}
		this.layouts = [
			{
				name: 'Blue',
				url: 'style'
			},
			{
				name: 'Black',
				url: 'style2'
			},
			{
				name: 'Grey',
				url: 'style3'
			}
		];
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader').service('toasterService', ['$rootScope', '$compile', '$animate', function ($rootScope, $compile, $animate) {
		var domParent = angular.element('body');

		//********************************************************************************
		//  You can pass custom options to toaster methods as second parameter
		//  options properties:
		//  message: string
		//  overlay: boolean
		//  delay: value (ms)
		//  position: [left, right, left-bottom, right-bottom]
		//  type: one of ['toaster-default', 'toaster-success', 'toaster-info', 'toaster-error']
		//  iconClass: string (name of glyph class, ex: fa fa-info)
		//  confirm: Function (callback that will ba called if user confirm toaster action)
		// 
		//********************************************************************************

		var buildToaster = function (options, scope, onShow) {
			var callback = arguments[2],
				elem = angular.element(document.createElement("toaster"));
			elem.addClass('toaster-wrapper');
			elem.addClass(options.type);
			if (options.overlay) {
				elem.attr("overlay", options.overlay);
			}

			if (options.delay) {
				elem.attr("delay", options.delay);
			}

			if (options.confirm) {
				elem.attr("confirm", options.confirm);
			}
			var icon = angular.element(document.createElement("div"));
			icon.addClass('toaster-icon');
			icon.addClass(options.iconClass);
			elem.append(icon);

			elem.append("<span>" + options.message + "</span>");
			if (options.htmlContent) {
				elem.append("<span>" + options.htmlContent + "</span>");
			}
			var appendHtml;
			if (typeof arguments[1] === 'object') {
				appendHtml = $compile(elem, scope)(scope.$new());
			}
			else {
				appendHtml = $compile(elem, scope)($rootScope.$new());
			}
			$animate.enter(appendHtml, domParent).then(function () {
				if (typeof callback === 'function') {
					onShow();
				}
			});
		}
		this.success = function (message, customOptions, scope, onShow) {
			var defaultOptions = {
				message: message,
				type: 'toaster-success',
				iconClass: 'fa fa-check',
				delay: 3000
			},
			options;
			if (typeof customOptions === 'object') {
				options = angular.extend({}, defaultOptions, customOptions);
			}
			else {
				options = defaultOptions;
			}
			buildToaster(options, scope, onShow);
		}
		this.info = function (message, customOptions, scope, onShow) {
			var defaultOptions = {
				message: message,
				type: 'toaster-info',
				iconClass: 'fa fa-info',
				delay: 3000
			},
			options;
			if (typeof arguments[1] === 'object') {
				options = angular.extend({}, defaultOptions, customOptions);
			}
			else {
				options = defaultOptions;
			}
			buildToaster(options, scope, onShow);
		}
		this.error = function (message, customOptions, scope, onShow) {
			var defaultOptions = {
				message: message,
				type: 'toaster-error',
				iconClass: 'fa fa-exclamation-triangle',
				delay: 3000
			},
			options;
			if (typeof arguments[1] === 'object') {
				options = angular.extend({}, defaultOptions, customOptions);
			}
			else {
				options = defaultOptions;
			}
			buildToaster(options, scope, onShow);
		}
		this.custom = function (customOptions, scope, onShow) {
			var defaultOptions = {
				message: message,
				type: 'toaster-default',
				overlay: true,
				iconClass: 'fa fa-info',
			},
			options;
			if (typeof arguments[0] === 'object') {
				options = angular.extend({}, defaultOptions, customOptions);
			}
			else {
				options = defaultOptions;
			}
			buildToaster(options, scope, onShow);
		}
		this.confirm = function (customOptions, scope, onShow) {
			var defaultOptions = {
				message: 'Confirm?',
				type: 'toaster-default',
				overlay: true,
				iconClass: 'fa fa-question',
				htmlContent: "<button class='app-btn-toaster-red' aria-label='Justify' ng-click='confirm()'>yes</button><button class='app-btn-toaster' aria-label='Justify' ng-click='reject()'>no</button>"
			},
			options;
			if (typeof customOptions === 'object') {
				options = angular.extend({}, defaultOptions, customOptions);
			}
			else {
				options = defaultOptions;
			}
			buildToaster(options, scope, onShow);
		}
		this.removeToaster = function (element) {
			$animate.leave(element, domParent).then(function () {
			});
		}
	}]);
})();
(function () {
	'use strict';
	angular.module('rssreader')
		.factory('transfer', [function () {
			var obj = {};
			function setObj(data) {
				obj = data;
			}
			function getObj() {
				return obj;
			}
			return {
				setObj: setObj,
				getObj: getObj
			}
  }]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJhcHAuanMiXSwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcclxuXHQndXNlIHN0cmljdCc7XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicsIFsndWkucm91dGVyJywgJ25nQW5pbWF0ZScsICduZ1ZhbGlkYXRlJywgJ25nRmlsZVVwbG9hZCcsICduZ1RvdWNoJywgJ2Zhdmljb24nLCAnZG5kTGlzdHMnLCAnc2F0ZWxsaXplcicsICdhbmd1bGFyLWp3dCcsICc3MjBrYi5zb2NpYWxzaGFyZScsICd1aS5ib290c3RyYXAnXSlcclxuXHRcdC5jb25maWcoWyckc3RhdGVQcm92aWRlcicsICckdXJsUm91dGVyUHJvdmlkZXInLCAnJGF1dGhQcm92aWRlcicsIGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlciwgJHVybFJvdXRlclByb3ZpZGVyLCAkYXV0aFByb3ZpZGVyKSB7XHJcblx0XHRcdCR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJ2hvbWUnKTtcclxuXHRcdFx0JHN0YXRlUHJvdmlkZXJcclxuXHRcdFx0XHQuc3RhdGUoJ2hvbWUnLCB7XHJcblx0XHRcdFx0XHR1cmw6ICcvaG9tZScsXHJcblx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvaG9tZS5odG1sJyxcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXI6ICdIb21lQ29udHJvbGxlcidcclxuXHRcdFx0XHR9KVxyXG5cdFx0XHRcdC5zdGF0ZSgnNDA0Jywge1xyXG5cdFx0XHRcdFx0dXJsOiAnL25vdC1mb3VuZCcsXHJcblx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvc3RhdGljLzQwNF9wYWdlLmh0bWwnLFxyXG5cdFx0XHRcdFx0Y29udHJvbGxlcjogWyckc2NvcGUnLCBmdW5jdGlvbiAoJHN0YXRlKSB7XHJcblx0XHRcdFx0XHR9XVxyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0LnN0YXRlKCdsb2dpbicsIHtcclxuXHRcdFx0XHRcdHVybDogJy9sb2dpbicsXHJcblx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvYXV0aC9sb2dpbi5odG1sJyxcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXI6ICdBdXRoQ29udHJvbGxlcicsXHJcblx0XHRcdFx0XHRvbkVudGVyOiBbJyRzdGF0ZScsICdhdXRoU2VydmljZScsIGZ1bmN0aW9uICgkc3RhdGUsIGF1dGhTZXJ2aWNlKSB7XHJcblx0XHRcdFx0XHRcdGlmIChhdXRoU2VydmljZS5pc0xvZ2dlZEluKCkpIHtcclxuXHRcdFx0XHRcdFx0XHQkc3RhdGUuZ28oJ2hvbWUnKTtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fV1cclxuXHRcdFx0XHR9KVxyXG5cdFx0XHRcdC5zdGF0ZSgncmVnaXN0ZXInLCB7XHJcblx0XHRcdFx0XHR1cmw6ICcvcmVnaXN0ZXInLFxyXG5cdFx0XHRcdFx0dGVtcGxhdGVVcmw6ICcuL3BhcnRpYWxzL2F1dGgvcmVnaXN0ZXIuaHRtbCcsXHJcblx0XHRcdFx0XHRjb250cm9sbGVyOiAnQXV0aENvbnRyb2xsZXInLFxyXG5cdFx0XHRcdFx0b25FbnRlcjogWyckc3RhdGUnLCAnYXV0aFNlcnZpY2UnLCBmdW5jdGlvbiAoJHN0YXRlLCBhdXRoU2VydmljZSkge1xyXG5cdFx0XHRcdFx0XHRpZiAoYXV0aFNlcnZpY2UuaXNMb2dnZWRJbigpKSB7XHJcblx0XHRcdFx0XHRcdFx0JHN0YXRlLmdvKCdob21lJyk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1dXHJcblx0XHRcdFx0fSlcclxuXHRcdFx0XHQuc3RhdGUoJ3Byb2ZpbGUnLCB7XHJcblx0XHRcdFx0XHR1cmw6ICcvcHJvZmlsZScsXHJcblx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvYXV0aC9wcm9maWxlLmh0bWwnLFxyXG5cdFx0XHRcdFx0Y29udHJvbGxlcjogJ1Byb2ZpbGVDb250cm9sbGVyJyxcclxuXHRcdFx0XHRcdHJlc29sdmU6IHtcclxuXHRcdFx0XHRcdFx0cHJvZmlsZVByb21pc2U6IFsncHJvZmlsZVNlcnZpY2UnLCBmdW5jdGlvbihwcm9maWxlU2VydmljZSl7XHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKTtcclxuXHRcdFx0XHRcdFx0fV1cclxuXHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRvbkVudGVyOiBbJyRzdGF0ZScsICdhdXRoU2VydmljZScsIGZ1bmN0aW9uICgkc3RhdGUsIGF1dGhTZXJ2aWNlKSB7XHJcblx0XHRcdFx0XHRcdGlmICghYXV0aFNlcnZpY2UuaXNMb2dnZWRJbigpKSB7XHJcblx0XHRcdFx0XHRcdFx0YXV0aFNlcnZpY2UubG9nT3V0KCk7XHJcblx0XHRcdFx0XHRcdFx0JHN0YXRlLmdvKCdob21lJyk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1dXHJcblx0XHRcdFx0fSlcclxuXHRcdFx0XHQuc3RhdGUoXCJkYXNoYm9hcmRcIiwge1xyXG5cdFx0XHRcdFx0dXJsOiAnL2Rhc2hib2FyZCcsXHJcblx0XHRcdFx0XHR2aWV3czoge1xyXG5cdFx0XHRcdFx0XHQnJzoge1xyXG5cdFx0XHRcdFx0XHRcdHRlbXBsYXRlVXJsOiAnLi9wYXJ0aWFscy9kYXNoYm9hcmQvZGFzaGJvYXJkLmh0bWwnLFxyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXI6ICdEYXNoYm9hcmRDb250cm9sbGVyJ1xyXG5cdFx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0XHQnc2lkZWJhckBkYXNoYm9hcmQnOiB7XHJcblx0XHRcdFx0XHRcdFx0dGVtcGxhdGVVcmw6ICcuL3BhcnRpYWxzL2Rhc2hib2FyZC9zaWRlYmFyLmh0bWwnLFxyXG5cdFx0XHRcdFx0XHRcdGNvbnRyb2xsZXI6ICdTaWRlYmFyQ29udHJvbGxlcidcclxuXHRcdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdFx0J2ZlZWRIZWFkQGRhc2hib2FyZCc6IHtcclxuXHRcdFx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvZGFzaGJvYXJkL2ZlZWQtaGVhZC5odG1sJyxcclxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyOiAnRGFzaGJvYXJkQ29udHJvbGxlcidcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdHJlc29sdmU6IHtcclxuXHRcdFx0XHRcdFx0cHJvZmlsZVByb21pc2U6IFsncHJvZmlsZVNlcnZpY2UnLCBmdW5jdGlvbihwcm9maWxlU2VydmljZSl7XHJcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKTtcclxuXHRcdFx0XHRcdFx0fV0sXHJcblx0XHRcdFx0XHRcdGZlZWRQcm9taXNlOiBbJ2ZlZWRzU2VydmljZScsIGZ1bmN0aW9uIChmZWVkc1NlcnZpY2UpIHtcclxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gZmVlZHNTZXJ2aWNlLmdldEFsbEZlZWRzKCk7XHJcblx0XHRcdFx0XHRcdH1dXHJcblx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0b25FbnRlcjogWydhcnRpY2xlc1NlcnZpY2UnLCAnZGFzaGJvYXJkU2VydmljZScsIGZ1bmN0aW9uIChhcnRpY2xlc1NlcnZpY2UsIGRhc2hib2FyZFNlcnZpY2UpIHtcclxuXHRcdFx0XHRcdFx0YXJ0aWNsZXNTZXJ2aWNlLmdldEFsbEFydGljbGVzKCk7XHJcblx0XHRcdFx0XHR9XVxyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0LnN0YXRlKFwiZGFzaGJvYXJkLmxpc3RcIiwge1xyXG5cdFx0XHRcdFx0dXJsOiAnL2xpc3QnLFxyXG5cdFx0XHRcdFx0dGVtcGxhdGVVcmw6ICcuL3BhcnRpYWxzL2xpc3QvbGlzdC5odG1sJyxcclxuXHRcdFx0XHRcdGNvbnRyb2xsZXI6ICdBcnRpY2xlc0NvbnRyb2xsZXInXHJcblx0XHRcdFx0fSlcclxuXHRcdFx0XHQuc3RhdGUoXCJkYXNoYm9hcmQudGgtbGlzdFwiLCB7XHJcblx0XHRcdFx0XHR1cmw6ICcvdGgtbGlzdCcsXHJcblx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvbGlzdC90aC1saXN0Lmh0bWwnLFxyXG5cdFx0XHRcdFx0Y29udHJvbGxlcjogJ0FydGljbGVzQ29udHJvbGxlcidcclxuXHRcdFx0XHR9KVxyXG5cdFx0XHRcdC5zdGF0ZShcImRhc2hib2FyZC50aC1sYXJnZVwiLCB7XHJcblx0XHRcdFx0XHR1cmw6ICcvdGgtbGFyZ2UnLFxyXG5cdFx0XHRcdFx0dGVtcGxhdGVVcmw6ICcuL3BhcnRpYWxzL2xpc3QvdGgtbGFyZ2UuaHRtbCcsXHJcblx0XHRcdFx0XHRjb250cm9sbGVyOiAnQXJ0aWNsZXNDb250cm9sbGVyJ1xyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0LnN0YXRlKFwiZGFzaGJvYXJkLmFkZEZlZWRcIiwge1xyXG5cdFx0XHRcdFx0dXJsOiAnL2FkZCcsXHJcblx0XHRcdFx0XHR0ZW1wbGF0ZVVybDogJy4vcGFydGlhbHMvZGFzaGJvYXJkL2FkZC1mZWVkLmh0bWwnLFxyXG5cdFx0XHRcdFx0Y29udHJvbGxlcjogJ0ZlZWRzQ29udHJvbGxlcicsXHJcblx0XHRcdFx0XHRvbkVudGVyOiBbJ2Rhc2hib2FyZFNlcnZpY2UnLCBmdW5jdGlvbiAoZGFzaGJvYXJkU2VydmljZSkge1xyXG5cdFx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFRpdGxlKFwiQWRkIEZlZWRcIik7XHJcblx0XHRcdFx0XHR9XVxyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0LnN0YXRlKFwiZGFzaGJvYXJkLmFydGljbGVcIiwge1xyXG5cdFx0XHRcdFx0dXJsOiAnL2FydGljbGUvOmZlZWQvOmxpbmsnLFxyXG5cdFx0XHRcdFx0dGVtcGxhdGVVcmw6ICcuL3BhcnRpYWxzL2Rhc2hib2FyZC9hcnRpY2xlLmh0bWwnLFxyXG5cdFx0XHRcdFx0Y29udHJvbGxlcjogJ0FydGljbGVzQ29udHJvbGxlcidcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0JGF1dGhQcm92aWRlci5mYWNlYm9vayh7XHJcblx0XHRcdFx0Y2xpZW50SWQ6ICcxNzM2ODYzMTk3MDkyODQnLFxyXG5cdFx0XHRcdG5hbWU6ICdmYWNlYm9vaycsXHJcblx0XHRcdFx0dXJsOiAnL2F1dGgvZmFjZWJvb2snLFxyXG5cdFx0XHRcdGF1dGhvcml6YXRpb25FbmRwb2ludDogJ2h0dHBzOi8vd3d3LmZhY2Vib29rLmNvbS92Mi41L2RpYWxvZy9vYXV0aCcsXHJcblx0XHRcdFx0cmVkaXJlY3RVcmk6IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyAnLycsXHJcblx0XHRcdFx0cmVxdWlyZWRVcmxQYXJhbXM6IFsnZGlzcGxheScsICdzY29wZSddLFxyXG5cdFx0XHRcdHNjb3BlOiBbJ2VtYWlsJ10sXHJcblx0XHRcdFx0c2NvcGVEZWxpbWl0ZXI6ICcsJyxcclxuXHRcdFx0XHRkaXNwbGF5OiAncG9wdXAnLFxyXG5cdFx0XHRcdG9hdXRoVHlwZTogJzIuMCcsXHJcblx0XHRcdFx0cG9wdXBPcHRpb25zOiB7XHJcblx0XHRcdFx0XHR3aWR0aDogNTgwLFxyXG5cdFx0XHRcdFx0aGVpZ2h0OiA0MDBcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0JGF1dGhQcm92aWRlci5nb29nbGUoe1xyXG5cdFx0XHRcdGNsaWVudElkOiAnODA2Njc3MDk3ODY1LXZhMmkza3E5Nm1tdThpMDB0OWs2cTkya3Mxczl0ZzBsLmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tJyxcclxuXHRcdFx0XHR1cmw6ICcvYXV0aC9nb29nbGUnLFxyXG5cdFx0XHRcdGF1dGhvcml6YXRpb25FbmRwb2ludDogJ2h0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoJyxcclxuXHRcdFx0XHRyZWRpcmVjdFVyaTogJ2h0dHA6Ly9sb2NhbGhvc3Q6ODA4MCcsXHJcblx0XHRcdFx0cmVxdWlyZWRVcmxQYXJhbXM6IFsnc2NvcGUnXSxcclxuXHRcdFx0XHRvcHRpb25hbFVybFBhcmFtczogWydkaXNwbGF5J10sXHJcblx0XHRcdFx0c2NvcGU6IFsncHJvZmlsZScsICdlbWFpbCddLFxyXG5cdFx0XHRcdHNjb3BlUHJlZml4OiAnb3BlbmlkJyxcclxuXHRcdFx0XHRzY29wZURlbGltaXRlcjogJyAnLFxyXG5cdFx0XHRcdGRpc3BsYXk6ICdwb3B1cCcsXHJcblx0XHRcdFx0b2F1dGhUeXBlOiAnMi4wJyxcclxuXHRcdFx0XHRwb3B1cE9wdGlvbnM6IHtcclxuXHRcdFx0XHRcdHdpZHRoOiA0NTIsXHJcblx0XHRcdFx0XHRoZWlnaHQ6IDYzM1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0XHQkYXV0aFByb3ZpZGVyLnR3aXR0ZXIoe1xyXG5cdFx0XHRcdHVybDogJy9hdXRoL3R3aXR0ZXInLFxyXG5cdFx0XHRcdGF1dGhvcml6YXRpb25FbmRwb2ludDogJ2h0dHBzOi8vYXBpLnR3aXR0ZXIuY29tL29hdXRoL2F1dGhlbnRpY2F0ZScsXHJcblx0XHRcdFx0cmVkaXJlY3RVcmk6IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4sXHJcblx0XHRcdFx0b2F1dGhUeXBlOiAnMS4wJyxcclxuXHRcdFx0XHRwb3B1cE9wdGlvbnM6IHtcclxuXHRcdFx0XHRcdHdpZHRoOiA0OTUsXHJcblx0XHRcdFx0XHRoZWlnaHQ6IDY0NVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblxyXG5cdFx0fV0pO1xyXG59KSgpO1xuKGZ1bmN0aW9uICgpIHtcclxuXHQndXNlIHN0cmljdCc7XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLmNvbnRyb2xsZXIoJ0FydGljbGVzQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRzdGF0ZScsICckc3RhdGVQYXJhbXMnLCAndG9hc3RlclNlcnZpY2UnLCAnZGF0ZUZpbHRlcicsICdmZWVkc1NlcnZpY2UnLCAnYXJ0aWNsZXNTZXJ2aWNlJywgJ2Rhc2hib2FyZFNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUsICRzdGF0ZVBhcmFtcywgdG9hc3RlclNlcnZpY2UsIGRhdGVGaWx0ZXIsIGZlZWRzU2VydmljZSwgYXJ0aWNsZXNTZXJ2aWNlLCBkYXNoYm9hcmRTZXJ2aWNlKSB7XHJcblx0XHQkc2NvcGUub2JqID0ge307XHJcblx0XHQkc2NvcGUubmV3Q2F0T2JqID0ge307XHJcblx0XHQkc2NvcGUuY2F0ZWdvcmllcyA9IGZlZWRzU2VydmljZS5hbGxGYXZzQ2F0ZWdvcmllcztcclxuXHRcdCRzY29wZS5lcnJvciA9IG51bGw7XHJcblx0XHQkc2NvcGUubW9kYWxTaG93biA9IGZhbHNlO1xyXG5cdFx0JHNjb3BlLmFydGljbGVzID0gYXJ0aWNsZXNTZXJ2aWNlLmFydGljbGVzO1xyXG5cdFx0JHNjb3BlLmlzRmF2b3VyaXRlcyA9IGFydGljbGVzU2VydmljZS5jaGVja0lmRmF2b3VyaXRlcztcclxuXHRcdCRzY29wZS5mYXZGb3JBZGQgPSBudWxsO1xyXG5cdFx0JHNjb3BlLmZhdkZvclJlbW92ZSA9IG51bGw7XHJcblx0XHQkc2NvcGUuYXJ0aWNsZUZvclNoYXJlID0gbnVsbDtcclxuXHRcdCRzY29wZS5hcnRpY2xlRm9yUmVhZCA9IG51bGw7XHJcblx0XHQkc2NvcGUuYWRkaW5nTmV3RmF2Q2F0ZWdvcnkgPSBmYWxzZTtcclxuXHJcblx0XHRpZiAoJHN0YXRlUGFyYW1zLmZlZWQgIT09IHVuZGVmaW5lZCAmJiAkc3RhdGVQYXJhbXMubGluayAhPT0gdW5kZWZpbmVkKSB7XHJcblx0XHQgICAgZGFzaGJvYXJkU2VydmljZS5pc1JlYWRpbmdBcnRpY2xlID0gdHJ1ZTtcclxuXHRcdCAgICBhcnRpY2xlc1NlcnZpY2Uuc2V0UmVhZEFydGljbGUoJHNjb3BlLCAkc3RhdGVQYXJhbXMuZmVlZCwgJHN0YXRlUGFyYW1zLmxpbmspO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSB7XHJcblx0XHQgICAgZGFzaGJvYXJkU2VydmljZS5pc1JlYWRpbmdBcnRpY2xlID0gZmFsc2U7XHJcblx0XHQgICAgaWYgKGZlZWRzU2VydmljZS5mZWVkc0RpY3Rpb25hcnkubGVuZ3RoIDwgMSAmJiAhJHNjb3BlLmlzRmF2b3VyaXRlcygpKSB7XHJcblx0XHQgICAgICAgICRzdGF0ZS5nbyhcImRhc2hib2FyZC5hZGRGZWVkXCIpO1xyXG5cdFx0ICAgIH1cclxuXHRcdH1cclxuXHJcblx0XHQkc2NvcGUuZ2V0QXJ0aWNsZXMgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHQgICAgcmV0dXJuIGFydGljbGVzU2VydmljZS5hcnRpY2xlcztcclxuXHRcdH1cclxuXHJcblx0XHQkc2NvcGUuZ2V0U29ydFBhcmFtID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHR2YXIgc29ydFBhcmFtID0gZGFzaGJvYXJkU2VydmljZS5nZXRTb3J0UGFyYW0oKTtcclxuXHRcdFx0aWYgKHNvcnRQYXJhbS50eXBlID09PSAnZmVlZCcpIHtcclxuXHRcdFx0XHRyZXR1cm4gWydmZWVkJywgJ2RhdGUnXTtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4gc29ydFBhcmFtO1xyXG5cdFx0fVxyXG5cclxuXHRcdCRzY29wZS5jaGVja0lmTmV3ID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRpZiAoJHNjb3BlLm9iai5jYXRlZ29yeS50b1VwcGVyQ2FzZSgpID09ICdjdXN0b20nLnRvVXBwZXJDYXNlKCkpIHtcclxuXHRcdFx0XHQkc2NvcGUuYWRkaW5nTmV3RmF2Q2F0ZWdvcnkgPSB0cnVlO1xyXG5cdFx0XHR9XHJcblx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdCRzY29wZS5hZGRpbmdOZXdGYXZDYXRlZ29yeSA9IGZhbHNlO1xyXG5cdFx0XHRcdCRzY29wZS5uZXdDYXRPYmouY2F0ZWdvcnkgPSBudWxsO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcbiAgICAgICAgXHJcblx0XHQkc2NvcGUuYWRkRmF2b3VyaXRlID0gZnVuY3Rpb24gKGFydGljbGUpIHtcclxuXHRcdFx0JHNjb3BlLmVycm9yID0gbnVsbDtcclxuXHRcdFx0JHNjb3BlLm1vZGFsU2hvd24gPSAhJHNjb3BlLm1vZGFsU2hvd247XHJcblx0XHRcdCRzY29wZS5mYXZGb3JBZGQgPSBhcnRpY2xlO1xyXG5cdFx0fVxyXG5cdFx0XHJcbiAgICAgICAgJHNjb3BlLmNvbmZpcm1BZGRGYXZvdXJpdGUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdCRzY29wZS5lcnJvciA9ICcnO1xyXG5cdFx0XHRpZiAoJHNjb3BlLm5ld0NhdE9iai5jYXRlZ29yeSkge1xyXG5cdFx0XHRcdCRzY29wZS5vYmouY2F0ZWdvcnkgPSAkc2NvcGUubmV3Q2F0T2JqLmNhdGVnb3J5O1xyXG5cdFx0XHR9XHJcblx0XHRcdGlmICgkc2NvcGUub2JqLmNhdGVnb3J5KSB7XHJcblx0XHRcdFx0aWYgKCEkc2NvcGUubmV3Q2F0T2JqLmNhdGVnb3J5ICYmICRzY29wZS5vYmouY2F0ZWdvcnkudG9VcHBlckNhc2UoKSA9PSAnY3VzdG9tJy50b1VwcGVyQ2FzZSgpKSB7XHJcblx0XHRcdFx0XHQkc2NvcGUuZXJyb3IgPSBcIkVudGVyIG5ldyBjYXRlZ29yeSBuYW1lXCI7XHJcblx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcbiAgICAgICAgICAgIFxyXG5cdFx0XHQkc2NvcGUuZmF2Rm9yQWRkLmNhdGVnb3J5ID0gJHNjb3BlLm9iai5jYXRlZ29yeTtcclxuXHRcdFx0YXJ0aWNsZXNTZXJ2aWNlLmFkZEZhdm91cml0ZSgkc2NvcGUuZmF2Rm9yQWRkKS50aGVuKGZ1bmN0aW9uIChyZXMpIHtcclxuXHRcdFx0XHQkc2NvcGUuYWRkaW5nTmV3Q2F0ZWdvcnkgPSBmYWxzZTtcclxuXHRcdFx0XHR0b2FzdGVyU2VydmljZS5zdWNjZXNzKFwiQXJ0aWNsZSBtYXJrZWQgYXMgZmF2b3VyaXRlXCIpO1xyXG5cdFx0XHRcdCRzdGF0ZS5yZWxvYWQoXCJkYXNoYm9hcmRcIik7XHJcblx0XHRcdH0sIGZ1bmN0aW9uIChlcnIpIHtcclxuXHRcdFx0XHRjb25zb2xlLmxvZyhlcnIpO1xyXG5cdFx0XHRcdGlmICghZXJyLmRhdGEpXHJcblx0XHRcdFx0XHQkc2NvcGUuZXJyb3IgPSBlcnIubWVzc2FnZTtcclxuXHRcdFx0XHRlbHNlICRzY29wZS5lcnJvciA9IGVyci5kYXRhLm1lc3NhZ2U7XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuICAgICAgICAkc2NvcGUuY2FuY2VsQWRkRmF2b3VyaXRlID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHQkc2NvcGUubW9kYWxTaG93biA9IGZhbHNlO1xyXG5cdFx0XHQkc2NvcGUuZmF2Rm9yQWRkID0ge307XHJcblx0XHR9XHJcblxyXG5cdFx0JHNjb3BlLnNoYXJlID0gZnVuY3Rpb24gKGFydGljbGUpIHtcclxuXHRcdFx0JHNjb3BlLmVycm9yID0gbnVsbDtcclxuXHRcdFx0Ly8kc2NvcGUubW9kYWxTaGFyZVNob3duID0gISRzY29wZS5tb2RhbFNoYXJlU2hvd247XHJcblx0XHRcdCRzY29wZS5hcnRpY2xlRm9yU2hhcmUgPSBhcnRpY2xlO1xyXG5cdFx0fVxyXG5cclxuXHRcdCRzY29wZS5jYW5jZWxTaGFyaW5nID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHQkc2NvcGUubW9kYWxTaGFyZVNob3duID0gZmFsc2U7XHJcblx0XHRcdCRzY29wZS5hcnRpY2xlRm9yU2hhcmUgPSB7fTtcclxuXHRcdH1cclxuXHJcbiAgICAgICAgJHNjb3BlLnJlbW92ZUZhdm91cml0ZSA9IGZ1bmN0aW9uIChhcnRpY2xlKSB7XHJcblx0XHRcdCRzY29wZS5mYXZGb3JSZW1vdmUgPSBhcnRpY2xlO1xyXG5cdFx0XHR0b2FzdGVyU2VydmljZS5jb25maXJtKHtcclxuXHRcdFx0XHRtZXNzYWdlOiBcIlJlbW92ZSB0aGlzIGFydGljbGU/XCIsXHJcblx0XHRcdFx0Y29uZmlybTogXCJjb25maXJtUmVtb3ZlRmF2b3VyaXRlXCJcclxuXHRcdFx0fSwgJHNjb3BlKTtcclxuXHRcdH1cclxuXHJcbiAgICAgICAgJHNjb3BlLmNvbmZpcm1SZW1vdmVGYXZvdXJpdGUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdGFydGljbGVzU2VydmljZS5yZW1vdmVGYXZvdXJpdGUoJHNjb3BlLmZhdkZvclJlbW92ZSkudGhlbihmdW5jdGlvbiAocmVzKSB7XHJcblx0XHRcdFx0dG9hc3RlclNlcnZpY2UuaW5mbyhcIkFydGljbGUgcmVtb3ZlZCBmcm9tIGZhdm91cml0ZXNcIik7XHJcblx0XHRcdFx0JHN0YXRlLnJlbG9hZChcImRhc2hib2FyZFwiKTtcclxuXHRcdFx0fSwgZnVuY3Rpb24gKGVycikge1xyXG5cdFx0XHRcdGNvbnNvbGUubG9nKGVycik7XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cclxuICAgICAgICAkc2NvcGUuZ2V0QXJ0aWNsZURhdGUgPSBmdW5jdGlvbiAoZGF0ZSkge1xyXG5cdFx0ICAgIGlmICghZGF0ZSkge1xyXG5cdFx0ICAgICAgICByZXR1cm47XHJcblx0XHQgICAgfTtcclxuXHRcdFx0cmV0dXJuIGRhdGVGaWx0ZXIobmV3IERhdGUoZGF0ZSksIFwiZGQvTU0veXkgSEg6bW1cIik7XHJcblx0XHR9XHJcblxyXG5cdFx0JHNjb3BlLnJlYWRBcnRpY2xlID0gZnVuY3Rpb24gKGFydGljbGUpIHtcclxuXHRcdCAgICBkYXNoYm9hcmRTZXJ2aWNlLmlzUmVhZGluZ0FydGljbGUgPSB0cnVlO1xyXG5cdFx0XHQkc3RhdGUuZ28oXCJkYXNoYm9hcmQuYXJ0aWNsZVwiLCB7ZmVlZDogYXJ0aWNsZS5mZWVkLCBsaW5rOiBhcnRpY2xlLmxpbmt9KTtcclxuXHRcdH1cclxuXHR9XSk7XHJcbn0pKCk7XG4oZnVuY3Rpb24oKSB7XHJcblx0XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLmNvbmZpZyhbJyR2YWxpZGF0b3JQcm92aWRlcicsIGZ1bmN0aW9uKCR2YWxpZGF0b3JQcm92aWRlcikge1xyXG5cdFx0JHZhbGlkYXRvclByb3ZpZGVyLmFkZE1ldGhvZChcInBhdHRlcm5cIiwgZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHtcclxuXHRcdFx0cmV0dXJuIHRoaXMub3B0aW9uYWwoZWxlbWVudCkgfHwgL14oPz0uKlthLXpdKSg/PS4qW0EtWl0pKD89LipcXGQpKD89LiooX3xbXlxcd10pKS57NiwyMH0vLnRlc3QodmFsdWUpO1xyXG5cdFx0fSwgXCJQYXNzd29yZCBtdXN0IGNvbnRhaW4oYS16LEEtWiwwLTksIUAjKVwiKTtcclxuXHR9XSkuXHJcblx0Y29udHJvbGxlcignQXV0aENvbnRyb2xsZXInLCBbJyRzY29wZScsICckc3RhdGUnLCAnYXV0aFNlcnZpY2UnLCAncHJvZmlsZVNlcnZpY2UnLCAnJHdpbmRvdycsICdkYXNoYm9hcmRTZXJ2aWNlJywgJyRhdXRoJywgJ3RyYW5zZmVyJywgJ2p3dEhlbHBlcicsICd0b2FzdGVyU2VydmljZScsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSwgYXV0aFNlcnZpY2UsIHByb2ZpbGVTZXJ2aWNlLCAkd2luZG93LCAgZGFzaGJvYXJkU2VydmljZSwgJGF1dGgsIHRyYW5zZmVyLCBqd3RIZWxwZXIsIHRvYXN0ZXJTZXJ2aWNlKSB7XHJcblx0XHQkc2NvcGUudXNlciA9IHt9O1xyXG5cdFx0JHNjb3BlLnRlc3QgPSA1O1xyXG5cdFx0JHNjb3BlLnNlc3Npb247XHJcblxyXG5cdFx0dmFyIEVSUk9SUyA9IHtcclxuXHRcdFx0ZmllbGRfcmVxdWlyZWQ6ICdUaGlzIGZpZWxkIGlzIHJlcXVpcmVkJyxcclxuXHRcdFx0ZW1haWxfZXhhbXBsZTogJ1BsZWFzZSwgdXNlIGV4YW1wbGU6IGphY2tzcGFycm93QGdtYWlsLmNvbScsXHJcblx0XHRcdG1pbl82c3ltYmw6ICdQbGVhc2UsIGVudGVyIGF0IGxlYXN0IDYgY2hhcmFjdGVycycsXHJcblx0XHRcdG1pbl85c3ltYmw6ICdQbGVhc2UsIGVudGVyIGF0IGxlYXN0IDkgY2hhcmFjdGVycycsXHJcblx0XHRcdG1heF8yMHN5bWJsOiAnUGxlYXNlLCBlbnRlciBubyBtb3JlIHRoZW4gNDAgY2hhcmFjdGVycycsXHJcblx0XHRcdHJlZ19leHA6ICdQYXNzd29yZCBtdXN0IGNvbnRhaW4oYS16LEEtWiwwLTksIUAjKSdcclxuXHRcdH1cclxuXHJcblx0XHQkc2NvcGUucmVnaXN0ZXIgPSBmdW5jdGlvbiAoZm9ybSkge1xyXG5cdFx0XHRpZiAoZm9ybS52YWxpZGF0ZSgpKSB7XHJcblx0XHRcdFx0YXV0aFNlcnZpY2UucmVnaXN0ZXIoJHNjb3BlLnVzZXIpLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG5cdFx0XHRcdFx0JHNjb3BlLmVycm9yID0gZXJyb3I7XHJcblx0XHRcdFx0fSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcclxuXHRcdFx0XHRcdHRvYXN0ZXJTZXJ2aWNlLnN1Y2Nlc3MoJ1lvdSBoYXZlIHN1Y2Nlc3NmdWxseSByZWdpc3RlcmVkJyk7XHJcblx0XHRcdFx0XHQkc3RhdGUuZ28oJ2Rhc2hib2FyZC4nICsgZGFzaGJvYXJkU2VydmljZS5nZXRWaWV3TW9kZSgpLCB7XHJcblx0XHRcdFx0XHRcdGlkOiBhdXRoU2VydmljZS51c2VySUQoKVxyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH1cclxuXHRcdH07XHJcblxyXG5cdFx0JHNjb3BlLmxvZ0luID0gZnVuY3Rpb24gKGZvcm0pIHtcclxuXHRcdFx0aWYgKGZvcm0udmFsaWRhdGUoKSkge1xyXG5cdFx0XHRcdGNvbnNvbGUubG9nKCRzY29wZS51c2VyKTtcclxuXHRcdFx0XHRhdXRoU2VydmljZS5sb2dJbigkc2NvcGUudXNlciwgJHNjb3BlLnNlc3Npb24pLmVycm9yKGZ1bmN0aW9uIChlcnJvcikge1xyXG5cdFx0XHRcdFx0JHNjb3BlLmVycm9yID0gZXJyb3I7XHJcblx0XHRcdFx0fSkudGhlbihmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRpZiAoISRzY29wZS5zZXNzaW9uKSB7XHJcblx0XHRcdFx0XHRcdCRzY29wZS5vbkV4aXQgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRcdFx0YXV0aC5sb2dPdXQoKTtcclxuXHRcdFx0XHRcdFx0fTtcclxuXHRcdFx0XHRcdFx0JHN0YXRlLmdvKCdkYXNoYm9hcmQuJyArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSwge1xyXG5cdFx0XHRcdFx0XHRcdGlkOiBhdXRoU2VydmljZS51c2VySUQoKVxyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdFx0dG9hc3RlclNlcnZpY2Uuc3VjY2VzcygnWW91IGhhdmUgc3VjY2Vzc2Z1bGx5IGxvZ2luJyk7XHJcblx0XHRcdFx0XHRcdCR3aW5kb3cub25iZWZvcmV1bmxvYWQgPSAkc2NvcGUub25FeGl0O1xyXG5cdFx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdFx0JHN0YXRlLmdvKCdkYXNoYm9hcmQuJyArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSwge1xyXG5cdFx0XHRcdFx0XHRcdGlkOiBhdXRoU2VydmljZS51c2VySUQoKVxyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdFx0dG9hc3RlclNlcnZpY2Uuc3VjY2VzcygnWW91IGhhdmUgc3VjY2Vzc2Z1bGx5IGxvZ2luJyk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH1cclxuXHRcdH07XHJcblxyXG5cdFx0JHNjb3BlLmF1dGhlbnRpY2F0ZSA9IGZ1bmN0aW9uIChwcm92aWRlcikge1xyXG5cdFx0XHQkYXV0aC5hdXRoZW50aWNhdGUocHJvdmlkZXIpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblx0XHRcdFx0YXV0aFNlcnZpY2Uuc2F2ZVRva2VuKHJlc3BvbnNlLmRhdGEudG9rZW4pO1xyXG5cdFx0XHRcdHRvYXN0ZXJTZXJ2aWNlLnN1Y2Nlc3MoJ1lvdSBoYXZlIHN1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGVkJyk7XHJcblx0XHRcdFx0JHN0YXRlLmdvKCdkYXNoYm9hcmQuJyArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSwge1xyXG5cdFx0XHRcdFx0aWQ6IGF1dGhTZXJ2aWNlLnVzZXJJRCgpXHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH0pXHJcblx0XHR9XHJcblxyXG5cdFx0JHNjb3BlLnZhbGlkYXRpb25Mb2dpbk9wdGlvbnMgPSB7XHJcblx0XHRcdHJ1bGVzOiB7XHJcblx0XHRcdFx0bWFpbDoge1xyXG5cdFx0XHRcdFx0cmVxdWlyZWQ6IHRydWUsXHJcblx0XHRcdFx0XHRlbWFpbDogdHJ1ZVxyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0cHdkOiB7XHJcblx0XHRcdFx0XHRyZXF1aXJlZDogdHJ1ZVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHRcdFx0bWVzc2FnZXM6IHtcclxuXHRcdFx0XHRtYWlsOiB7XHJcblx0XHRcdFx0XHRyZXF1aXJlZDogRVJST1JTLmZpZWxkX3JlcXVpcmVkLFxyXG5cdFx0XHRcdFx0ZW1haWw6IEVSUk9SUy5lbWFpbF9leGFtcGxlXHJcblx0XHRcdFx0fSxcclxuXHJcblx0XHRcdFx0cHdkOiB7XHJcblx0XHRcdFx0XHRyZXF1aXJlZDogRVJST1JTLmZpZWxkX3JlcXVpcmVkXHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHR9O1xyXG5cclxuXHRcdCRzY29wZS52YWxpZGF0aW9uUmVnaXN0ck9wdGlvbnMgPSB7XHJcblx0XHRcdHJ1bGVzOiB7XHJcblx0XHRcdFx0bWFpbDoge1xyXG5cdFx0XHRcdFx0cmVxdWlyZWQ6IHRydWUsXHJcblx0XHRcdFx0XHRlbWFpbDogdHJ1ZSxcclxuXHRcdFx0XHRcdG1pbmxlbmd0aDogOSxcclxuXHRcdFx0XHRcdG1heGxlbmd0aDogNDAsXHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRwd2Q6IHtcclxuXHRcdFx0XHRcdHJlcXVpcmVkOiB0cnVlLFxyXG5cdFx0XHRcdFx0bWlubGVuZ3RoOiA2LFxyXG5cdFx0XHRcdFx0bWF4bGVuZ3RoOiAyMCxcclxuXHRcdFx0XHRcdHBhdHRlcm46IHRydWVcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdHJlcHB3ZDoge1xyXG5cdFx0XHRcdFx0cmVxdWlyZWQ6IHRydWVcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0sXHJcblx0XHRcdG1lc3NhZ2VzOiB7XHJcblx0XHRcdFx0bWFpbDoge1xyXG5cdFx0XHRcdFx0cmVxdWlyZWQ6IEVSUk9SUy5maWVsZF9yZXF1aXJlZCxcclxuXHRcdFx0XHRcdGVtYWlsOiBFUlJPUlMuZW1haWxfZXhhbXBsZSxcclxuXHRcdFx0XHRcdG1pbmxlbmd0aDogRVJST1JTLm1pbl85c3ltYmwsXHJcblx0XHRcdFx0XHRtYXhsZW5ndGg6IEVSUk9SUy5tYXhfMjBzeW1ibFxyXG5cdFx0XHRcdH0sXHJcblxyXG5cdFx0XHRcdHB3ZDoge1xyXG5cdFx0XHRcdFx0cmVxdWlyZWQ6IEVSUk9SUy5maWVsZF9yZXF1aXJlZCxcclxuXHRcdFx0XHRcdG1pbmxlbmd0aDogRVJST1JTLm1pbl82c3ltYmwsXHJcblx0XHRcdFx0XHRtYXhsZW5ndGg6IEVSUk9SUy5tYXhfMjBzeW1ibCxcclxuXHRcdFx0XHRcdHBhdHRlcm46IEVSUk9SUy5yZWdfZXhwXHJcblx0XHRcdFx0fSxcclxuXHJcblx0XHRcdFx0cmVwcHdkOiB7XHJcblx0XHRcdFx0XHRyZXF1aXJlZDogRVJST1JTLmZpZWxkX3JlcXVpcmVkXHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fV0pO1xyXG59KSgpO1xuKGZ1bmN0aW9uICgpIHtcclxuXHQndXNlIHN0cmljdCc7XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLmNvbnRyb2xsZXIoJ0Rhc2hib2FyZENvbnRyb2xsZXInLCBbJyRzY29wZScsICckc3RhdGUnLCAnZGFzaGJvYXJkU2VydmljZScsICdmZWVkc1NlcnZpY2UnLCAndG9hc3RlclNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUsIGRhc2hib2FyZFNlcnZpY2UsIGZlZWRzU2VydmljZSwgdG9hc3RlclNlcnZpY2UpIHtcclxuXHRcdCRzY29wZS5sb2FkaW5nSWNvbiA9IGRhc2hib2FyZFNlcnZpY2UuaXNMb2FkaW5nO1xyXG5cdFx0JHNjb3BlLnNpZGViYXIgPSBkYXNoYm9hcmRTZXJ2aWNlLmNoZWNrU2lkZWJhcjtcclxuXHRcdCRzY29wZS5oZWFkVGl0bGUgPSBkYXNoYm9hcmRTZXJ2aWNlLmdldFRpdGxlO1xyXG5cdFx0JHNjb3BlLmZlZWQgPSBkYXNoYm9hcmRTZXJ2aWNlLmdldEZlZWRJZDtcclxuXHRcdCRzY29wZS5hbGVydE1zZyA9IGRhc2hib2FyZFNlcnZpY2UuYWxlcnRNc2c7XHJcblx0XHQkc2NvcGUuc3VjY2Vzc01zZyA9IGRhc2hib2FyZFNlcnZpY2Uuc3VjY2Vzc01zZztcclxuXHRcdCRzY29wZS5jaGVja0lmUmVhZGluZyA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdCAgICByZXR1cm4gZGFzaGJvYXJkU2VydmljZS5pc1JlYWRpbmdBcnRpY2xlO1xyXG5cdFx0fTtcclxuXHJcblx0XHQkc2NvcGUudG9nZ2xlU2lkZWJhciA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0ZGFzaGJvYXJkU2VydmljZS5zaWRlYmFyID0gIWRhc2hib2FyZFNlcnZpY2Uuc2lkZWJhcjtcclxuXHRcdH1cclxuXHRcdCRzY29wZS5oaWRlU2lkZWJhciA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0ZGFzaGJvYXJkU2VydmljZS5zaWRlYmFyID0gZmFsc2U7XHJcblx0XHR9XHJcblx0XHQkc2NvcGUuc2hvd1NpZGViYXIgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdGRhc2hib2FyZFNlcnZpY2Uuc2lkZWJhciA9IHRydWU7XHJcblx0XHR9XHJcblxyXG5cdFx0JHNjb3BlLmhpZGVWaWV3QnRucyA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0aWYgKCRzY29wZS5oZWFkVGl0bGUoKSA9PT0gXCJBZGQgRmVlZFwiIHx8IGZlZWRzU2VydmljZS5mZWVkc0RpY3Rpb25hcnkubGVuZ3RoID09IDApIHtcclxuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHRcdCRzY29wZS5jaGVja0lmVG9nZ2xlZCA9IGZ1bmN0aW9uIChtb2RlKSB7XHJcblx0XHRcdHJldHVybiBkYXNoYm9hcmRTZXJ2aWNlLmdldFZpZXdNb2RlKCkgPT09IG1vZGU7XHJcblx0XHR9XHJcbiAgICAgICAgXHJcblx0XHQkc2NvcGUuY2hlY2tTb3J0VHlwZSA9IGZ1bmN0aW9uICh0eXBlLCBvcmRlcikge1xyXG5cdFx0XHR2YXIgc29ydFR5cGUgPSBkYXNoYm9hcmRTZXJ2aWNlLmdldFNvcnRQYXJhbSgpO1xyXG5cdFx0XHRpZiAodHlwZSA9PSBzb3J0VHlwZS50eXBlICYmIG9yZGVyID09IHNvcnRUeXBlLm9yZGVyKSB7XHJcblx0XHRcdFx0cmV0dXJuIHRydWU7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSByZXR1cm4gZmFsc2U7XHJcblx0XHR9XHJcbiAgICAgICAgXHJcblx0XHQkc2NvcGUub25WaWV3Q2hhbmdlID0gZnVuY3Rpb24gKHZpZXcpIHtcclxuXHRcdFx0c3dpdGNoICh2aWV3KSB7XHJcblx0XHRcdFx0Y2FzZSAndmlldy1tb2RlMSc6XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFZpZXdNb2RlKDApO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdFx0Y2FzZSAndmlldy1tb2RlMic6XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFZpZXdNb2RlKDEpO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdFx0Y2FzZSAndmlldy1tb2RlMyc6XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFZpZXdNb2RlKDIpO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdH1cclxuXHRcdFx0JHN0YXRlLmdvKCdkYXNoYm9hcmQuJyArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSk7XHJcblx0XHR9XHJcblx0XHR2YXIgdGltZXI7XHJcblx0XHQkc2NvcGUub25GZWVkRGVsZXRlID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHR0b2FzdGVyU2VydmljZS5jb25maXJtKHtcclxuXHRcdFx0XHRtZXNzYWdlOiBcIlJlbW92ZSB0aGlzIGZlZWQ/XCIsXHJcblx0XHRcdFx0Y29uZmlybTogXCJjb25maXJtRmVlZERlbGV0ZVwiXHJcblx0XHRcdH0sICRzY29wZSk7XHJcblx0XHR9XHJcblx0XHQkc2NvcGUuY29uZmlybUZlZWREZWxldGUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdGZlZWRzU2VydmljZS5yZW1vdmVGZWVkKGRhc2hib2FyZFNlcnZpY2UuZ2V0RmVlZElkKCkpXHJcblx0XHRcdFx0LnRoZW4oZnVuY3Rpb24gKHJlcykge1xyXG5cdFx0XHRcdFx0dG9hc3RlclNlcnZpY2UuaW5mbyhcIkZlZWQgaGFzIGJlZW4gZGVsZXRlZFwiKTtcclxuXHRcdFx0XHRcdCRzdGF0ZS5yZWxvYWQoXCJkYXNoYm9hcmRcIik7XHJcblx0XHRcdFx0fSwgZnVuY3Rpb24gKGVycikge1xyXG5cdFx0XHRcdFx0Y29uc29sZS5sb2coZXJyKTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdH1cclxuXHRcdCRzY29wZS5jdXJyZW50U29ydFRpdGxlID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHR2YXIgc29ydFBhcmFtID0gZGFzaGJvYXJkU2VydmljZS5nZXRTb3J0UGFyYW0oKTtcclxuXHRcdFx0c3dpdGNoIChzb3J0UGFyYW0udHlwZSkge1xyXG5cdFx0XHQgICAgY2FzZSAnZGF0ZSc6IHtcclxuXHRcdFx0ICAgICAgICBpZiAoc29ydFBhcmFtLm9yZGVyID09IDEpe1xyXG5cdFx0XHQgICAgICAgICAgICByZXR1cm4gXCJOZXdlc3RcIjtcclxuXHRcdFx0ICAgICAgICB9XHJcblx0XHRcdCAgICAgICAgZWxzZSB7XHJcblx0XHRcdCAgICAgICAgICAgIHJldHVybiBcIk9sZGVzdFwiO1xyXG5cdFx0XHQgICAgICAgIH1cclxuXHRcdFx0ICAgIH1cclxuXHRcdFx0ICAgICAgICBicmVhaztcclxuXHRcdFx0ICAgIGNhc2UgJ2ZlZWQnOiB7XHJcblx0XHRcdCAgICAgICAgcmV0dXJuIFwiQnkgRmVlZFwiOyAgICAgICAgICAgIFxyXG5cdFx0XHQgICAgfVxyXG5cdFx0XHQgICAgICAgIGJyZWFrO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHR2YXIgc29ydFR5cGVFbGVtZW50O1xyXG5cdFx0JHNjb3BlLnNldFNvcnRQYXJhbSA9IGZ1bmN0aW9uIChlLCB0eXBlLCBvcmRlcikge1xyXG5cdFx0XHRpZiAoc29ydFR5cGVFbGVtZW50KSB7XHJcblx0XHRcdFx0c29ydFR5cGVFbGVtZW50LnJlbW92ZUNsYXNzKCdzZWxlY3RlZCcpO1xyXG5cdFx0XHR9XHJcblx0XHRcdHNvcnRUeXBlRWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlLmN1cnJlbnRUYXJnZXQpO1xyXG5cdFx0XHRzb3J0VHlwZUVsZW1lbnQuYWRkQ2xhc3MoJ3NlbGVjdGVkJyk7XHJcblx0XHRcdGRhc2hib2FyZFNlcnZpY2Uuc2V0U29ydFBhcmFtKHR5cGUsIG9yZGVyKTtcclxuXHRcdH1cclxuXHR9XSk7XHJcbn0pKCk7XG4oZnVuY3Rpb24gKCkge1xyXG5cdCd1c2Ugc3RyaWN0JztcclxuXHRhbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJykuY29udHJvbGxlcignRmVlZHNDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJHN0YXRlJywgJyRodHRwJywgJ3RvYXN0ZXJTZXJ2aWNlJywgJ2ZlZWRzU2VydmljZScsICdkYXNoYm9hcmRTZXJ2aWNlJywgJ2FydGljbGVzU2VydmljZScsICdhdXRoU2VydmljZScsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSwgJGh0dHAsIHRvYXN0ZXJTZXJ2aWNlLCBmZWVkc1NlcnZpY2UsIGRhc2hib2FyZFNlcnZpY2UsIGFydGljbGVzU2VydmljZSwgYXV0aFNlcnZpY2UpIHtcclxuXHRcdCRzY29wZS5vYmogPSB7fTtcclxuXHRcdCRzY29wZS5mZWVkcyA9IGZlZWRzU2VydmljZS5mZWVkc0RpY3Rpb25hcnk7XHJcblx0XHQkc2NvcGUuY2F0ZWdvcmllcyA9IGZlZWRzU2VydmljZS5hbGxDYXRlZ29yaWVzO1xyXG5cdFx0JHNjb3BlLmFkZGluZ05ld0NhdGVnb3J5ID0gZmFsc2U7XHJcblx0XHQkc2NvcGUubmV3Q2F0ZWdvcnkgPSBudWxsO1xyXG5cdFx0JHNjb3BlLmNoZWNrSWZOZXcgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdGlmICgkc2NvcGUub2JqLmNhdGVnb3J5LnRvVXBwZXJDYXNlKCkgPT0gJ2N1c3RvbScudG9VcHBlckNhc2UoKSkge1xyXG5cdFx0XHRcdCRzY29wZS5hZGRpbmdOZXdDYXRlZ29yeSA9IHRydWU7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0JHNjb3BlLmFkZGluZ05ld0NhdGVnb3J5ID0gZmFsc2U7XHJcblx0XHRcdFx0JHNjb3BlLm5ld0NhdGVnb3J5ID0gbnVsbDtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdFx0JHNjb3BlLmFkZEZlZWQgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdCRzY29wZS5lcnJvciA9ICcnO1xyXG5cdFx0XHRpZiAoJHNjb3BlLm5ld0NhdGVnb3J5KSB7XHJcblx0XHRcdFx0JHNjb3BlLm9iai5jYXRlZ29yeSA9ICRzY29wZS5uZXdDYXRlZ29yeTtcclxuXHRcdFx0fVxyXG5cdFx0XHRpZiAoISRzY29wZS5vYmouY2F0ZWdvcnkpIHtcclxuXHRcdFx0ICAgICRzY29wZS5lcnJvciA9IFwiQ2hvb3NlIGNhdGVnb3J5XCI7XHJcblx0XHRcdCAgICByZXR1cm47XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKCEkc2NvcGUubmV3Q2F0ZWdvcnkgJiYgJHNjb3BlLm9iai5jYXRlZ29yeS50b1VwcGVyQ2FzZSgpID09ICdjdXN0b20nLnRvVXBwZXJDYXNlKCkpIHtcclxuXHRcdFx0XHQkc2NvcGUuZXJyb3IgPSBcIkVudGVyIG5ldyBjYXRlZ29yeSBuYW1lXCI7XHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHR9XHJcblx0XHRcdGZlZWRzU2VydmljZS5hZGRGZWVkKCRzY29wZS5vYmopXHJcblx0XHRcdFx0LnRoZW4oZnVuY3Rpb24gKHJlcykge1xyXG5cdFx0XHRcdFx0JHNjb3BlLmFkZGluZ05ld0NhdGVnb3J5ID0gZmFsc2U7XHJcblx0XHRcdFx0XHR0b2FzdGVyU2VydmljZS5zdWNjZXNzKFwiRmVlZCBzdWNjZXNzZnVsbHkgYWRkZWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgJHN0YXRlLmdvKCdkYXNoYm9hcmQuJyArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSwge30sIHsgcmVsb2FkOiB0cnVlIH0pO1xyXG5cdFx0XHRcdH0sIGZ1bmN0aW9uIChlcnIpIHtcclxuXHRcdFx0XHRcdGlmICghZXJyLmRhdGEpXHJcblx0XHRcdFx0XHRcdCRzY29wZS5lcnJvciA9IGVyci5tZXNzYWdlO1xyXG5cdFx0XHRcdFx0ZWxzZSAkc2NvcGUuZXJyb3IgPSBlcnIuZGF0YS5tZXNzYWdlO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cdH1dKTtcclxufSkoKTtcbihmdW5jdGlvbiAoKSB7XHJcblx0J3VzZSBzdHJpY3QnO1xyXG5cdGFuZ3VsYXIubW9kdWxlKCdyc3NyZWFkZXInKS5jb250cm9sbGVyKCdIb21lQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRzdGF0ZScsICdhdXRoU2VydmljZScsICdkYXNoYm9hcmRTZXJ2aWNlJywgJ2ZlZWRzU2VydmljZScsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSwgYXV0aFNlcnZpY2UsIGRhc2hib2FyZFNlcnZpY2UsIGZlZWRzU2VydmljZSkge1xyXG5cdFx0JHNjb3BlLmlzTG9nZ2VkSW4gPSBhdXRoU2VydmljZS5pc0xvZ2dlZEluO1xyXG5cdFx0JHNjb3BlLmN1cnJlbnRVc2VyID0gYXV0aFNlcnZpY2UuY3VycmVudFVzZXI7XHJcblx0XHQkc2NvcGUub25GZWVkcyA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0aWYgKGF1dGhTZXJ2aWNlLmlzTG9nZ2VkSW4oKSkge1xyXG5cdFx0XHRcdCRzdGF0ZS5nbygnZGFzaGJvYXJkLicgKyBkYXNoYm9hcmRTZXJ2aWNlLmdldFZpZXdNb2RlKCksIHtcclxuXHRcdFx0XHRcdGlkOiBhdXRoU2VydmljZS51c2VySUQoKVxyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdCRzdGF0ZS5nbygnaG9tZScpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHQkc2NvcGUub25GZWVkcygpO1xyXG5cdFx0JHNjb3BlLm9uUmVnaXN0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdCRzdGF0ZS5nbygncmVnaXN0ZXInKTtcclxuXHRcdH1cclxuXHRcdCRzY29wZS5vbkxvZ2luID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHQkc3RhdGUuZ28oJ2xvZ2luJyk7XHJcblx0XHR9XHJcblx0fV0pO1xyXG59KSgpO1xuKGZ1bmN0aW9uICgpIHtcclxuXHRhbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJykuY29udHJvbGxlcignSW5kZXhDb250cm9sbGVyJywgWyckc2NvcGUnLCAnYXV0aFNlcnZpY2UnLCAnJHdpbmRvdycsICd0aGVtZVNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCBhdXRoU2VydmljZSwgJHdpbmRvdywgdGhlbWVTZXJ2aWNlKSB7XHJcblx0XHQkc2NvcGUubGF5b3V0ID0gdGhlbWVTZXJ2aWNlLmdldFRoZW1lO1xyXG5cdFx0JHNjb3BlLnRleHQgPSBcInNvbWUgdGV4dFwiO1xyXG5cdH1dKTtcclxufSkoKTtcbihmdW5jdGlvbiAoKSB7XHJcblx0J3VzZSBzdHJpY3QnO1xyXG5cdGFuZ3VsYXIubW9kdWxlKCdyc3NyZWFkZXInKS5jb250cm9sbGVyKCdOYXZiYXJDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJHN0YXRlJywncHJvZmlsZVNlcnZpY2UnLCAnYXV0aFNlcnZpY2UnLCAnZGFzaGJvYXJkU2VydmljZScsICd0cmFuc2ZlcicsICdhY2NvdW50SW5mbycsICckYXV0aCcsXHJcblx0XHRmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUscHJvZmlsZVNlcnZpY2UsIGF1dGhTZXJ2aWNlLCBkYXNoYm9hcmRTZXJ2aWNlLCB0cmFuc2ZlciwgYWNjb3VudEluZm8sICRhdXRoKSB7XHJcblx0XHRcdC8vICRzY29wZS5wcm9maWxlID0gcHJvZmlsZVNlcnZpY2UucHJvZmlsZTtcclxuXHRcdFx0JHNjb3BlLmlzTG9nZ2VkSW4gPSBhdXRoU2VydmljZS5pc0xvZ2dlZEluO1xyXG5cdFx0XHQkc2NvcGUuaXNEYXNoYm9hcmQgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0cmV0dXJuIC9kYXNoYm9hcmQvLnRlc3QoJHN0YXRlLmN1cnJlbnQubmFtZSk7XHJcblx0XHRcdH1cclxuXHRcdFx0JHNjb3BlLmN1cnJlbnRVc2VyID0gcHJvZmlsZVNlcnZpY2UucmVmcmVzaFByb2ZpbGVEYXRhO1xyXG5cdFx0XHQkc2NvcGUudG9nZ2xlU2lkZWJhciA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0ICAgICRzY29wZS5oaWRlTW9iaWxlTmF2YmFyKCk7XHJcblx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5zaWRlYmFyID0gIWRhc2hib2FyZFNlcnZpY2Uuc2lkZWJhcjtcclxuXHRcdFx0XHQkc2NvcGUuZ2V0UHJvZmlsZSgpO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQkc2NvcGUuaGlkZVNpZGViYXIgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5zaWRlYmFyID0gZmFsc2U7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdCRzY29wZS5oaWRlTW9iaWxlTmF2YmFyID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHQgICAgYW5ndWxhci5lbGVtZW50KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjYnMtZXhhbXBsZS1uYXZiYXItY29sbGFwc2UtMVwiKSkucmVtb3ZlQ2xhc3MoJ2luJyk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdCRzY29wZS5sb2dPdXQgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdCAgICAkc2NvcGUuaGlkZU1vYmlsZU5hdmJhcigpO1xyXG5cdFx0XHRcdGF1dGhTZXJ2aWNlLmxvZ091dCgpO1xyXG5cdFx0XHRcdCRzdGF0ZS5nbyhcImhvbWVcIik7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdCRzY29wZS5vbkVtYmxlbSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0ICAgICRzY29wZS5oaWRlTW9iaWxlTmF2YmFyKCk7XHJcblx0XHRcdFx0aWYgKGF1dGhTZXJ2aWNlLmlzTG9nZ2VkSW4oKSkge1xyXG5cdFx0XHRcdFx0aWYgKCRzY29wZS5pc0Rhc2hib2FyZCgpKSB7XHJcblx0XHRcdFx0XHRcdCRzdGF0ZS5yZWxvYWQoJ2Rhc2hib2FyZCcpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0ZWxzZSAkc3RhdGUuZ28oXCJkYXNoYm9hcmQuXCIgKyBkYXNoYm9hcmRTZXJ2aWNlLmdldFZpZXdNb2RlKCkpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHQkc3RhdGUuZ28oXCJob21lXCIpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cdFx0XHQkc2NvcGUuZ29Ub1Byb2dpbGUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdCAgICAkc3RhdGUuZ28oXCJwcm9maWxlXCIpO1xyXG5cdFx0XHQgICAgJHNjb3BlLmhpZGVNb2JpbGVOYXZiYXIoKTtcclxuXHRcdFx0fVxyXG5cdFx0XHQkc2NvcGUuZ2V0UHJvZmlsZSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRhY2NvdW50SW5mby5nZXRQcm9maWxlKCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHRcdFx0XHRcdGlmICgkYXV0aC5pc0F1dGhlbnRpY2F0ZWQoKSkge1xyXG5cdFx0XHRcdFx0XHR2YXIgbGVuZ2h0ID0gcmVzcG9uc2UuZGF0YS51c2VyLmxlbmd0aDtcclxuXHRcdFx0XHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBsZW5naHQ7IGkrKykge1xyXG5cdFx0XHRcdFx0XHRcdGlmIChyZXNwb25zZS5kYXRhLnVzZXJbaV0uZW1haWwgPT09ICRhdXRoLmdldFBheWxvYWQoKS5lbWFpbCkge1xyXG5cdFx0XHRcdFx0XHRcdFx0JHNjb3BlLnByb2ZpbGUgPSByZXNwb25zZS5kYXRhLnVzZXJbaV07XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSlcclxuXHRcdFx0fTtcclxuXHRcdFx0JHNjb3BlLmdldFByb2ZpbGUoKTtcclxuXHRcdFx0JHNjb3BlLmdldEltYWdlID0gZnVuY3Rpb24oKXtcclxuXHRcdFx0XHRyZXR1cm4gcHJvZmlsZVNlcnZpY2UuZ2V0SW1hZ2UoKTtcclxuXHRcdFx0fTtcclxuXHR9XSk7XHJcbn0pKCk7XG4oZnVuY3Rpb24gKCkge1xyXG5cdCd1c2Ugc3RyaWN0JztcclxuXHRhbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJykuY29uZmlnKFsnJHZhbGlkYXRvclByb3ZpZGVyJywgZnVuY3Rpb24gKCR2YWxpZGF0b3JQcm92aWRlcikge1xyXG5cdFx0JHZhbGlkYXRvclByb3ZpZGVyLmFkZE1ldGhvZChcInBhdHRlcm5cIiwgZnVuY3Rpb24gKHZhbHVlLCBlbGVtZW50KSB7XHJcblx0XHRcdHJldHVybiB0aGlzLm9wdGlvbmFsKGVsZW1lbnQpIHx8IC9eKD89LipbYS16XSkoPz0uKltBLVpdKSg/PS4qXFxkKSg/PS4qKF98W15cXHddKSkuezYsMjB9Ly50ZXN0KHZhbHVlKTtcclxuXHRcdH0sIFwiUGxlYXNlIHNwZWNpZnkgdGhlIGNvcnJlY3QgZG9tYWluIGZvciB5b3VyIGRvY3VtZW50c1wiKTtcclxuXHR9XSkuY29udHJvbGxlcignUHJvZmlsZUNvbnRyb2xsZXInLCBbJ1VwbG9hZCcsICckaHR0cCcsICckc3RhdGUnLCAncHJvZmlsZVNlcnZpY2UnLCAnJHNjb3BlJyxcclxuXHRcdCdhdXRoU2VydmljZScsICckd2luZG93JywgJ3RoZW1lU2VydmljZScsICdkYXNoYm9hcmRTZXJ2aWNlJywgJyRhdXRoJywgJ2FjY291bnRJbmZvJywgJ3RvYXN0ZXJTZXJ2aWNlJyxcclxuXHRcdGZ1bmN0aW9uIChVcGxvYWQsICRodHRwLCAkc3RhdGUsIHByb2ZpbGVTZXJ2aWNlLCAkc2NvcGUsXHJcblx0XHRcdGF1dGhTZXJ2aWNlLCAkd2luZG93LCB0aGVtZVNlcnZpY2UsIGRhc2hib2FyZFNlcnZpY2UsICRhdXRoLCBhY2NvdW50SW5mbywgdG9hc3RlclNlcnZpY2UpIHtcclxuXHRcdFx0JHNjb3BlLmN1cnJlbnRVc2VyID0gcHJvZmlsZVNlcnZpY2UucmVmcmVzaFByb2ZpbGVEYXRhO1xyXG5cdFx0XHRcclxuXHRcdFx0JHNjb3BlLmxpbmsgPSBmdW5jdGlvbiAocHJvdmlkZXIpIHtcclxuXHRcdFx0XHQkYXV0aC5saW5rKHByb3ZpZGVyKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHRvYXN0ZXJTZXJ2aWNlLmluZm8oJ1lvdSBoYXZlIHN1Y2Nlc3NmdWxseSBsaW5rZWQgYSAnICsgcHJvdmlkZXIgKyAnIGFjY291bnQnKTtcclxuXHRcdFx0XHRcdHByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fTtcclxuXHJcblx0XHRcdCRzY29wZS51bmxpbmsgPSBmdW5jdGlvbiAocHJvdmlkZXIpIHtcclxuXHRcdFx0XHQkaHR0cC5wb3N0KCcvYXV0aC91bmxpbmsnLCB7XHJcblx0XHRcdFx0XHRpZDogcHJvZmlsZVNlcnZpY2UucmVmcmVzaFByb2ZpbGVEYXRhKCkuX2lkLFxyXG5cdFx0XHRcdFx0cHJvdmlkZXI6IHByb3ZpZGVyXHJcblx0XHRcdFx0fSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHRcdFx0XHRcdHRvYXN0ZXJTZXJ2aWNlLmluZm8oJ1lvdSBoYXZlIHVubGlua2VkIGEgJyArIHByb3ZpZGVyICsgJyBhY2NvdW50Jyk7XHJcblx0XHRcdFx0XHRwcm9maWxlU2VydmljZS5nZXRQcm9maWxlKCk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQkc2NvcGUudXBkYXRlUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRwcm9maWxlU2VydmljZS5nZXRQcm9maWxlKCk7XHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQkc2NvcGUubmV3VXNlckRhdGEgPSB7XHJcblx0XHRcdFx0ZW1haWw6IHByb2ZpbGVTZXJ2aWNlLnJlZnJlc2hQcm9maWxlRGF0YSgpLmVtYWlsLFxyXG5cdFx0XHRcdGN1cnJlbnRQYXNzOiBcIlwiLFxyXG5cdFx0XHRcdG5ld1Bhc3M6IFwiXCIsXHJcblx0XHRcdFx0bmV3UGFzc1JlcGVhdDogXCJcIlxyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQkc2NvcGUuc3VibWl0ID0gZnVuY3Rpb24gKCkgeyAvL2Z1bmN0aW9uIHRvIGNhbGwgb24gZm9ybSBzdWJtaXRcclxuXHRcdFx0XHRpZiAoJHNjb3BlLnVwbG9hZF9mb3JtLmZpbGUuJHZhbGlkICYmICRzY29wZS5maWxlKSB7IC8vY2hlY2sgaWYgZnJvbSBpcyB2YWxpZFxyXG5cdFx0XHRcdFx0JHNjb3BlLnVwbG9hZCgkc2NvcGUuZmlsZSk7IC8vY2FsbCB1cGxvYWQgZnVuY3Rpb25cclxuXHRcdFx0XHR9XHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQkc2NvcGUudXBsb2FkID0gZnVuY3Rpb24gKGZpbGUpIHtcclxuXHRcdFx0XHRjb25zb2xlLmxvZygkc2NvcGUuZmlsZSk7XHJcblx0XHRcdFx0VXBsb2FkLnVwbG9hZCh7XHJcblx0XHRcdFx0XHR1cmw6ICcvdXBsb2FkJywgLy93ZWJBUEkgZXhwb3NlZCB0byB1cGxvYWQgdGhlIGZpbGVcclxuXHRcdFx0XHRcdGRhdGE6IHtcclxuXHRcdFx0XHRcdFx0ZmlsZTogZmlsZSxcclxuXHRcdFx0XHRcdFx0dXNlcjogYXV0aFNlcnZpY2UudXNlcklEKClcclxuXHRcdFx0XHRcdH0gLy9wYXNzIGZpbGUgYXMgZGF0YSwgc2hvdWxkIGJlIHVzZXIgbmctbW9kZWxcclxuXHRcdFx0XHR9KS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7IC8vdXBsb2FkIGZ1bmN0aW9uIHJldHVybnMgYSBwcm9taXNlXHJcblx0XHRcdFx0XHRpZiAocmVzcC5kYXRhLmVycm9yX2NvZGUgPT09IDApIHsgLy92YWxpZGF0ZSBzdWNjZXNzXHJcblx0XHRcdFx0XHRcdHByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGUoKTtcclxuXHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdCR3aW5kb3cuYWxlcnQoJ2FuIGVycm9yIG9jY3VyZWQnKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9LCBmdW5jdGlvbiAocmVzcCkgeyAvL2NhdGNoIGVycm9yXHJcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnRXJyb3Igc3RhdHVzOiAnICsgcmVzcC5zdGF0dXMpO1xyXG5cdFx0XHRcdFx0JHdpbmRvdy5hbGVydCgnRXJyb3Igc3RhdHVzOiAnICsgcmVzcC5zdGF0dXMpO1xyXG5cdFx0XHRcdH0sIGZ1bmN0aW9uIChldnQpIHtcclxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKGV2dCk7XHJcblx0XHRcdFx0XHR2YXIgcHJvZ3Jlc3NQZXJjZW50YWdlID0gcGFyc2VJbnQoMTAwLjAgKiBldnQubG9hZGVkIC8gZXZ0LnRvdGFsKTtcclxuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCdwcm9ncmVzczogJyArIHByb2dyZXNzUGVyY2VudGFnZSArICclICcgKyBldnQuY29uZmlnLmRhdGEuZmlsZS5uYW1lKTtcclxuXHRcdFx0XHRcdCRzY29wZS5wcm9ncmVzcyA9ICdwcm9ncmVzczogJyArIHByb2dyZXNzUGVyY2VudGFnZSArICclICc7IC8vIGNhcHR1cmUgdXBsb2FkIHByb2dyZXNzXHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHR2YXIgUFJPRklMRV9FUlJPUlMgPSB7XHJcblx0XHRcdFx0ZmllbGRfcmVxdWlyZWQ6ICdUaGlzIGZpZWxkIGlzIHJlcXVpcmVkJyxcclxuXHRcdFx0XHRlbWFpbF9leGFtcGxlOiAnUGxlYXNlLCB1c2UgZXhhbXBsZTogamFja3NwYXJyb3dAZ21haWwuY29tJyxcclxuXHRcdFx0XHRtaW5fNnN5bWJsOiAnUGxlYXNlLGVudGVyIGF0IGxlYXN0IDYgY2hhcmFjdGVycycsXHJcblx0XHRcdFx0bWluXzlzeW1ibDogJ1BsZWFzZSxlbnRlciBhdCBsZWFzdCA5IGNoYXJhY3RlcnMnLFxyXG5cdFx0XHRcdG1heF8yMHN5bWJsOiAnUGxlYXNlLG5vIG1vcmUgdGhlbiAyMCBjaGFyYWN0ZXJzJyxcclxuXHRcdFx0XHRyZWdfZXhwOiAnUGFzc3dvcmQgbXVzdCBjb250YWluKGEteixBLVosMC05LCFAIyknXHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQkc2NvcGUuY2hhbmdlUGFzcyA9IGZ1bmN0aW9uIChmb3JtKSB7XHJcblx0XHRcdFx0aWYgKGZvcm0udmFsaWRhdGUoKSkge1xyXG5cdFx0XHRcdFx0Y29uc29sZS5sb2coXCJTdWJtaXQgY2hhbmdlIHBhc3N3b3JkXCIpO1xyXG5cdFx0XHRcdFx0cmV0dXJuICRodHRwLnBvc3QoJy9jaGFuZ2VQYXNzd29yZCcsICRzY29wZS5uZXdVc2VyRGF0YSwge1xyXG5cdFx0XHRcdFx0XHRoZWFkZXJzOiB7XHJcblx0XHRcdFx0XHRcdFx0QXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgYXV0aFNlcnZpY2UuZ2V0VG9rZW4oKVxyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9KS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRcdHRvYXN0ZXJTZXJ2aWNlLnN1Y2Nlc3MoJ1lvdSBoYXZlIHN1Y2Nlc3NmdWxseSBjaGFuZ2VkIHBzd2QnKTtcclxuXHRcdFx0XHRcdFx0YXV0aFNlcnZpY2Uuc2F2ZVRva2VuKGRhdGEudG9rZW4pO1xyXG5cdFx0XHRcdFx0XHQkc3RhdGUuZ28oJ2Rhc2hib2FyZC4nICsgZGFzaGJvYXJkU2VydmljZS5nZXRWaWV3TW9kZSgpLCB7XHJcblx0XHRcdFx0XHRcdFx0aWQ6IGF1dGhTZXJ2aWNlLnVzZXJJRCgpXHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0fSkuZXJyb3IoZnVuY3Rpb24gKGVycikge1xyXG5cdFx0XHRcdFx0XHQkc2NvcGUuZXJyID0gZXJyO1xyXG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlcnIubWVzc2FnZSk7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH07XHJcblxyXG5cdFx0XHQkc2NvcGUuY2hhbmdlUGFzc1ZhbGlkYXRpb24gPSB7XHJcblx0XHRcdFx0cnVsZXM6IHtcclxuXHRcdFx0XHRcdGN1cnJlbnRQYXNzd29yZDoge1xyXG5cdFx0XHRcdFx0XHRyZXF1aXJlZDogdHJ1ZVxyXG5cdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdG5ld1Bhc3N3b3JkOiB7XHJcblx0XHRcdFx0XHRcdHJlcXVpcmVkOiB0cnVlLFxyXG5cdFx0XHRcdFx0XHRtaW5sZW5ndGg6IDYsXHJcblx0XHRcdFx0XHRcdG1heGxlbmd0aDogNDAsXHJcblx0XHRcdFx0XHRcdHBhdHRlcm46IHRydWVcclxuXHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRyZXBlYXROZXdQYXNzd29yZDoge1xyXG5cdFx0XHRcdFx0XHRyZXF1aXJlZDogdHJ1ZVxyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0bWVzc2FnZXM6IHtcclxuXHRcdFx0XHRcdGN1cnJlbnRQYXNzd29yZDoge1xyXG5cdFx0XHRcdFx0XHRyZXF1aXJlZDogUFJPRklMRV9FUlJPUlMuZmllbGRfcmVxdWlyZWQsXHJcblx0XHRcdFx0XHRcdGVtYWlsOiBQUk9GSUxFX0VSUk9SUy5lbWFpbF9leGFtcGxlLFxyXG5cdFx0XHRcdFx0XHRtaW5sZW5ndGg6IFBST0ZJTEVfRVJST1JTLm1pbl85c3ltYmwsXHJcblx0XHRcdFx0XHRcdG1heGxlbmd0aDogUFJPRklMRV9FUlJPUlMubWF4XzIwc3ltYmxcclxuXHRcdFx0XHRcdH0sXHJcblx0XHRcdFx0XHRuZXdQYXNzd29yZDoge1xyXG5cdFx0XHRcdFx0XHRyZXF1aXJlZDogUFJPRklMRV9FUlJPUlMuZmllbGRfcmVxdWlyZWQsXHJcblx0XHRcdFx0XHRcdG1pbmxlbmd0aDogUFJPRklMRV9FUlJPUlMubWluXzZzeW1ibCxcclxuXHRcdFx0XHRcdFx0bWF4bGVuZ3RoOiBQUk9GSUxFX0VSUk9SUy5tYXhfMjBzeW1ibCxcclxuXHRcdFx0XHRcdFx0cGF0dGVybjogUFJPRklMRV9FUlJPUlMucmVnX2V4cFxyXG5cdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdHJlcGVhdE5ld1Bhc3N3b3JkOiB7XHJcblx0XHRcdFx0XHRcdHJlcXVpcmVkOiBQUk9GSUxFX0VSUk9SUy5maWVsZF9yZXF1aXJlZFxyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0fTtcclxuXHJcblx0XHRcdCRzY29wZS51cGRhdGVUaGVtZSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHR0aGVtZVNlcnZpY2UubGF5b3V0ID0gJHNjb3BlLmxheW91dDtcclxuXHRcdFx0fTtcclxuXHJcblx0XHRcdCRzY29wZS5sYXlvdXQgPSB0aGVtZVNlcnZpY2UubGF5b3V0O1xyXG5cdFx0XHQkc2NvcGUubGF5b3V0cyA9IHRoZW1lU2VydmljZS5sYXlvdXRzO1xyXG5cdFx0fVxyXG5cdF0pO1xyXG59KSgpO1xyXG5cbihmdW5jdGlvbiAoKSB7XHJcblx0J3VzZSBzdHJpY3QnO1xyXG5cdGFuZ3VsYXIubW9kdWxlKCdyc3NyZWFkZXInKS5jb250cm9sbGVyKCdTaWRlYmFyQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRzdGF0ZScsICdmZWVkc1NlcnZpY2UnLCAnYXJ0aWNsZXNTZXJ2aWNlJywgJ2Rhc2hib2FyZFNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUsIGZlZWRzU2VydmljZSwgYXJ0aWNsZXNTZXJ2aWNlLCBkYXNoYm9hcmRTZXJ2aWNlKSB7XHJcblx0XHQkc2NvcGUuZmVlZHNMaXN0RHJhZ2FibGVUeXBlcyA9IFsnZmVlZHMnXTtcclxuXHRcdCRzY29wZS5mYXZzTGlzdERyYWdhYmxlVHlwZXMgPSBbJ2ZhdnMnXTtcclxuXHRcdCRzY29wZS5jdXJyZW50QXJ0aWNsZXNUeXBlID0gZGFzaGJvYXJkU2VydmljZS5jdXJyZW50QXJ0aWNsZXNUeXBlO1xyXG5cdFx0JHNjb3BlLmN1cnJlbnRTZWxlY3RlZEl0ZW07XHJcblx0XHQkc2NvcGUuZmVlZHMgPSBmZWVkc1NlcnZpY2UuZmVlZHNEaWN0aW9uYXJ5O1xyXG5cdFx0JHNjb3BlLmZhdnMgPSBmZWVkc1NlcnZpY2UuZmF2b3VyaXRlc0RpY3Rpb25hcnk7XHJcblx0XHQkc2NvcGUub25GZWVkc0RyYWcgPSBmdW5jdGlvbiAoaW5kZXgpIHtcclxuXHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IHRydWU7XHJcblx0XHRcdCRzY29wZS5mZWVkcy5zcGxpY2UoaW5kZXgsIDEpO1xyXG5cdFx0XHRmZWVkc1NlcnZpY2Uuc2V0RmVlZHNPcmRlcigpLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHtcclxuXHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLmxvYWRpbmdJY29uID0gZmFsc2U7XHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cdFx0JHNjb3BlLm9uRmF2c0RyYWcgPSBmdW5jdGlvbiAoaW5kZXgpIHtcclxuXHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IHRydWU7XHJcblx0XHRcdCRzY29wZS5mYXZzLnNwbGljZShpbmRleCwgMSk7XHJcblx0XHRcdGZlZWRzU2VydmljZS5zZXRGYXZzT3JkZXIoKS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7XHJcblx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IGZhbHNlO1xyXG5cdFx0XHR9KTtcclxuXHRcdH1cclxuXHRcdCRzY29wZS5nZXRBbGwgPSBmdW5jdGlvbiAoJGV2ZW50KSB7XHJcblx0XHRcdHNldEFydGljbGVzVHlwZShhbmd1bGFyLmVsZW1lbnQoJGV2ZW50LmN1cnJlbnRUYXJnZXQpLnBhcmVudCgpLCAnYWxsJyk7XHJcblx0XHRcdC8vIGlmIHRoZXJlIGlzIG9ubHkgb25lIGNhdGVnb3J5IGFuZCBmZWVkLCByZXR1cm4gdGhpcyBmZWVkIGFydGljbGVzXHJcblx0XHRcdGlmICgkc2NvcGUuZmVlZHMubGVuZ3RoID09PSAxICYmICRzY29wZS5mZWVkc1swXS52YWx1ZXMubGVuZ3RoID09PSAxKSB7XHJcblx0XHRcdFx0YXJ0aWNsZXNTZXJ2aWNlLmdldEFydGljbGVzQnlGZWVkKCRzY29wZS5mZWVkc1swXS52YWx1ZXNbMF0pO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGFydGljbGVzU2VydmljZS5nZXRBbGxBcnRpY2xlcygpO1xyXG5cdFx0XHR9XHJcblx0XHRcdCRzdGF0ZS5nbyhcImRhc2hib2FyZC5cIiArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSk7XHJcblx0XHR9XHJcblx0XHQkc2NvcGUuZ2V0QnlGZWVkID0gZnVuY3Rpb24gKCRldmVudCwgZmVlZCkge1xyXG5cdFx0XHRzZXRBcnRpY2xlc1R5cGUoYW5ndWxhci5lbGVtZW50KCRldmVudC5jdXJyZW50VGFyZ2V0KS5wYXJlbnQoKSk7XHJcblx0XHRcdGFydGljbGVzU2VydmljZS5nZXRBcnRpY2xlc0J5RmVlZChmZWVkKTtcclxuXHRcdFx0JHN0YXRlLmdvKFwiZGFzaGJvYXJkLlwiICsgZGFzaGJvYXJkU2VydmljZS5nZXRWaWV3TW9kZSgpKTtcclxuXHRcdH1cclxuXHRcdCRzY29wZS5nZXRCeUNhdCA9IGZ1bmN0aW9uICgkZXZlbnQsIGNhdCwgaW5kZXgpIHtcclxuXHRcdFx0c2V0QXJ0aWNsZXNUeXBlKGFuZ3VsYXIuZWxlbWVudCgkZXZlbnQuY3VycmVudFRhcmdldCkucGFyZW50KCksICdjYXRlZ29yeScsIGNhdCk7XHJcblx0XHRcdGlmICgkZXZlbnQuY3VycmVudFRhcmdldC5hdHRyaWJ1dGVzWzRdKSB7XHJcblx0XHRcdFx0aWYgKCRldmVudC5jdXJyZW50VGFyZ2V0LmF0dHJpYnV0ZXNbNF0udmFsdWUgPT0gJ3RydWUnKSB7XHJcblx0XHRcdFx0XHRhbmd1bGFyLmVsZW1lbnQoJGV2ZW50LmN1cnJlbnRUYXJnZXQpLnJlbW92ZUNsYXNzKCdjaGV2cm9uLWRvd24nKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0aWYgKCRldmVudC5jdXJyZW50VGFyZ2V0LmF0dHJpYnV0ZXNbNF0udmFsdWUgPT0gJ2ZhbHNlJykge1xyXG5cdFx0XHRcdFx0YW5ndWxhci5lbGVtZW50KCRldmVudC5jdXJyZW50VGFyZ2V0KS5hZGRDbGFzcygnY2hldnJvbi1kb3duJyk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdGFuZ3VsYXIuZWxlbWVudCgkZXZlbnQuY3VycmVudFRhcmdldCkuYWRkQ2xhc3MoJ2NoZXZyb24tZG93bicpO1xyXG5cdFx0XHR9XHJcblx0XHRcdC8vIGlmIHRoZXJlIGlzIG9ubHkgb25lIGZlZWQgd2l0aGluIHNlbGVjdGVkIGNhdGVnb3J5LCByZXR1cm4gaXRzIGFydGljbGVzXHJcblx0XHRcdGlmICgkc2NvcGUuZmVlZHNbYXJndW1lbnRzWzJdXS52YWx1ZXMubGVuZ3RoID09IDEpIHtcclxuXHRcdFx0XHRhcnRpY2xlc1NlcnZpY2UuZ2V0QXJ0aWNsZXNCeUZlZWQoJHNjb3BlLmZlZWRzW2FyZ3VtZW50c1syXV0udmFsdWVzWzBdKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRhcnRpY2xlc1NlcnZpY2UuZ2V0QXJ0aWNsZXNCeUNhdChhcmd1bWVudHNbMV0pO1xyXG5cdFx0XHR9XHJcblx0XHRcdCRzdGF0ZS5nbyhcImRhc2hib2FyZC5cIiArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSk7XHJcblx0XHR9XHJcblx0XHQkc2NvcGUuZ2V0RmF2b3VyaXRlcyA9IGZ1bmN0aW9uICgkZXZlbnQpIHtcclxuXHRcdFx0c2V0QXJ0aWNsZXNUeXBlKGFuZ3VsYXIuZWxlbWVudCgkZXZlbnQuY3VycmVudFRhcmdldCkucGFyZW50KCksICdmYXZvdXJpdGVzJyk7XHJcblx0XHRcdGlmICgkZXZlbnQuY3VycmVudFRhcmdldC5hdHRyaWJ1dGVzWzRdKSB7XHJcblx0XHRcdFx0aWYgKCRldmVudC5jdXJyZW50VGFyZ2V0LmF0dHJpYnV0ZXNbNF0udmFsdWUgPT0gJ3RydWUnKSB7XHJcblx0XHRcdFx0XHRhbmd1bGFyLmVsZW1lbnQoJGV2ZW50LmN1cnJlbnRUYXJnZXQpLnJlbW92ZUNsYXNzKCdjaGV2cm9uLWRvd24nKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0aWYgKCRldmVudC5jdXJyZW50VGFyZ2V0LmF0dHJpYnV0ZXNbNF0udmFsdWUgPT0gJ2ZhbHNlJykge1xyXG5cdFx0XHRcdFx0YW5ndWxhci5lbGVtZW50KCRldmVudC5jdXJyZW50VGFyZ2V0KS5hZGRDbGFzcygnY2hldnJvbi1kb3duJyk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdGFuZ3VsYXIuZWxlbWVudCgkZXZlbnQuY3VycmVudFRhcmdldCkuYWRkQ2xhc3MoJ2NoZXZyb24tZG93bicpO1xyXG5cdFx0XHR9XHJcblx0XHRcdGFydGljbGVzU2VydmljZS5nZXRGYXZvdXJpdGVzKCk7XHJcblx0XHRcdCRzdGF0ZS5nbyhcImRhc2hib2FyZC5cIiArIGRhc2hib2FyZFNlcnZpY2UuZ2V0Vmlld01vZGUoKSk7XHJcblx0XHR9XHJcblx0XHQkc2NvcGUuZ2V0RmF2QXJ0aWNsZXNCeUNhdCA9IGZ1bmN0aW9uICgkZXZlbnQsIGNhdCkge1xyXG5cdFx0XHRzZXRBcnRpY2xlc1R5cGUoYW5ndWxhci5lbGVtZW50KCRldmVudC5jdXJyZW50VGFyZ2V0KS5wYXJlbnQoKSwgJ2NhdGVnb3J5JywgY2F0KTtcclxuXHRcdFx0aWYgKCRldmVudC5jdXJyZW50VGFyZ2V0LmF0dHJpYnV0ZXNbNF0pIHtcclxuXHRcdFx0XHRpZiAoJGV2ZW50LmN1cnJlbnRUYXJnZXQuYXR0cmlidXRlc1s0XS52YWx1ZSA9PSAndHJ1ZScpIHtcclxuXHRcdFx0XHRcdGFuZ3VsYXIuZWxlbWVudCgkZXZlbnQuY3VycmVudFRhcmdldCkucmVtb3ZlQ2xhc3MoJ2NoZXZyb24tZG93bicpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRpZiAoJGV2ZW50LmN1cnJlbnRUYXJnZXQuYXR0cmlidXRlc1s0XS52YWx1ZSA9PSAnZmFsc2UnKSB7XHJcblx0XHRcdFx0XHRhbmd1bGFyLmVsZW1lbnQoJGV2ZW50LmN1cnJlbnRUYXJnZXQpLmFkZENsYXNzKCdjaGV2cm9uLWRvd24nKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0YW5ndWxhci5lbGVtZW50KCRldmVudC5jdXJyZW50VGFyZ2V0KS5hZGRDbGFzcygnY2hldnJvbi1kb3duJyk7XHJcblx0XHRcdH1cclxuXHRcdFx0YXJ0aWNsZXNTZXJ2aWNlLmdldEZhdkFydGljbGVzQnlDYXQoYXJndW1lbnRzWzFdKTtcclxuXHRcdFx0JHN0YXRlLmdvKFwiZGFzaGJvYXJkLlwiICsgZGFzaGJvYXJkU2VydmljZS5nZXRWaWV3TW9kZSgpKTtcclxuXHRcdH1cclxuXHRcdCRzY29wZS5nZXRGYXZBcnRpY2xlID0gZnVuY3Rpb24gKCRldmVudCwgYXJ0aWNsZSkge1xyXG5cdFx0XHRzZXRBcnRpY2xlc1R5cGUoYW5ndWxhci5lbGVtZW50KCRldmVudC5jdXJyZW50VGFyZ2V0KS5wYXJlbnQoKSk7XHJcblx0XHRcdGFydGljbGVzU2VydmljZS5nZXRGYXZBcnRpY2xlKGFydGljbGUpO1xyXG5cdFx0XHQkc3RhdGUuZ28oXCJkYXNoYm9hcmQuXCIgKyBkYXNoYm9hcmRTZXJ2aWNlLmdldFZpZXdNb2RlKCkpO1xyXG5cdFx0fVxyXG5cdFx0JHNjb3BlLmhpZGVGYXZvdXJpdGVzID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRyZXR1cm4gJHNjb3BlLmZhdnMubGVuZ3RoO1xyXG5cdFx0fVxyXG5cclxuXHRcdCRzY29wZS5jaGVja0lmRW1wdHkgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdGlmIChmZWVkc1NlcnZpY2UuZmVlZHNEaWN0aW9uYXJ5Lmxlbmd0aCA9PSAwKSB7XHJcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xyXG5cdFx0XHR9IGVsc2UgcmV0dXJuIHRydWU7XHJcblx0XHR9XHJcblx0XHQkc2NvcGUudG9nZ2xlID0gZmFsc2U7XHJcblx0XHRcclxuXHRcdHZhciBzZXRBcnRpY2xlc1R5cGUgPSBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgdmFsdWUpIHtcclxuXHRcdFx0aWYgKHR5cGUgJiYgdmFsdWUpIHtcclxuXHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldEN1cnJlbnRBcnRpY2xlc1R5cGUodHlwZSwgdmFsdWUpO1xyXG5cdFx0XHR9XHJcblx0XHRcdGlmICgkc2NvcGUuY3VycmVudFNlbGVjdGVkSXRlbSkge1xyXG5cdFx0XHRcdCRzY29wZS5jdXJyZW50U2VsZWN0ZWRJdGVtLnJlbW92ZUNsYXNzKCdzZWxlY3RlZCcpO1xyXG5cdFx0XHR9XHJcblx0XHRcdCRzY29wZS5jdXJyZW50U2VsZWN0ZWRJdGVtID0gZWxlbWVudDtcclxuXHRcdFx0JHNjb3BlLmN1cnJlbnRTZWxlY3RlZEl0ZW0uYWRkQ2xhc3MoJ3NlbGVjdGVkJyk7XHJcblx0XHR9XHJcblx0fV0pO1xyXG59KSgpO1xuYW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLmRpcmVjdGl2ZSgnbW9kYWwnLCBbZnVuY3Rpb24gKCkge1xyXG5cdHJldHVybiB7XHJcblx0XHRyZXN0cmljdDogJ0UnLFxyXG5cdFx0c2NvcGU6IHtcclxuXHRcdFx0c2hvdzogJz0nXHJcblx0XHR9LFxyXG5cdFx0cmVwbGFjZTogdHJ1ZSxcclxuXHRcdHRyYW5zY2x1ZGU6IHRydWUsXHJcblx0XHRsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7XHJcblx0XHRcdHNjb3BlLm1vZGFsU3R5bGUgPSB7fTtcclxuXHJcblx0XHRcdHNjb3BlLmhpZGVNb2RhbCA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRzY29wZS5zaG93ID0gZmFsc2U7XHJcblx0XHRcdH07XHJcblx0XHR9LFxyXG5cdFx0dGVtcGxhdGVVcmw6ICcuLi9wYXJ0aWFscy9tb2RhbHMvbW9kYWwuaHRtbCdcclxuXHR9O1xyXG59XSk7XHJcblxuYW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLmRpcmVjdGl2ZSgncHdDaGVjaycsIFtmdW5jdGlvbigpIHtcclxuXHRcdHJldHVybiB7XHJcblx0XHRcdHJlcXVpcmU6ICduZ01vZGVsJyxcclxuXHRcdFx0bGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW0sIGF0dHJzLCBjdHJsKSB7XHJcblx0XHRcdFx0dmFyIGZpcnN0UGFzc3dvcmQgPSAnIycgKyBhdHRycy5wd0NoZWNrO1xyXG5cdFx0XHRcdGVsZW0uYWRkKGZpcnN0UGFzc3dvcmQpLm9uKCdrZXl1cCcsIGZ1bmN0aW9uKCkge1xyXG5cdFx0XHRcdFx0c2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkge1xyXG5cdFx0XHRcdFx0XHRpZiAoZWxlbS52YWwoKSA9PT0gXCJcIikge1xyXG5cdFx0XHRcdFx0XHRcdHJldHVybjtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR2YXIgdiA9IGVsZW0udmFsKCkgPT09ICQoZmlyc3RQYXNzd29yZCkudmFsKCk7XHJcblx0XHRcdFx0XHRcdGN0cmwuJHNldFZhbGlkaXR5KCdwd21hdGNoJywgdik7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1dKTtcbmFuZ3VsYXIubW9kdWxlKCdyc3NyZWFkZXInKS5kaXJlY3RpdmUoJ2NoZWNrU3RyZW5ndGgnLCBbZnVuY3Rpb24oKSB7XHJcblx0cmV0dXJuIHtcclxuXHRcdHJlcGxhY2U6IGZhbHNlLFxyXG5cdFx0cmVzdHJpY3Q6ICdFQUNNJyxcclxuXHRcdGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7XHJcblx0XHRcdHZhciBzdHJlbmd0aCA9IHtcclxuXHRcdFx0XHRjb2xvcnM6IFsnI0YwMCcsICcjRjkwJywgJyNGRjAnLCAnIzlGMCcsICcjMEYwJ10sXHJcblx0XHRcdFx0bWVzdXJlU3RyZW5ndGg6IGZ1bmN0aW9uKHApIHtcclxuXHRcdFx0XHRcdGlmIChwKSB7XHJcblx0XHRcdFx0XHRcdHZhciBfZm9yY2UgPSAwLFxyXG5cdFx0XHRcdFx0XHRcdF9yZWdleCA9IC9bI0AkLS86LT8tfiFcIl5fYF0vZyxcclxuXHRcdFx0XHRcdFx0XHRfbG93ZXJMZXR0ZXJzID0gL1thLXpdKy8udGVzdChwKSxcclxuXHRcdFx0XHRcdFx0XHRfdXBwZXJMZXR0ZXJzID0gL1tBLVpdKy8udGVzdChwKSxcclxuXHRcdFx0XHRcdFx0XHRfbnVtYmVycyA9IC9bMC05XSsvLnRlc3QocCksXHJcblx0XHRcdFx0XHRcdFx0X3N5bWJvbHMgPSBfcmVnZXgudGVzdChwKSxcclxuXHRcdFx0XHRcdFx0XHRfZmxhZ3MgPSBbX2xvd2VyTGV0dGVycywgX3VwcGVyTGV0dGVycywgX251bWJlcnMsIF9zeW1ib2xzXSxcclxuXHRcdFx0XHRcdFx0XHRfcGFzc2VkTWF0Y2hlcyA9ICQuZ3JlcChfZmxhZ3MsIGZ1bmN0aW9uKGVsKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gZWwgPT09IHRydWU7XHJcblx0XHRcdFx0XHRcdFx0fSkubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9mb3JjZSArPSAyICogcC5sZW5ndGggKyAoKHAubGVuZ3RoID49IDEwKSA/IDEgOiAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9mb3JjZSArPSBfcGFzc2VkTWF0Y2hlcyAqIDEwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBlbmFsaXR5IChzaG9ydCBwYXNzd29yZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9mb3JjZSA9IChwLmxlbmd0aCA8PSA1KSA/IE1hdGgubWluKF9mb3JjZSwgMTApIDogX2ZvcmNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGVuYWxpdHkgKHBvb3IgdmFyaWV0eSBvZiBjaGFyYWN0ZXJzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZvcmNlID0gKF9wYXNzZWRNYXRjaGVzID09IDEpID8gTWF0aC5taW4oX2ZvcmNlLCAxMCkgOiBfZm9yY2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZm9yY2UgPSAoX3Bhc3NlZE1hdGNoZXMgPT0gMikgPyBNYXRoLm1pbihfZm9yY2UsIDIwKSA6IF9mb3JjZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9mb3JjZSA9IChfcGFzc2VkTWF0Y2hlcyA9PSAzKSA/IE1hdGgubWluKF9mb3JjZSwgNDApIDogX2ZvcmNlO1xyXG5cclxuXHRcdFx0XHRcdFx0cmV0dXJuIF9mb3JjZTtcclxuXHJcblx0XHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0XHRyZXR1cm4gc2NvcGUudXNlci5wYXNzd29yZCA9ICcnO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0Z2V0Q29sb3I6IGZ1bmN0aW9uKHMpIHtcclxuXHRcdFx0XHRcdHZhciBpZHggPSAwO1xyXG5cdFx0XHRcdFx0aWYgKHMgPD0gMTApIHsgaWR4ID0gMDsgfSBlbHNlIGlmIChzIDw9IDIwKSB7IGlkeCA9IDE7IH0gZWxzZSBpZiAocyA8PSAzMCkgeyBpZHggPSAyOyB9IGVsc2UgaWYgKHMgPD0gNDApIHsgaWR4ID0gMzsgfSBlbHNlIHsgaWR4ID0gNDsgfVxyXG5cclxuXHRcdFx0XHRcdHJldHVybiB7IGlkeDogaWR4ICsgMSwgY29sOiB0aGlzLmNvbG9yc1tpZHhdIH07XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9O1xyXG5cdFx0XHRzY29wZS4kd2F0Y2goaUF0dHJzLmNoZWNrU3RyZW5ndGgsIGZ1bmN0aW9uKCkge1xyXG5cdFx0XHRcdGlmIChzY29wZS51c2VyLnBhc3N3b3JkID09PSAnJykge1xyXG5cdFx0XHRcdFx0aUVsZW1lbnQuY3NzKHsgXCJkaXNwbGF5XCI6IFwibm9uZVwiIH0pO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHR2YXIgYyA9IHN0cmVuZ3RoLmdldENvbG9yKHN0cmVuZ3RoLm1lc3VyZVN0cmVuZ3RoKHNjb3BlLnVzZXIucGFzc3dvcmQpKTtcclxuXHRcdFx0XHRcdGlFbGVtZW50LmNzcyh7IFwiZGlzcGxheVwiOiBcImJsb2NrXCIgfSk7XHJcblx0XHRcdFx0XHRpRWxlbWVudC5jaGlsZHJlbignbGknKVxyXG5cdFx0XHRcdFx0XHQuY3NzKHsgXCJiYWNrZ3JvdW5kXCI6IFwiI0RERFwiIH0pXHJcblx0XHRcdFx0XHRcdC5zbGljZSgwLCBjLmlkeClcclxuXHRcdFx0XHRcdFx0LmNzcyh7IFwiYmFja2dyb3VuZFwiOiBjLmNvbCB9KTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cdFx0fSxcclxuXHRcdHRlbXBsYXRlOiAnPGxpIGNsYXNzPVwicG9pbnRcIj48L2xpPjxsaSBjbGFzcz1cInBvaW50XCI+PC9saT48bGkgY2xhc3M9XCJwb2ludFwiPjwvbGk+PGxpIGNsYXNzPVwicG9pbnRcIj48L2xpPjxsaSBjbGFzcz1cInBvaW50XCI+PC9saT4nXHJcblx0fTtcclxufV0pO1xuYW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLmRpcmVjdGl2ZSgndG9hc3RlcicsIFsnJHRpbWVvdXQnLCAndG9hc3RlclNlcnZpY2UnLCBmdW5jdGlvbiAoJHRpbWVvdXQsIHRvYXN0ZXJTZXJ2aWNlKSB7XHJcblx0cmV0dXJuIHtcclxuXHRcdHJlc3RyaWN0OiAnRScsXHJcblx0XHR0cmFuc2NsdWRlOiB0cnVlLFxyXG5cdFx0bGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycykgeyBcclxuXHRcdFx0aWYgKGF0dHJzLm92ZXJsYXkpIHtcclxuXHRcdFx0XHRzY29wZS5vdmVybGF5ID0gdHJ1ZTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRzY29wZS5vdmVybGF5ID0gZmFsc2U7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKGF0dHJzLmRlbGF5KSB7XHJcblx0XHRcdFx0c2NvcGUuZGVsYXkgPSBhdHRycy5kZWxheTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRzY29wZS5kZWxheSA9IDUwMDA7XHJcblx0XHRcdH1cclxuXHRcdFx0c2NvcGUudG9hc3RlclN0eWxlID0ge307XHJcblx0XHRcdHNjb3BlLmNvbmZpcm0gPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0c2NvcGUuJHBhcmVudFthdHRycy5jb25maXJtXSgpO1xyXG5cdFx0XHRcdHNjb3BlLmhpZGVUb2FzdGVyKCk7XHJcblx0XHRcdH1cclxuXHRcdFx0c2NvcGUucmVqZWN0ID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdHNjb3BlLmhpZGVUb2FzdGVyKCk7XHJcblx0XHRcdH1cclxuXHRcdFx0c2NvcGUuaGlkZVRvYXN0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0JHRpbWVvdXQuY2FuY2VsKHNjb3BlLnRpbWVyKTtcclxuXHRcdFx0XHRzY29wZS4kZGVzdHJveSgpO1xyXG5cdFx0XHRcdHRvYXN0ZXJTZXJ2aWNlLnJlbW92ZVRvYXN0ZXIoZWxlbWVudCk7XHJcblx0XHRcdH07XHJcblx0XHRcdHNjb3BlLnRpbWVyID0gJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdHNjb3BlLmhpZGVUb2FzdGVyKCk7XHJcblx0XHRcdH0sIHNjb3BlLmRlbGF5KTtcclxuXHRcdH0sXHJcblx0XHR0ZW1wbGF0ZVVybDogJy4uL3BhcnRpYWxzL21vZGFscy90b2FzdGVyLmh0bWwnXHJcblx0fTtcclxufV0pO1xuKGZ1bmN0aW9uICgpIHtcclxuXHQndXNlIHN0cmljdCc7XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpXHJcblx0LmZhY3RvcnkoJ2FjY291bnRJbmZvJywgWyckaHR0cCcsIGZ1bmN0aW9uICgkaHR0cCkge1xyXG5cdFx0cmV0dXJuIHtcclxuXHRcdFx0Z2V0UHJvZmlsZTogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvbWUnKTtcclxuXHRcdFx0fSxcclxuXHRcdFx0dXBkYXRlUHJvZmlsZTogZnVuY3Rpb24gKHByb2ZpbGVEYXRhKSB7XHJcblx0XHRcdFx0cmV0dXJuICRodHRwLnB1dCgnL2FwaS9tZScsIHByb2ZpbGVEYXRhKTtcclxuXHRcdFx0fVxyXG5cdFx0fTtcclxuXHR9XSk7XHJcbn0pKCk7XG4oZnVuY3Rpb24gKCkge1xyXG5cdCd1c2Ugc3RyaWN0JztcclxuXHRhbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJykuZmFjdG9yeSgnYXJ0aWNsZXNTZXJ2aWNlJywgWyckaHR0cCcsICckc3RhdGUnLCAnJHEnLCAnYXV0aFNlcnZpY2UnLCAnJHRpbWVvdXQnLCAnZGFzaGJvYXJkU2VydmljZScsICdmZWVkc1NlcnZpY2UnLCBmdW5jdGlvbiAoJGh0dHAsICRzdGF0ZSwgJHEsIGF1dGhTZXJ2aWNlLCAkdGltZW91dCwgZGFzaGJvYXJkU2VydmljZSwgZmVlZHNTZXJ2aWNlKSB7XHJcblx0XHR2YXIgQVJUSUNMRVNfTlVNID0gNTAsXHJcblx0XHRcdHRlbXBfYXJ0aWNsZXMgPSBbXSxcclxuXHRcdFx0ZGVmZXIgPSAkcS5kZWZlcigpLFxyXG5cdFx0XHRwcm9taXNlcyA9IFtdLFxyXG5cdFx0XHRvYmogPSB7XHJcblx0XHRcdFx0YXJ0aWNsZXM6IFtdLFxyXG5cdFx0XHRcdGFydGljbGVGb3JSZWFkOiBudWxsLFxyXG5cdFx0XHRcdGlzRmF2b3VyaXRlczogZmFsc2UsXHJcblx0XHRcdFx0Y2hlY2tJZkZhdm91cml0ZXM6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHJldHVybiBvYmouaXNGYXZvdXJpdGVzO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0c2V0UmVhZEFydGljbGU6IGZ1bmN0aW9uICgkc2NvcGUsIGZlZWQsIGxpbmspIHtcclxuXHRcdFx0XHRcdGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmFydGljbGVzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0XHRcdGlmIChvYmouYXJ0aWNsZXNbaV0ubGluayA9PT0gbGluaykge1xyXG5cdFx0XHRcdFx0XHRcdCRzY29wZS5hcnRpY2xlRm9yUmVhZCA9IG9iai5hcnRpY2xlc1tpXTtcclxuXHRcdFx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdHJldHVybiBnZXRGZWVkRGF0YUJ5SWQoZmVlZCkuc3VjY2VzcyhmdW5jdGlvbiAocmVzKSB7XHJcblx0XHRcdFx0XHRcdG9iai5yZXNldEFydGljbGVzKCk7XHJcblx0XHRcdFx0XHRcdHZhciBmZWVkT2JqID0gcmVzO1xyXG5cdFx0XHRcdFx0XHRyZXR1cm4gZmV0Y2hBcnRpY2xlcyhmZWVkT2JqKS50aGVuKGZ1bmN0aW9uIChyZXMpIHtcclxuXHRcdFx0XHRcdFx0XHRmb3IgKHZhciBpID0gMDsgaSA8IHRlbXBfYXJ0aWNsZXMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHRcdFx0XHRcdGlmICh0ZW1wX2FydGljbGVzW2ldLmxpbmsgPT09IGxpbmspIHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0JHNjb3BlLmFydGljbGVGb3JSZWFkID0gdGVtcF9hcnRpY2xlc1tpXTtcclxuXHRcdFx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdFx0aWYgKCEkc2NvcGUuYXJ0aWNsZUZvclJlYWQpIHtcclxuXHRcdFx0XHRcdFx0XHRcdCRzdGF0ZS5nbyhcIjQwNFwiKTtcclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0fSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xyXG5cdFx0XHRcdFx0XHRvYmoucmVzZXRBcnRpY2xlcygpO1xyXG5cdFx0XHRcdFx0XHRyZXR1cm4gZ2V0QXJ0aWNsZURhdGFCeUxpbmsobGluaykudGhlbihmdW5jdGlvbiAocmVzKSB7XHJcblx0XHRcdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IGZhbHNlO1xyXG5cdFx0XHRcdFx0XHRcdCRzY29wZS5hcnRpY2xlRm9yUmVhZCA9IHJlcy5kYXRhO1xyXG5cdFx0XHRcdFx0XHR9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XHJcblx0XHRcdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IGZhbHNlO1xyXG5cdFx0XHRcdFx0XHRcdGlmIChlcnIuc3RhdHVzID09PSA0MDQpIHtcclxuXHRcdFx0XHRcdFx0XHRcdCRzdGF0ZS5nbyhcIjQwNFwiKTtcclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHRpZiAoZXJyLnN0YXR1cyA9PT0gNDA0KSB7XHJcblx0XHRcdFx0XHRcdFx0JHN0YXRlLmdvKFwiNDA0XCIpO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdGVsc2UgJHN0YXRlLmdvKFwiZGFzaGJvYXJkLlwiICsgZGFzaGJvYXJkU2VydmljZS5nZXRWaWV3TW9kZSgpKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0Z2V0QWxsQXJ0aWNsZXM6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdG9iai5yZXNldEFydGljbGVzKCk7XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFRpdGxlKFwiQWxsXCIpO1xyXG5cdFx0XHRcdFx0YW5ndWxhci5mb3JFYWNoKGZlZWRzU2VydmljZS5mZWVkc0RpY3Rpb25hcnksIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7XHJcblx0XHRcdFx0XHRcdGFuZ3VsYXIuZm9yRWFjaCh2YWx1ZS52YWx1ZXMsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7XHJcblx0XHRcdFx0XHRcdFx0cHJvbWlzZXMucHVzaChmZXRjaEFydGljbGVzKHZhbHVlKSk7XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHQkcS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0XHRvYmouYXJ0aWNsZXMgPSB0ZW1wX2FydGljbGVzO1xyXG5cdFx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLmxvYWRpbmdJY29uID0gZmFsc2U7XHJcblx0XHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRnZXRBcnRpY2xlc0J5RmVlZDogZnVuY3Rpb24gKGZlZWQpIHtcclxuXHRcdFx0XHRcdG9iai5yZXNldEFydGljbGVzKCk7XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFRpdGxlKGZlZWQudGl0bGUpO1xyXG5cdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5zZXRGZWVkSWQoZmVlZC5faWQpO1xyXG5cdFx0XHRcdFx0ZmV0Y2hBcnRpY2xlcyhmZWVkKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0b2JqLmFydGljbGVzID0gdGVtcF9hcnRpY2xlcztcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0Z2V0QXJ0aWNsZXNCeUNhdDogZnVuY3Rpb24gKGNhdCkge1xyXG5cdFx0XHRcdFx0b2JqLnJlc2V0QXJ0aWNsZXMoKTtcclxuXHRcdFx0XHRcdGRhc2hib2FyZFNlcnZpY2Uuc2V0VGl0bGUoY2F0KTtcclxuXHRcdFx0XHRcdGFuZ3VsYXIuZm9yRWFjaChmZWVkc1NlcnZpY2UuZmVlZHNEaWN0aW9uYXJ5LCBmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG5cdFx0XHRcdFx0XHRpZiAodmFsdWUua2V5ID09PSBjYXQpIHtcclxuXHRcdFx0XHRcdFx0XHRhbmd1bGFyLmZvckVhY2godmFsdWUudmFsdWVzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG5cdFx0XHRcdFx0XHRcdFx0cHJvbWlzZXMucHVzaChmZXRjaEFydGljbGVzKHZhbHVlKSk7XHJcblx0XHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0JHEuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdFx0b2JqLmFydGljbGVzID0gdGVtcF9hcnRpY2xlcztcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0Z2V0RmF2b3VyaXRlczogZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdFx0b2JqLnJlc2V0QXJ0aWNsZXMoKTtcclxuXHRcdFx0XHRcdG9iai5pc0Zhdm91cml0ZXMgPSB0cnVlO1xyXG5cdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5zZXRUaXRsZShcIkZhdm91cml0ZXNcIik7XHJcblx0XHRcdFx0XHRhbmd1bGFyLmZvckVhY2goZmVlZHNTZXJ2aWNlLmZhdm91cml0ZXNEaWN0aW9uYXJ5LCBmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG5cdFx0XHRcdFx0XHRhbmd1bGFyLmZvckVhY2godmFsdWUudmFsdWVzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG5cdFx0XHRcdFx0XHRcdG9iai5hcnRpY2xlcy5wdXNoKHZhbHVlKTtcclxuXHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdGRhc2hib2FyZFNlcnZpY2UubG9hZGluZ0ljb24gPSBmYWxzZTtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdGdldEZhdkFydGljbGVzQnlDYXQ6IGZ1bmN0aW9uIChjYXQpIHtcclxuXHRcdFx0XHRcdG9iai5yZXNldEFydGljbGVzKCk7XHJcblx0XHRcdFx0XHRvYmouaXNGYXZvdXJpdGVzID0gdHJ1ZTtcclxuXHRcdFx0XHRcdGRhc2hib2FyZFNlcnZpY2Uuc2V0VGl0bGUoXCJGYXZvdXJpdGVzOiBcIiArIGNhdCk7XHJcblx0XHRcdFx0XHRhbmd1bGFyLmZvckVhY2goZmVlZHNTZXJ2aWNlLmZhdm91cml0ZXNEaWN0aW9uYXJ5LCBmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG5cdFx0XHRcdFx0XHRpZiAodmFsdWUua2V5ID09PSBjYXQpIHtcclxuXHRcdFx0XHRcdFx0XHRhbmd1bGFyLmZvckVhY2godmFsdWUudmFsdWVzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG5cdFx0XHRcdFx0XHRcdFx0b2JqLmFydGljbGVzLnB1c2godmFsdWUpO1xyXG5cdFx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdGRhc2hib2FyZFNlcnZpY2UubG9hZGluZ0ljb24gPSBmYWxzZTtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdGdldEZhdkFydGljbGU6IGZ1bmN0aW9uIChhcnRpY2xlKSB7XHJcblx0XHRcdFx0XHRvYmoucmVzZXRBcnRpY2xlcygpO1xyXG5cdFx0XHRcdFx0b2JqLmlzRmF2b3VyaXRlcyA9IHRydWU7XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLnNldFRpdGxlKFwiRmF2b3VyaXRlc1wiKTtcclxuXHRcdFx0XHRcdG9iai5hcnRpY2xlcy5wdXNoKGFydGljbGUpO1xyXG5cdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IGZhbHNlO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0YWRkRmF2b3VyaXRlOiBmdW5jdGlvbiAoYXJ0aWNsZSkge1xyXG5cdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IHRydWU7XHJcblx0XHRcdFx0XHRyZXR1cm4gJGh0dHAucG9zdCgnL3VzZXJzLycgKyBhdXRoU2VydmljZS51c2VySUQoKSArICcvYWRkRmF2QXJ0aWNsZScsIGFydGljbGUsIHtcclxuXHRcdFx0XHRcdFx0aGVhZGVyczoge1xyXG5cdFx0XHRcdFx0XHRcdEF1dGhvcml6YXRpb246ICdCZWFyZXIgJyArIGF1dGhTZXJ2aWNlLmdldFRva2VuKClcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fSkudGhlbihmdW5jdGlvbiAocmVzKSB7XHJcblx0XHRcdFx0XHRcdGRhc2hib2FyZFNlcnZpY2UubG9hZGluZ0ljb24gPSBmYWxzZTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdH0sXHJcblx0XHRcdFx0cmVtb3ZlRmF2b3VyaXRlOiBmdW5jdGlvbiAoYXJ0aWNsZSkge1xyXG5cdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IHRydWU7XHJcblx0XHRcdFx0XHRyZXR1cm4gJGh0dHAuZGVsZXRlKCcvdXNlcnMvJyArIGF1dGhTZXJ2aWNlLnVzZXJJRCgpICsgJy9kZWxldGVGYXZGZWVkLycgKyBhcnRpY2xlLl9pZCwge1xyXG5cdFx0XHRcdFx0XHRoZWFkZXJzOiB7XHJcblx0XHRcdFx0XHRcdFx0QXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgYXV0aFNlcnZpY2UuZ2V0VG9rZW4oKVxyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9KS50aGVuKGZ1bmN0aW9uIChyZXMpIHtcclxuXHRcdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5sb2FkaW5nSWNvbiA9IGZhbHNlO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSxcclxuXHRcdFx0XHRyZXNldEFydGljbGVzOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0XHRkYXNoYm9hcmRTZXJ2aWNlLmxvYWRpbmdJY29uID0gdHJ1ZTtcclxuXHRcdFx0XHRcdHRlbXBfYXJ0aWNsZXMubGVuZ3RoID0gMDtcclxuXHRcdFx0XHRcdG9iai5hcnRpY2xlcy5sZW5ndGggPSAwO1xyXG5cdFx0XHRcdFx0b2JqLmlzRmF2b3VyaXRlcyA9IGZhbHNlO1xyXG5cdFx0XHRcdFx0ZGFzaGJvYXJkU2VydmljZS5yZXNldEZlZWRJZCgpO1xyXG5cdFx0XHRcdFx0cHJvbWlzZXMubGVuZ3RoID0gMDtcclxuXHRcdFx0XHR9LFxyXG5cdFx0XHRcdC8vIEFkZGl0aW9uYWwgbWV0aG9kIGZvciB1bml0IHRlc3RpbmdcclxuXHRcdFx0XHRnZXRBcnRpY2xlc0ZldGNoZXI6IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRcdHJldHVybiBmZXRjaEFydGljbGVzO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHRcdFx0Z2V0SW1hZ2UgPSBmdW5jdGlvbiAoaXRlbSwgZm9ybWF0KSB7XHJcblx0XHRcdFx0dmFyIHNvdXJjZSA9IFwiXCI7XHJcblx0XHRcdFx0aWYgKGZvcm1hdCA9PT0gXCJSU1NcIikge1xyXG5cdFx0XHRcdFx0aWYgKCFpdGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdlbmNsb3N1cmUnKS5sZW5ndGgpIHtcclxuXHRcdFx0XHRcdFx0dHJ5IHtcclxuXHRcdFx0XHRcdFx0XHRzb3VyY2UgPSAkKGl0ZW0pLmZpbmQoJ21lZGlhXFxcXDpjb250ZW50LCBjb250ZW50JylbMF0uZ2V0QXR0cmlidXRlKCd1cmwnKTtcclxuXHRcdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XHJcblx0XHRcdFx0XHRcdFx0c291cmNlID0gXCJcIjtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRpZiAoc291cmNlID09IFwiXCIgfHwgc291cmNlID09IHVuZGVmaW5lZCkge1xyXG5cdFx0XHRcdFx0XHRcdHRyeSB7XHJcblx0XHRcdFx0XHRcdFx0XHR2YXIgY29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG5cdFx0XHRcdFx0XHRcdFx0Y29udGVudC5pbm5lckhUTUwgPSBpdGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkZXNjcmlwdGlvbicpWzBdLnRleHRDb250ZW50O1xyXG5cdFx0XHRcdFx0XHRcdFx0c291cmNlID0gJChjb250ZW50KS5maW5kKCdpbWcnKVswXS5zcmM7XHJcblx0XHRcdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRzb3VyY2UgPSBcIlwiO1xyXG5cdFx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdFx0c291cmNlID0gaXRlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZW5jbG9zdXJlJylbMF0uZ2V0QXR0cmlidXRlKCd1cmwnKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9IGVsc2UgaWYgKGZvcm1hdCA9PT0gXCJBVE9NXCIpIHtcclxuXHRcdFx0XHRcdGlmICghaXRlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZW5jbG9zdXJlJykubGVuZ3RoKSB7XHJcblx0XHRcdFx0XHRcdHRyeSB7XHJcblx0XHRcdFx0XHRcdFx0dmFyIGNvbnRlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuXHRcdFx0XHRcdFx0XHRjb250ZW50LmlubmVySFRNTCA9IGl0ZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2NvbnRlbnQnKVswXS50ZXh0Q29udGVudDtcclxuXHRcdFx0XHRcdFx0XHRzb3VyY2UgPSAkKGNvbnRlbnQpLmZpbmQoJ2ltZycpWzBdLnNyYztcclxuXHRcdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XHJcblx0XHRcdFx0XHRcdFx0c291cmNlID0gXCJcIjtcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRyZXR1cm4gc291cmNlO1xyXG5cdFx0XHR9LFxyXG5cdFx0XHRnZXRDb250ZW50ID0gZnVuY3Rpb24gKGl0ZW0sIGZvcm1hdCkge1xyXG5cdFx0XHRcdHZhciBjb250ZW50ID0gXCJcIjtcclxuXHRcdFx0XHRpZiAoZm9ybWF0ID09PSBcIlJTU1wiKSB7XHJcblx0XHRcdFx0XHR0cnkge1xyXG5cdFx0XHRcdFx0XHRjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcblx0XHRcdFx0XHRcdGNvbnRlbnQuaW5uZXJIVE1MID0gaXRlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGVzY3JpcHRpb24nKVswXS50ZXh0Q29udGVudDtcclxuXHRcdFx0XHRcdFx0Y29udGVudCA9ICQoY29udGVudCkudGV4dCgpO1xyXG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7IH1cclxuXHRcdFx0XHR9IGVsc2UgaWYgKGZvcm1hdCA9PT0gXCJBVE9NXCIpIHtcclxuXHRcdFx0XHRcdGNvbnRlbnQgPSAkKGl0ZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2NvbnRlbnQnKVswXS5jaGlsZE5vZGVzWzBdLmRhdGEpLnRleHQoKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0cmV0dXJuIGNvbnRlbnQ7XHJcblx0XHRcdH0sXHJcblx0XHRcdGZldGNoQXJ0aWNsZXMgPSBmdW5jdGlvbiAoZmVlZCkge1xyXG5cdFx0XHRcdHJldHVybiAkaHR0cC5qc29ucChcImh0dHBzOi8vYWpheC5nb29nbGVhcGlzLmNvbS9hamF4L3NlcnZpY2VzL2ZlZWQvbG9hZD92PTEuMCZudW09XCIgKyBBUlRJQ0xFU19OVU0gKyBcIiZxPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KGZlZWQucnNzbGluaykgKyBcIiZtZXRob2Q9SlNPTlAmY2FsbGJhY2s9SlNPTl9DQUxMQkFDSyZvdXRwdXQ9eG1sXCIpXHJcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuXHRcdFx0XHRcdFx0dmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKSxcclxuXHRcdFx0XHRcdFx0XHR4bWxEb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VEYXRhLnhtbFN0cmluZywgXCJ0ZXh0L3htbFwiKSxcclxuXHRcdFx0XHRcdFx0XHRpdGVtcyA9IFtdO1xyXG5cdFx0XHRcdFx0XHRpZiAoZmVlZC5mb3JtYXQgPT09IFwiUlNTXCIpIHtcclxuXHRcdFx0XHRcdFx0XHRpdGVtcyA9IHhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaXRlbScpO1xyXG5cdFx0XHRcdFx0XHRcdGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHRcdFx0XHRcdHZhciBhcnRpY2xlT2JqID0ge1xyXG5cdFx0XHRcdFx0XHRcdFx0XHR0aXRsZTogaXRlbXNbaV0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RpdGxlJylbMF0uaW5uZXJIVE1MLFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRsaW5rOiBpdGVtc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbGluaycpWzBdLnRleHRDb250ZW50LFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRpbWc6IGdldEltYWdlKGl0ZW1zW2ldLCBmZWVkLmZvcm1hdCksXHJcblx0XHRcdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IGdldENvbnRlbnQoaXRlbXNbaV0sIGZlZWQuZm9ybWF0KSxcclxuXHRcdFx0XHRcdFx0XHRcdFx0ZGF0ZTogRGF0ZS5wYXJzZShpdGVtc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgncHViRGF0ZScpWzBdLnRleHRDb250ZW50KSxcclxuXHRcdFx0XHRcdFx0XHRcdFx0ZmVlZDogZmVlZC5faWRcclxuXHRcdFx0XHRcdFx0XHRcdH07XHJcblx0XHRcdFx0XHRcdFx0XHRhcnRpY2xlT2JqLmNvbnRlbnQgPSBhcnRpY2xlT2JqLmNvbnRlbnQgfHwgYXJ0aWNsZU9iai50aXRsZTtcclxuXHRcdFx0XHRcdFx0XHRcdHRlbXBfYXJ0aWNsZXMucHVzaChhcnRpY2xlT2JqKTtcclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoZmVlZC5mb3JtYXQgPT09IFwiQVRPTVwiKSB7XHJcblx0XHRcdFx0XHRcdFx0aXRlbXMgPSB4bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2VudHJ5Jyk7XHJcblx0XHRcdFx0XHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdFx0XHRcdFx0dmFyIGFydGljbGVPYmogPSB7XHJcblx0XHRcdFx0XHRcdFx0XHRcdHRpdGxlOiBpdGVtc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGl0bGUnKVswXS50ZXh0Q29udGVudCxcclxuXHRcdFx0XHRcdFx0XHRcdFx0bGluazogaXRlbXNbaV0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lkJylbMF0udGV4dENvbnRlbnQsXHJcblx0XHRcdFx0XHRcdFx0XHRcdGltZzogZ2V0SW1hZ2UoaXRlbXNbaV0sIGZlZWQuZm9ybWF0KSxcclxuXHRcdFx0XHRcdFx0XHRcdFx0Y29udGVudDogZ2V0Q29udGVudChpdGVtc1tpXSwgZmVlZC5mb3JtYXQpLFxyXG5cdFx0XHRcdFx0XHRcdFx0XHRkYXRlOiBEYXRlLnBhcnNlKGl0ZW1zW2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdwdWJsaXNoZWQnKVswXS50ZXh0Q29udGVudCksXHJcblx0XHRcdFx0XHRcdFx0XHRcdGZlZWQ6IGZlZWQuX2lkXHJcblx0XHRcdFx0XHRcdFx0XHR9O1xyXG5cdFx0XHRcdFx0XHRcdFx0YXJ0aWNsZU9iai5jb250ZW50ID0gYXJ0aWNsZU9iai5jb250ZW50IHx8IGFydGljbGVPYmoudGl0bGU7XHJcblx0XHRcdFx0XHRcdFx0XHR0ZW1wX2FydGljbGVzLnB1c2goYXJ0aWNsZU9iaik7XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdGRhc2hib2FyZFNlcnZpY2UubG9hZGluZ0ljb24gPSBmYWxzZTtcclxuXHRcdFx0XHRcdFx0cmV0dXJuIHJlc3BvbnNlLmRhdGE7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0fSxcclxuXHRcdFx0Z2V0RmVlZERhdGFCeUlkID0gZnVuY3Rpb24gKGlkKSB7XHJcblx0XHRcdFx0cmV0dXJuICRodHRwLnBvc3QoJy91c2Vycy8nICsgYXV0aFNlcnZpY2UudXNlcklEKCkgKyAnL2dldEZlZWREYXRhJywgeyBpZDogaWQgfSwge1xyXG5cdFx0XHRcdFx0aGVhZGVyczoge1xyXG5cdFx0XHRcdFx0XHRBdXRob3JpemF0aW9uOiAnQmVhcmVyICcgKyBhdXRoU2VydmljZS5nZXRUb2tlbigpXHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH0sXHJcblx0XHRcdGdldEFydGljbGVEYXRhQnlMaW5rID0gZnVuY3Rpb24gKGxpbmspIHtcclxuXHRcdFx0XHRyZXR1cm4gJGh0dHAucG9zdCgnL3VzZXJzLycgKyBhdXRoU2VydmljZS51c2VySUQoKSArICcvZ2V0RmF2QXJ0aWNsZScsIHsgbGluazogbGluayB9LCB7XHJcblx0XHRcdFx0XHRoZWFkZXJzOiB7XHJcblx0XHRcdFx0XHRcdEF1dGhvcml6YXRpb246ICdCZWFyZXIgJyArIGF1dGhTZXJ2aWNlLmdldFRva2VuKClcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fVxyXG5cdFx0cmV0dXJuIG9iajtcclxuXHR9XSk7XHJcbn0pKCk7XG4oZnVuY3Rpb24gKCkge1xyXG5cdCd1c2Ugc3RyaWN0JztcclxuXHRhbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJykuZmFjdG9yeSgnYXV0aFNlcnZpY2UnLCBbJyRodHRwJywgJyR3aW5kb3cnLCAnJGF1dGgnLCAndHJhbnNmZXInLCAnand0SGVscGVyJywgJ3RvYXN0ZXJTZXJ2aWNlJywgJ3Byb2ZpbGVTZXJ2aWNlJywgZnVuY3Rpb24gKCRodHRwLCAkd2luZG93LCAkYXV0aCwgdHJhbnNmZXIsIGp3dEhlbHBlciwgdG9hc3RlclNlcnZpY2UsIHByb2ZpbGVTZXJ2aWNlKSB7XHJcblx0XHR2YXIgYXV0aCA9IHtcclxuXHRcdFx0c2F2ZVRva2VuOiBmdW5jdGlvbiAodG9rZW4pIHtcclxuXHRcdFx0XHQkYXV0aC5zZXRUb2tlbih0b2tlbik7XHJcblx0XHRcdH0sXHJcblx0XHRcdGdldFRva2VuOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0cmV0dXJuICRhdXRoLmdldFRva2VuKCk7XHJcblx0XHRcdH0sXHJcblx0XHRcdGlzTG9nZ2VkSW46IGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0XHRyZXR1cm4gJGF1dGguaXNBdXRoZW50aWNhdGVkKCk7XHJcblx0XHRcdH0sXHJcblx0XHRcdGN1cnJlbnRVc2VyOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0cmV0dXJuICBwcm9maWxlU2VydmljZS5yZWZyZXNoUHJvZmlsZURhdGEoKS5lbWFpbDtcclxuXHRcdFx0fSxcclxuXHRcdFx0dXNlcklEOiBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdFx0aWYgKGF1dGguaXNMb2dnZWRJbigpKSB7XHJcblx0XHRcdFx0XHR2YXIgcGF5bG9hZCA9ICRhdXRoLmdldFBheWxvYWQoKTtcclxuXHRcdFx0XHRcdHJldHVybiBwYXlsb2FkLnN1YjtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0sXHJcblx0XHRcdHJlZ2lzdGVyOiBmdW5jdGlvbiAodXNlcikge1xyXG5cdFx0XHRcdHJldHVybiAkaHR0cC5wb3N0KCcvcmVnaXN0ZXInLCB1c2VyKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRhdXRoLnNhdmVUb2tlbihkYXRhLnRva2VuKTtcclxuXHRcdFx0XHR9KS5lcnJvcihmdW5jdGlvbiAoZXJyKSB7XHJcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhlcnIubWVzc2FnZSk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH0sXHJcblx0XHRcdGxvZ0luOiBmdW5jdGlvbiAodXNlcikge1xyXG5cdFx0XHRcdHJldHVybiAkaHR0cC5wb3N0KCcvbG9naW4nLCB1c2VyKS5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XHJcblx0XHRcdFx0XHRhdXRoLnNhdmVUb2tlbihkYXRhLnRva2VuKTtcclxuXHRcdFx0XHR9KS5lcnJvcihmdW5jdGlvbiAoZXJyKSB7XHJcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhlcnIubWVzc2FnZSk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdH0sXHJcblx0XHRcdGxvZ091dDogZnVuY3Rpb24gKCkge1xyXG5cdFx0JGF1dGgucmVtb3ZlVG9rZW4oKTtcclxuXHRcdFx0JGF1dGgubG9nb3V0KCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHRcdHJldHVybiBhdXRoO1xyXG5cdH1dKTtcclxufSkoKTtcclxuXG5hbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJykuc2VydmljZSgnZGFzaGJvYXJkU2VydmljZScsIFsnJHdpbmRvdycsIGZ1bmN0aW9uICgkd2luZG93KSB7XHJcblx0dmFyIHRoYXQgPSB0aGlzO1xyXG5cdHRoaXMuREVGQVVMVF9WSUVXID0gMjtcclxuXHR0aGlzLmxvYWRpbmdJY29uID0gZmFsc2U7XHJcblx0dGhpcy5jdXJyZW50QXJ0aWNsZXNUeXBlID0gJ2FsbCc7XHJcblx0dGhpcy5jdXJyZW50QXJ0aWNsZXNWYWx1ZSA9ICR3aW5kb3cubG9jYWxTdG9yYWdlLmNhdGVnb3J5O1xyXG5cdHRoaXMuaXNSZWFkaW5nQXJ0aWNsZSA9IGZhbHNlO1xyXG5cclxuXHR0aGlzLnNvcnRQYXJhbSA9IHtcclxuXHRcdHR5cGU6ICdkYXRlJyxcclxuXHRcdG9yZGVyOiAwXHJcblx0fTtcclxuXHRpZiAoJHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc29ydFR5cGUpIHtcclxuXHRcdHRoaXMuc29ydFBhcmFtLnR5cGUgPSAkd2luZG93LmxvY2FsU3RvcmFnZS5zb3J0VHlwZTtcclxuXHRcdGlmICgkd2luZG93LmxvY2FsU3RvcmFnZS5zb3J0T3JkZXIpIHtcclxuXHRcdFx0dGhpcy5zb3J0UGFyYW0ub3JkZXIgPSArJHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc29ydE9yZGVyO1xyXG5cdFx0fVxyXG5cdH1cclxuXHRlbHNlIHtcclxuXHRcdCR3aW5kb3cubG9jYWxTdG9yYWdlLnNvcnRUeXBlID0gdGhpcy5zb3J0UGFyYW0udHlwZTtcclxuXHRcdCR3aW5kb3cubG9jYWxTdG9yYWdlLnNvcnRPcmRlciA9IHRoaXMuc29ydFBhcmFtLm9yZGVyO1xyXG5cdH1cclxuXHR0aGlzLnNldFNvcnRQYXJhbSA9IGZ1bmN0aW9uICh0eXBlLCBvcmRlcikge1xyXG5cdFx0dGhpcy5zb3J0UGFyYW0udHlwZSA9IHR5cGU7XHJcblx0XHR0aGlzLnNvcnRQYXJhbS5vcmRlciA9IG9yZGVyO1xyXG5cdFx0JHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc29ydFR5cGUgPSB0aGlzLnNvcnRQYXJhbS50eXBlO1xyXG5cdFx0JHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc29ydE9yZGVyID0gdGhpcy5zb3J0UGFyYW0ub3JkZXI7XHJcblx0fVxyXG5cdHRoaXMuZ2V0U29ydFBhcmFtID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0cmV0dXJuIHRoYXQuc29ydFBhcmFtO1xyXG5cdH1cclxuXHJcbiAgICBpZiAoISR3aW5kb3cubG9jYWxTdG9yYWdlLmFydGljbGVzVHlwZSkge1xyXG5cdFx0JHdpbmRvdy5sb2NhbFN0b3JhZ2UuYXJ0aWNsZXNUeXBlID0gdGhhdC5jdXJyZW50QXJ0aWNsZXNUeXBlO1xyXG5cdH1cclxuXHJcblx0aWYgKCR3aW5kb3cubG9jYWxTdG9yYWdlLmNhdGVnb3J5KSB7XHJcblx0XHRjdXJyZW50QXJ0aWNsZXNWYWx1ZSA9ICR3aW5kb3cubG9jYWxTdG9yYWdlLmNhdGVnb3J5O1xyXG5cdH1cclxuXHJcblx0dGhpcy5zZXRDdXJyZW50QXJ0aWNsZXNUeXBlID0gZnVuY3Rpb24gKHR5cGUsIHZhbHVlKSB7XHJcblx0XHR0aGF0LmN1cnJlbnRBcnRpY2xlc1ZhbHVlID0gbnVsbDtcclxuXHRcdHRoYXQuY3VycmVudEFydGljbGVzVHlwZSA9IHR5cGU7XHJcblx0XHQkd2luZG93LmxvY2FsU3RvcmFnZS5hcnRpY2xlc1R5cGUgPSB0aGF0LmN1cnJlbnRBcnRpY2xlc1R5cGU7XHJcblx0XHRpZiAodmFsdWUpIHtcclxuXHRcdFx0dGhhdC5jdXJyZW50QXJ0aWNsZXNWYWx1ZSA9IHZhbHVlO1xyXG5cdFx0XHQkd2luZG93LmxvY2FsU3RvcmFnZS5jYXRlZ29yeSA9IHRoYXQuY3VycmVudEFydGljbGVzVmFsdWU7XHJcblx0XHR9XHJcblx0fVxyXG5cdHRoaXMuZ2V0Q3VycmVudEFydGljbGVzVHlwZSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdHRoYXQuY3VycmVudEFydGljbGVzVHlwZSA9ICR3aW5kb3cubG9jYWxTdG9yYWdlLmFydGljbGVzVHlwZTtcclxuXHRcdHJldHVybiB0aGF0LmN1cnJlbnRBcnRpY2xlc1R5cGU7XHJcblx0fVxyXG5cdGlmICghJHdpbmRvdy5sb2NhbFN0b3JhZ2Uudmlld01vZGUpIHtcclxuXHRcdCR3aW5kb3cubG9jYWxTdG9yYWdlLnZpZXdNb2RlID0gdGhpcy5ERUZBVUxUX1ZJRVc7XHJcblx0fVxyXG5cdHRoaXMuaXNMb2FkaW5nID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0cmV0dXJuIHRoYXQubG9hZGluZ0ljb247XHJcblx0fTtcclxuXHR0aGlzLnNpZGViYXIgPSBmYWxzZTtcclxuXHR0aGlzLmNoZWNrU2lkZWJhciA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdHJldHVybiB0aGF0LnNpZGViYXI7XHJcblx0fVxyXG5cdHRoaXMubW9kYWxTaG93biA9IGZhbHNlO1xyXG5cdHRoaXMuY3VycmVudFZpZXdNb2RlID0gJHdpbmRvdy5sb2NhbFN0b3JhZ2Uudmlld01vZGU7XHJcblx0dGhpcy52aWV3TW9kZXMgPSBbXHJcblx0XHQnbGlzdCcsXHJcblx0XHQndGgtbGlzdCcsXHJcblx0XHQndGgtbGFyZ2UnXHJcblx0XTtcclxuXHR0aGlzLnJlc2V0Vmlld01vZGUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHQkd2luZG93LmxvY2FsU3RvcmFnZS52aWV3TW9kZSA9IHRoaXMuREVGQVVMVF9WSUVXO1xyXG5cdH1cclxuXHR0aGlzLnNldFZpZXdNb2RlID0gZnVuY3Rpb24gKGluZGV4KSB7XHJcblx0XHQkd2luZG93LmxvY2FsU3RvcmFnZS52aWV3TW9kZSA9IGluZGV4O1xyXG5cdFx0aWYgKGluZGV4ID4gdGhhdC52aWV3TW9kZXMubGVuZ3RoIC0gMSkge1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJWaWV3IG1vZGUgeW91IGFyZSB0cnlpbmcgdG8gc2V0IGlzIG5vdCBkZWZpbmVkXCIpO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0dGhhdC5jdXJyZW50Vmlld01vZGUgPSAkd2luZG93LmxvY2FsU3RvcmFnZS52aWV3TW9kZTtcclxuXHRcdH1cclxuXHR9XHJcblx0dGhpcy5nZXRWaWV3TW9kZSA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdHRoYXQuY3VycmVudFZpZXdNb2RlID0gJHdpbmRvdy5sb2NhbFN0b3JhZ2Uudmlld01vZGU7XHJcblx0XHRyZXR1cm4gdGhhdC52aWV3TW9kZXNbdGhhdC5jdXJyZW50Vmlld01vZGVdO1xyXG5cdH1cclxuXHR0aGlzLnRpdGxlID0gJyc7XHJcblx0dGhpcy5zZXRUaXRsZSA9IGZ1bmN0aW9uICh0aXRsZSkge1xyXG5cdFx0aWYgKHRpdGxlID09IFwiQWRkIEZlZWRcIikge1xyXG5cdFx0XHR0aGlzLnJlc2V0RmVlZElkKCk7XHJcblx0XHR9XHJcblx0XHR0aGF0LnRpdGxlID0gdGl0bGU7XHJcblx0fVxyXG5cdHRoaXMuZ2V0VGl0bGUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRyZXR1cm4gdGhhdC50aXRsZTtcclxuXHR9XHJcblxyXG5cdHRoaXMuY3VycmVudEZlZWQgPSAnJztcclxuXHR0aGlzLmdldEZlZWRJZCA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdHJldHVybiB0aGF0LmN1cnJlbnRGZWVkO1xyXG5cdH1cclxuXHR0aGlzLnNldEZlZWRJZCA9IGZ1bmN0aW9uIChpZCkge1xyXG5cdFx0dGhhdC5jdXJyZW50RmVlZCA9IGlkO1xyXG5cdH1cclxuXHR0aGlzLnJlc2V0RmVlZElkID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0dGhhdC5jdXJyZW50RmVlZCA9ICcnO1xyXG5cdH1cclxufV0pO1xuYW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLnNlcnZpY2UoJ2ZlZWRzU2VydmljZScsIFsnJGh0dHAnLCAnJHN0YXRlJywgJ2F1dGhTZXJ2aWNlJywgJ2Rhc2hib2FyZFNlcnZpY2UnLCBmdW5jdGlvbiAoJGh0dHAsICRzdGF0ZSwgYXV0aFNlcnZpY2UsIGRhc2hib2FyZFNlcnZpY2UpIHtcclxuXHR0aGF0ID0gdGhpcztcclxuXHR0aGlzLmZlZWRzRGljdGlvbmFyeSA9IFtdO1xyXG5cdHRoaXMuZmF2b3VyaXRlc0RpY3Rpb25hcnkgPSBbXTtcclxuXHR0aGlzLmFsbEFydGljbGVzID0gW107XHJcblx0dGhpcy5DQVRFR09SSUVTID0gW1wiTmV3c1wiLCBcIklUXCIsIFwiU3BvcnRcIiwgXCJEZXNpZ25cIiwgXCJNb3ZpZXNcIiwgXCJNdXNpY1wiLCBcIkN1bHR1cmVcIiwgXCJOYXR1cmVcIiwgXCJFY29ub21pY3NcIiwgXCJTY2llbmNlXCJdO1xyXG5cdHRoaXMuYWxsQ2F0ZWdvcmllcyA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdHZhciByZXMgPSB0aGF0LkNBVEVHT1JJRVMuY29uY2F0KGdldEN1c3RvbUNhdGVnb3JpZXMoKSk7XHJcblx0XHRyZXMucHVzaChcIkN1c3RvbVwiKTtcclxuXHRcdHJldHVybiByZXM7XHJcblx0fVxyXG5cdHRoaXMuYWxsRmF2c0NhdGVnb3JpZXMgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHR2YXIgcmVzID0gdGhhdC5DQVRFR09SSUVTLmNvbmNhdChnZXRGYXZzQ3VzdG9tQ2F0ZWdvcmllcygpKTtcclxuXHRcdHJlcy5wdXNoKFwiQ3VzdG9tXCIpO1xyXG5cdFx0cmV0dXJuIHJlcztcclxuXHR9XHJcblx0dmFyIGdldEN1c3RvbUNhdGVnb3JpZXMgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHR2YXIgY3VycmVudEZlZWRzQ2F0cyA9IChmdW5jdGlvbiAoKSB7XHJcblx0XHRcdHZhciByZXMgPSBbXTtcclxuXHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCB0aGF0LmZlZWRzRGljdGlvbmFyeS5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdHJlcy5wdXNoKHRoYXQuZmVlZHNEaWN0aW9uYXJ5W2ldLmtleSk7XHJcblx0XHRcdH1cclxuXHRcdFx0cmV0dXJuIHJlcztcclxuXHRcdH0pKCk7XHJcblx0XHRyZXR1cm4gY3VycmVudEZlZWRzQ2F0cy5maWx0ZXIoZnVuY3Rpb24gKGVsZW0sIGksIGFycmF5KSB7XHJcblx0XHRcdHJldHVybiB0aGF0LkNBVEVHT1JJRVMuaW5kZXhPZihlbGVtKSA9PSAtMTtcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0dmFyIGdldEZhdnNDdXN0b21DYXRlZ29yaWVzID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0dmFyIGN1cnJlbnRGZWVkc0NhdHMgPSAoZnVuY3Rpb24gKCkge1xyXG5cdFx0XHR2YXIgcmVzID0gW107XHJcblx0XHRcdGZvciAodmFyIGkgPSAwOyBpIDwgdGhhdC5mYXZvdXJpdGVzRGljdGlvbmFyeS5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdHJlcy5wdXNoKHRoYXQuZmF2b3VyaXRlc0RpY3Rpb25hcnlbaV0ua2V5KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4gcmVzO1xyXG5cdFx0fSkoKTtcclxuXHRcdHJldHVybiBjdXJyZW50RmVlZHNDYXRzLmZpbHRlcihmdW5jdGlvbiAoZWxlbSwgaSwgYXJyYXkpIHtcclxuXHRcdFx0cmV0dXJuICh0aGF0LkNBVEVHT1JJRVMuaW5kZXhPZihlbGVtKSA9PSAtMSAmJiBlbGVtICE9ICdVbnNvcnRlZCcpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cdHRoaXMuZ2V0QWxsRmVlZHMgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRyZXR1cm4gJGh0dHAuZ2V0KCcvdXNlcnMvJyArIGF1dGhTZXJ2aWNlLnVzZXJJRCgpLCB7XHJcblx0XHRcdGhlYWRlcnM6IHtcclxuXHRcdFx0XHRBdXRob3JpemF0aW9uOiAnQmVhcmVyICcgKyBhdXRoU2VydmljZS5nZXRUb2tlbigpXHJcblx0XHRcdH1cclxuXHRcdH0pLnRoZW4oZnVuY3Rpb24gKHJlcykge1xyXG5cdFx0XHRhbmd1bGFyLmNvcHkocmVzLmRhdGEsIHRoYXQuZmVlZHNEaWN0aW9uYXJ5KTtcclxuXHRcdFx0dGhhdC5nZXRBbGxGYXZvdXJpdGVzKCkudGhlbihmdW5jdGlvbiAocmVzKSB7XHJcblx0XHRcdFx0YW5ndWxhci5jb3B5KHJlcy5kYXRhLCB0aGF0LmZhdm91cml0ZXNEaWN0aW9uYXJ5KTtcclxuXHRcdFx0fSk7XHJcblx0XHR9KTtcclxuXHR9XHJcblx0dGhpcy5nZXRBbGxGYXZvdXJpdGVzID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0cmV0dXJuICRodHRwLmdldCgnL3VzZXJzLycgKyBhdXRoU2VydmljZS51c2VySUQoKSArIFwiL2Zhdm91cml0ZXNcIiwge1xyXG5cdFx0XHRoZWFkZXJzOiB7XHJcblx0XHRcdFx0QXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgYXV0aFNlcnZpY2UuZ2V0VG9rZW4oKVxyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHR9XHJcblx0dmFyIGNoZWNrUnNzRm9ybWF0ID0gZnVuY3Rpb24gKHhtbERvYykge1xyXG5cdFx0Ly9EZXRlcm1pbmUgaWYgUlNTXHJcblx0XHRpZiAoeG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdyc3MnKS5sZW5ndGgpIHtcclxuXHRcdFx0cmV0dXJuICdSU1MnO1xyXG5cdFx0XHQvL0RldGVybWluZSBpZiBBVE9NXHJcblx0XHR9IGVsc2UgaWYgKHhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZmVlZCcpLmxlbmd0aCkge1xyXG5cdFx0XHRyZXR1cm4gJ0FUT00nO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIC0xO1xyXG5cdH1cclxuXHR2YXIgZ2VuZXJhdGVGZWVkID0gZnVuY3Rpb24gKGRvYywgZmVlZCwgZm9ybWF0KSB7XHJcblx0XHR2YXIgZmVlZE9iaiA9IHt9O1xyXG5cdFx0aWYgKGZvcm1hdCA9PT0gJ1JTUycpIHtcclxuXHRcdFx0dmFyIGNoYW5uZWwgPSBkb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2NoYW5uZWwnKVswXTtcclxuXHRcdFx0ZmVlZE9iai50aXRsZSA9IGNoYW5uZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RpdGxlJylbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWU7XHJcblx0XHRcdGZlZWRPYmouZGVzY3JpcHRpb24gPSBjaGFubmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkZXNjcmlwdGlvbicpWzBdLmNoaWxkTm9kZXNbMF0gPyBjaGFubmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkZXNjcmlwdGlvbicpWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlIDogJyc7XHJcblx0XHRcdGZlZWRPYmoubGluayA9IGNoYW5uZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJsaW5rXCIpWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlO1xyXG5cdFx0XHRmZWVkT2JqLnJzc2xpbmsgPSBmZWVkLmxpbms7XHJcblx0XHRcdGZlZWRPYmouY2F0ZWdvcnkgPSBmZWVkLmNhdGVnb3J5O1xyXG5cdFx0fSBlbHNlIGlmIChmb3JtYXQgPT09ICdBVE9NJykge1xyXG5cdFx0XHRmZWVkT2JqLnRpdGxlID0gZG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0aXRsZScpWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlO1xyXG5cdFx0XHRmZWVkT2JqLmRlc2NyaXB0aW9uID0gJyc7XHJcblx0XHRcdGZlZWRPYmoubGluayA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbGluaycpWzBdLmdldEF0dHJpYnV0ZSgnaHJlZicpO1xyXG5cdFx0XHRmZWVkT2JqLnJzc2xpbmsgPSBmZWVkLmxpbms7XHJcblx0XHRcdGZlZWRPYmouY2F0ZWdvcnkgPSBmZWVkLmNhdGVnb3J5O1xyXG5cdFx0fVxyXG5cdFx0ZmVlZE9iai5mb3JtYXQgPSBmb3JtYXQ7XHJcblx0XHRyZXR1cm4gZmVlZE9iajtcclxuXHR9XHJcblx0dGhpcy5nZXRGZWVkR2VuZXJhdG9yID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0cmV0dXJuIGdlbmVyYXRlRmVlZDtcclxuXHR9XHJcblx0dGhpcy5nZXRSc3NDaGVja2VyID0gZnVuY3Rpb24gKCkge1xyXG5cdFx0cmV0dXJuIGNoZWNrUnNzRm9ybWF0O1xyXG5cdH1cclxuXHR0aGlzLmFkZEZlZWQgPSBmdW5jdGlvbiAoZmVlZCkge1xyXG5cdFx0cmV0dXJuICRodHRwLmpzb25wKFwiaHR0cHM6Ly9hamF4Lmdvb2dsZWFwaXMuY29tL2FqYXgvc2VydmljZXMvZmVlZC9sb2FkP3Y9MS4wJm51bT0xMCZxPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KGZlZWQubGluaykgKyBcIiZtZXRob2Q9SlNPTiZjYWxsYmFjaz1KU09OX0NBTExCQUNLJm91dHB1dD14bWxcIilcclxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcblx0XHRcdFx0aWYgKGZlZWQubGluayA9PT0gdW5kZWZpbmVkKSB7XHJcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJFbnRlciBSc3MgZmVlZCBsaW5rXCIpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRpZiAoZmVlZC5jYXRlZ29yeSA9PT0gdW5kZWZpbmVkKSB7XHJcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJDaG9vc2UgY2F0ZWdvcnlcIik7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlRGF0YSA9PT0gbnVsbCkge1xyXG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiVVJMIGlzIGluY29ycmVjdCBvciBkb2VzIG5vdCBjb250YWluIFJTUyBGZWVkIGRhdGFcIik7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7XHJcblx0XHRcdFx0eG1sRG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhyZXNwb25zZS5kYXRhLnJlc3BvbnNlRGF0YS54bWxTdHJpbmcsIFwidGV4dC94bWxcIik7XHJcblx0XHRcdFx0dmFyIGZvcm1hdCA9IGNoZWNrUnNzRm9ybWF0KHhtbERvYyk7XHJcblx0XHRcdFx0aWYgKGZvcm1hdCA9PT0gLTEpIHtcclxuXHRcdFx0XHRcdHRocm93IG5ldyBFcnJvcihcIlVSTCBpcyBpbmNvcnJlY3Qgb3IgZG9lcyBub3QgY29udGFpbiBSU1MgRmVlZCBkYXRhXCIpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHR2YXIgZmVlZE9iaiA9IGdlbmVyYXRlRmVlZCh4bWxEb2MsIGZlZWQsIGZvcm1hdCk7XHJcblx0XHRcdFx0XHRyZXR1cm4gJGh0dHAucG9zdCgnL3VzZXJzLycgKyBhdXRoU2VydmljZS51c2VySUQoKSArICcvYWRkRmVlZCcsIGZlZWRPYmosIHtcclxuXHRcdFx0XHRcdFx0aGVhZGVyczoge1xyXG5cdFx0XHRcdFx0XHRcdEF1dGhvcml6YXRpb246ICdCZWFyZXIgJyArIGF1dGhTZXJ2aWNlLmdldFRva2VuKClcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdHJldHVybiByZXNwb25zZS5kYXRhO1xyXG5cdFx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHRoaXMucmVtb3ZlRmVlZCA9IGZ1bmN0aW9uIChmZWVkSWQpIHtcclxuXHRcdHJldHVybiAkaHR0cC5kZWxldGUoJy91c2Vycy8nICsgYXV0aFNlcnZpY2UudXNlcklEKCkgKyAnL2RlbGV0ZUZlZWQvJyArIGZlZWRJZCwge1xyXG5cdFx0XHRoZWFkZXJzOiB7XHJcblx0XHRcdFx0QXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgYXV0aFNlcnZpY2UuZ2V0VG9rZW4oKVxyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHRoaXMuc2V0RmVlZHNPcmRlciA9IGZ1bmN0aW9uICgpIHtcclxuXHRcdHZhciBvYmogPSB7XHJcblx0XHRcdG5ld0NhdGVnb3JpZXM6IFtdXHJcblx0XHR9XHJcblx0XHRmb3IgKHZhciBpID0gMDsgaSA8IHRoYXQuZmVlZHNEaWN0aW9uYXJ5Lmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdG9iai5uZXdDYXRlZ29yaWVzLnB1c2godGhhdC5mZWVkc0RpY3Rpb25hcnlbaV0ua2V5KTtcclxuXHRcdH1cclxuXHRcdHJldHVybiAkaHR0cC5wb3N0KCcvdXNlcnMvJyArIGF1dGhTZXJ2aWNlLnVzZXJJRCgpICsgJy9zZXRDYXRlZ29yeU9yZGVyJywgb2JqLCB7XHJcblx0XHRcdGhlYWRlcnM6IHtcclxuXHRcdFx0XHRBdXRob3JpemF0aW9uOiAnQmVhcmVyICcgKyBhdXRoU2VydmljZS5nZXRUb2tlbigpXHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0dGhpcy5zZXRGYXZzT3JkZXIgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHR2YXIgb2JqID0ge1xyXG5cdFx0XHRuZXdDYXRlZ29yaWVzOiBbXVxyXG5cdFx0fVxyXG5cdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCB0aGF0LmZhdm91cml0ZXNEaWN0aW9uYXJ5Lmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdG9iai5uZXdDYXRlZ29yaWVzLnB1c2godGhhdC5mYXZvdXJpdGVzRGljdGlvbmFyeVtpXS5rZXkpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuICRodHRwLnBvc3QoJy91c2Vycy8nICsgYXV0aFNlcnZpY2UudXNlcklEKCkgKyAnL3NldEZhdnNDYXRlZ29yeU9yZGVyJywgb2JqLCB7XHJcblx0XHRcdGhlYWRlcnM6IHtcclxuXHRcdFx0XHRBdXRob3JpemF0aW9uOiAnQmVhcmVyICcgKyBhdXRoU2VydmljZS5nZXRUb2tlbigpXHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxufV0pO1xuKGZ1bmN0aW9uKCkge1xyXG5cdCd1c2Ugc3RyaWN0JztcclxuXHRhbmd1bGFyLm1vZHVsZSgncnNzcmVhZGVyJylcclxuXHRcdC5mYWN0b3J5KCdwcm9maWxlU2VydmljZScsIFsnJHdpbmRvdycsICdVcGxvYWQnLCAnYWNjb3VudEluZm8nLCAnJGF1dGgnLFxyXG5cdFx0XHRmdW5jdGlvbigkd2luZG93LCBVcGxvYWQsIGFjY291bnRJbmZvLCAkYXV0aCkge1xyXG5cdFx0XHRcdHZhciBvYmogPSB7XHJcblx0XHRcdFx0XHRwcm9maWxlOiB7fSxcclxuXHRcdFx0XHRcdGdldFByb2ZpbGU6IGZ1bmN0aW9uKCkge1xyXG5cdFx0XHRcdFx0XHRpZiAoJGF1dGguaXNBdXRoZW50aWNhdGVkKCkpIHtcclxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gYWNjb3VudEluZm8uZ2V0UHJvZmlsZSgpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcclxuXHRcdFx0XHRcdFx0XHRcdHZhciBsZW5ndGggPSByZXNwb25zZS5kYXRhLnVzZXIubGVuZ3RoO1xyXG5cdFx0XHRcdFx0XHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAocmVzcG9uc2UuZGF0YS51c2VyW2ldLmVtYWlsID09PSAkYXV0aC5nZXRQYXlsb2FkKCkuZW1haWwpIHtcclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRvYmoucHJvZmlsZSA9IHJlc3BvbnNlLmRhdGEudXNlcltpXTtcclxuXHRcdFx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHR9LFxyXG5cdFx0XHRcdFx0cmVmcmVzaFByb2ZpbGVEYXRhOiBmdW5jdGlvbigpIHtcclxuXHRcdFx0XHRcdFx0cmV0dXJuIG9iai5wcm9maWxlO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRyZXR1cm4gb2JqO1xyXG5cdFx0XHR9XHJcblx0XHRdKTtcclxufSkoKTtcbihmdW5jdGlvbiAoKSB7XHJcblx0J3VzZSBzdHJpY3QnO1xyXG5cdGFuZ3VsYXIubW9kdWxlKCdyc3NyZWFkZXInKS5zZXJ2aWNlKCd0aGVtZVNlcnZpY2UnLCBbJ2F1dGhTZXJ2aWNlJywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoYXV0aFNlcnZpY2UsICR3aW5kb3cpIHtcclxuXHRcdHZhciB0aGF0ID0gdGhpcztcclxuXHRcdHRoaXMubGF5b3V0ID0gJ3N0eWxlJztcclxuXHRcdHRoaXMuZ2V0VGhlbWUgPSBmdW5jdGlvbiAoKSB7XHJcblx0XHRcdHJldHVybiB0aGF0LmxheW91dCAhPT0gdW5kZWZpbmVkID8gdGhhdC5sYXlvdXQgOiBcInN0eWxlXCI7XHJcblx0XHR9XHJcblx0XHR0aGlzLmxheW91dHMgPSBbXHJcblx0XHRcdHtcclxuXHRcdFx0XHRuYW1lOiAnQmx1ZScsXHJcblx0XHRcdFx0dXJsOiAnc3R5bGUnXHJcblx0XHRcdH0sXHJcblx0XHRcdHtcclxuXHRcdFx0XHRuYW1lOiAnQmxhY2snLFxyXG5cdFx0XHRcdHVybDogJ3N0eWxlMidcclxuXHRcdFx0fSxcclxuXHRcdFx0e1xyXG5cdFx0XHRcdG5hbWU6ICdHcmV5JyxcclxuXHRcdFx0XHR1cmw6ICdzdHlsZTMnXHJcblx0XHRcdH1cclxuXHRcdF07XHJcblx0fV0pO1xyXG59KSgpO1xuKGZ1bmN0aW9uICgpIHtcclxuXHQndXNlIHN0cmljdCc7XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpLnNlcnZpY2UoJ3RvYXN0ZXJTZXJ2aWNlJywgWyckcm9vdFNjb3BlJywgJyRjb21waWxlJywgJyRhbmltYXRlJywgZnVuY3Rpb24gKCRyb290U2NvcGUsICRjb21waWxlLCAkYW5pbWF0ZSkge1xyXG5cdFx0dmFyIGRvbVBhcmVudCA9IGFuZ3VsYXIuZWxlbWVudCgnYm9keScpO1xyXG5cclxuXHRcdC8vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcclxuXHRcdC8vICBZb3UgY2FuIHBhc3MgY3VzdG9tIG9wdGlvbnMgdG8gdG9hc3RlciBtZXRob2RzIGFzIHNlY29uZCBwYXJhbWV0ZXJcclxuXHRcdC8vICBvcHRpb25zIHByb3BlcnRpZXM6XHJcblx0XHQvLyAgbWVzc2FnZTogc3RyaW5nXHJcblx0XHQvLyAgb3ZlcmxheTogYm9vbGVhblxyXG5cdFx0Ly8gIGRlbGF5OiB2YWx1ZSAobXMpXHJcblx0XHQvLyAgcG9zaXRpb246IFtsZWZ0LCByaWdodCwgbGVmdC1ib3R0b20sIHJpZ2h0LWJvdHRvbV1cclxuXHRcdC8vICB0eXBlOiBvbmUgb2YgWyd0b2FzdGVyLWRlZmF1bHQnLCAndG9hc3Rlci1zdWNjZXNzJywgJ3RvYXN0ZXItaW5mbycsICd0b2FzdGVyLWVycm9yJ11cclxuXHRcdC8vICBpY29uQ2xhc3M6IHN0cmluZyAobmFtZSBvZiBnbHlwaCBjbGFzcywgZXg6IGZhIGZhLWluZm8pXHJcblx0XHQvLyAgY29uZmlybTogRnVuY3Rpb24gKGNhbGxiYWNrIHRoYXQgd2lsbCBiYSBjYWxsZWQgaWYgdXNlciBjb25maXJtIHRvYXN0ZXIgYWN0aW9uKVxyXG5cdFx0Ly8gXHJcblx0XHQvLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXHJcblxyXG5cdFx0dmFyIGJ1aWxkVG9hc3RlciA9IGZ1bmN0aW9uIChvcHRpb25zLCBzY29wZSwgb25TaG93KSB7XHJcblx0XHRcdHZhciBjYWxsYmFjayA9IGFyZ3VtZW50c1syXSxcclxuXHRcdFx0XHRlbGVtID0gYW5ndWxhci5lbGVtZW50KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0b2FzdGVyXCIpKTtcclxuXHRcdFx0ZWxlbS5hZGRDbGFzcygndG9hc3Rlci13cmFwcGVyJyk7XHJcblx0XHRcdGVsZW0uYWRkQ2xhc3Mob3B0aW9ucy50eXBlKTtcclxuXHRcdFx0aWYgKG9wdGlvbnMub3ZlcmxheSkge1xyXG5cdFx0XHRcdGVsZW0uYXR0cihcIm92ZXJsYXlcIiwgb3B0aW9ucy5vdmVybGF5KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aWYgKG9wdGlvbnMuZGVsYXkpIHtcclxuXHRcdFx0XHRlbGVtLmF0dHIoXCJkZWxheVwiLCBvcHRpb25zLmRlbGF5KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aWYgKG9wdGlvbnMuY29uZmlybSkge1xyXG5cdFx0XHRcdGVsZW0uYXR0cihcImNvbmZpcm1cIiwgb3B0aW9ucy5jb25maXJtKTtcclxuXHRcdFx0fVxyXG5cdFx0XHR2YXIgaWNvbiA9IGFuZ3VsYXIuZWxlbWVudChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcclxuXHRcdFx0aWNvbi5hZGRDbGFzcygndG9hc3Rlci1pY29uJyk7XHJcblx0XHRcdGljb24uYWRkQ2xhc3Mob3B0aW9ucy5pY29uQ2xhc3MpO1xyXG5cdFx0XHRlbGVtLmFwcGVuZChpY29uKTtcclxuXHJcblx0XHRcdGVsZW0uYXBwZW5kKFwiPHNwYW4+XCIgKyBvcHRpb25zLm1lc3NhZ2UgKyBcIjwvc3Bhbj5cIik7XHJcblx0XHRcdGlmIChvcHRpb25zLmh0bWxDb250ZW50KSB7XHJcblx0XHRcdFx0ZWxlbS5hcHBlbmQoXCI8c3Bhbj5cIiArIG9wdGlvbnMuaHRtbENvbnRlbnQgKyBcIjwvc3Bhbj5cIik7XHJcblx0XHRcdH1cclxuXHRcdFx0dmFyIGFwcGVuZEh0bWw7XHJcblx0XHRcdGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnb2JqZWN0Jykge1xyXG5cdFx0XHRcdGFwcGVuZEh0bWwgPSAkY29tcGlsZShlbGVtLCBzY29wZSkoc2NvcGUuJG5ldygpKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRhcHBlbmRIdG1sID0gJGNvbXBpbGUoZWxlbSwgc2NvcGUpKCRyb290U2NvcGUuJG5ldygpKTtcclxuXHRcdFx0fVxyXG5cdFx0XHQkYW5pbWF0ZS5lbnRlcihhcHBlbmRIdG1sLCBkb21QYXJlbnQpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG5cdFx0XHRcdGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcclxuXHRcdFx0XHRcdG9uU2hvdygpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblx0XHR0aGlzLnN1Y2Nlc3MgPSBmdW5jdGlvbiAobWVzc2FnZSwgY3VzdG9tT3B0aW9ucywgc2NvcGUsIG9uU2hvdykge1xyXG5cdFx0XHR2YXIgZGVmYXVsdE9wdGlvbnMgPSB7XHJcblx0XHRcdFx0bWVzc2FnZTogbWVzc2FnZSxcclxuXHRcdFx0XHR0eXBlOiAndG9hc3Rlci1zdWNjZXNzJyxcclxuXHRcdFx0XHRpY29uQ2xhc3M6ICdmYSBmYS1jaGVjaycsXHJcblx0XHRcdFx0ZGVsYXk6IDMwMDBcclxuXHRcdFx0fSxcclxuXHRcdFx0b3B0aW9ucztcclxuXHRcdFx0aWYgKHR5cGVvZiBjdXN0b21PcHRpb25zID09PSAnb2JqZWN0Jykge1xyXG5cdFx0XHRcdG9wdGlvbnMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgZGVmYXVsdE9wdGlvbnMsIGN1c3RvbU9wdGlvbnMpO1xyXG5cdFx0XHR9XHJcblx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdG9wdGlvbnMgPSBkZWZhdWx0T3B0aW9ucztcclxuXHRcdFx0fVxyXG5cdFx0XHRidWlsZFRvYXN0ZXIob3B0aW9ucywgc2NvcGUsIG9uU2hvdyk7XHJcblx0XHR9XHJcblx0XHR0aGlzLmluZm8gPSBmdW5jdGlvbiAobWVzc2FnZSwgY3VzdG9tT3B0aW9ucywgc2NvcGUsIG9uU2hvdykge1xyXG5cdFx0XHR2YXIgZGVmYXVsdE9wdGlvbnMgPSB7XHJcblx0XHRcdFx0bWVzc2FnZTogbWVzc2FnZSxcclxuXHRcdFx0XHR0eXBlOiAndG9hc3Rlci1pbmZvJyxcclxuXHRcdFx0XHRpY29uQ2xhc3M6ICdmYSBmYS1pbmZvJyxcclxuXHRcdFx0XHRkZWxheTogMzAwMFxyXG5cdFx0XHR9LFxyXG5cdFx0XHRvcHRpb25zO1xyXG5cdFx0XHRpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gJ29iamVjdCcpIHtcclxuXHRcdFx0XHRvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRPcHRpb25zLCBjdXN0b21PcHRpb25zKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRvcHRpb25zID0gZGVmYXVsdE9wdGlvbnM7XHJcblx0XHRcdH1cclxuXHRcdFx0YnVpbGRUb2FzdGVyKG9wdGlvbnMsIHNjb3BlLCBvblNob3cpO1xyXG5cdFx0fVxyXG5cdFx0dGhpcy5lcnJvciA9IGZ1bmN0aW9uIChtZXNzYWdlLCBjdXN0b21PcHRpb25zLCBzY29wZSwgb25TaG93KSB7XHJcblx0XHRcdHZhciBkZWZhdWx0T3B0aW9ucyA9IHtcclxuXHRcdFx0XHRtZXNzYWdlOiBtZXNzYWdlLFxyXG5cdFx0XHRcdHR5cGU6ICd0b2FzdGVyLWVycm9yJyxcclxuXHRcdFx0XHRpY29uQ2xhc3M6ICdmYSBmYS1leGNsYW1hdGlvbi10cmlhbmdsZScsXHJcblx0XHRcdFx0ZGVsYXk6IDMwMDBcclxuXHRcdFx0fSxcclxuXHRcdFx0b3B0aW9ucztcclxuXHRcdFx0aWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICdvYmplY3QnKSB7XHJcblx0XHRcdFx0b3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0T3B0aW9ucywgY3VzdG9tT3B0aW9ucyk7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0b3B0aW9ucyA9IGRlZmF1bHRPcHRpb25zO1xyXG5cdFx0XHR9XHJcblx0XHRcdGJ1aWxkVG9hc3RlcihvcHRpb25zLCBzY29wZSwgb25TaG93KTtcclxuXHRcdH1cclxuXHRcdHRoaXMuY3VzdG9tID0gZnVuY3Rpb24gKGN1c3RvbU9wdGlvbnMsIHNjb3BlLCBvblNob3cpIHtcclxuXHRcdFx0dmFyIGRlZmF1bHRPcHRpb25zID0ge1xyXG5cdFx0XHRcdG1lc3NhZ2U6IG1lc3NhZ2UsXHJcblx0XHRcdFx0dHlwZTogJ3RvYXN0ZXItZGVmYXVsdCcsXHJcblx0XHRcdFx0b3ZlcmxheTogdHJ1ZSxcclxuXHRcdFx0XHRpY29uQ2xhc3M6ICdmYSBmYS1pbmZvJyxcclxuXHRcdFx0fSxcclxuXHRcdFx0b3B0aW9ucztcclxuXHRcdFx0aWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdvYmplY3QnKSB7XHJcblx0XHRcdFx0b3B0aW9ucyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBkZWZhdWx0T3B0aW9ucywgY3VzdG9tT3B0aW9ucyk7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0b3B0aW9ucyA9IGRlZmF1bHRPcHRpb25zO1xyXG5cdFx0XHR9XHJcblx0XHRcdGJ1aWxkVG9hc3RlcihvcHRpb25zLCBzY29wZSwgb25TaG93KTtcclxuXHRcdH1cclxuXHRcdHRoaXMuY29uZmlybSA9IGZ1bmN0aW9uIChjdXN0b21PcHRpb25zLCBzY29wZSwgb25TaG93KSB7XHJcblx0XHRcdHZhciBkZWZhdWx0T3B0aW9ucyA9IHtcclxuXHRcdFx0XHRtZXNzYWdlOiAnQ29uZmlybT8nLFxyXG5cdFx0XHRcdHR5cGU6ICd0b2FzdGVyLWRlZmF1bHQnLFxyXG5cdFx0XHRcdG92ZXJsYXk6IHRydWUsXHJcblx0XHRcdFx0aWNvbkNsYXNzOiAnZmEgZmEtcXVlc3Rpb24nLFxyXG5cdFx0XHRcdGh0bWxDb250ZW50OiBcIjxidXR0b24gY2xhc3M9J2FwcC1idG4tdG9hc3Rlci1yZWQnIGFyaWEtbGFiZWw9J0p1c3RpZnknIG5nLWNsaWNrPSdjb25maXJtKCknPnllczwvYnV0dG9uPjxidXR0b24gY2xhc3M9J2FwcC1idG4tdG9hc3RlcicgYXJpYS1sYWJlbD0nSnVzdGlmeScgbmctY2xpY2s9J3JlamVjdCgpJz5ubzwvYnV0dG9uPlwiXHJcblx0XHRcdH0sXHJcblx0XHRcdG9wdGlvbnM7XHJcblx0XHRcdGlmICh0eXBlb2YgY3VzdG9tT3B0aW9ucyA9PT0gJ29iamVjdCcpIHtcclxuXHRcdFx0XHRvcHRpb25zID0gYW5ndWxhci5leHRlbmQoe30sIGRlZmF1bHRPcHRpb25zLCBjdXN0b21PcHRpb25zKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRvcHRpb25zID0gZGVmYXVsdE9wdGlvbnM7XHJcblx0XHRcdH1cclxuXHRcdFx0YnVpbGRUb2FzdGVyKG9wdGlvbnMsIHNjb3BlLCBvblNob3cpO1xyXG5cdFx0fVxyXG5cdFx0dGhpcy5yZW1vdmVUb2FzdGVyID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuXHRcdFx0JGFuaW1hdGUubGVhdmUoZWxlbWVudCwgZG9tUGFyZW50KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblx0fV0pO1xyXG59KSgpO1xuKGZ1bmN0aW9uICgpIHtcclxuXHQndXNlIHN0cmljdCc7XHJcblx0YW5ndWxhci5tb2R1bGUoJ3Jzc3JlYWRlcicpXHJcblx0XHQuZmFjdG9yeSgndHJhbnNmZXInLCBbZnVuY3Rpb24gKCkge1xyXG5cdFx0XHR2YXIgb2JqID0ge307XHJcblx0XHRcdGZ1bmN0aW9uIHNldE9iaihkYXRhKSB7XHJcblx0XHRcdFx0b2JqID0gZGF0YTtcclxuXHRcdFx0fVxyXG5cdFx0XHRmdW5jdGlvbiBnZXRPYmooKSB7XHJcblx0XHRcdFx0cmV0dXJuIG9iajtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4ge1xyXG5cdFx0XHRcdHNldE9iajogc2V0T2JqLFxyXG5cdFx0XHRcdGdldE9iajogZ2V0T2JqXHJcblx0XHRcdH1cclxuICB9XSk7XHJcbn0pKCk7Il0sImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
