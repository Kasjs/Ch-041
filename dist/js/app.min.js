angular.module("rssreader",["ui.router","ngValidate","ngFileUpload","favicon"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("home"),e.state("home",{url:"/home",templateUrl:"./partials/home.html",controller:"HomeController"}).state("login",{url:"/login",templateUrl:"./partials/auth/login.html",controller:"AuthController",onEnter:["$state","authService",function(e,t){t.isLoggedIn()&&e.go("home")}]}).state("loginAuth",{url:"/loginAuth",templateUrl:"partials/auth/loginAuth.html",controller:"AuthController"}).state("logoutAuth",{url:"/logoutAuth",templateUrl:"partials/auth/logoutAuth.html",controller:"AuthController"}).state("register",{url:"/register",templateUrl:"./partials/auth/register.html",controller:"AuthController",onEnter:["$state","authService",function(e,t){t.isLoggedIn()&&e.go("home")}]}).state("profile",{url:"/profile",templateUrl:"./partials/auth/profile.html",controller:"ProfileController",onEnter:["$state","authService",function(e,t){t.isLoggedIn()||e.go("home")}]}).state("dashboard",{url:"/dashboard",views:{"":{templateUrl:"./partials/dashboard/dashboard.html",controller:"DashboardController"},"sidebar@dashboard":{templateUrl:"./partials/dashboard/sidebar.html",controller:"SidebarController"},"feedHead@dashboard":{templateUrl:"./partials/dashboard/feed-head.html",controller:"DashboardController"}},resolve:{feedPromise:["feedsService",function(e){return e.getAllFeeds()}]},onEnter:["articlesService","dashboardService","$state","authService",function(e,t,r,o){e.getAllArticles(),o.currentView=o.DEFAULT_VIEW}]}).state("dashboard.th-large",{url:"/th-large",templateUrl:"./partials/list/th-large.html",controller:"ArticlesController"}).state("dashboard.list",{url:"/list",templateUrl:"./partials/list/list.html",controller:"ArticlesController"}).state("dashboard.th-list",{url:"/th-list",templateUrl:"./partials/list/th-list.html",controller:"ArticlesController"}).state("dashboard.addFeed",{url:"/add",templateUrl:"./partials/dashboard/add-feed.html",controller:"FeedsController",resolve:{dashboardPromise:["dashboardService",function(e){return e.setTitle("Add Feed")}]}})}]),angular.module("rssreader").controller("ArticlesController",["$scope","$state","articlesService","dashboardService",function(e,t,r,o){e.articles=r.articles,e.isFavourites=r.checkIfFavourites,e.addFavourite=function(e){r.addFavourite(e).then(function(e){t.reload("dashboard")},function(e){console.log(e.data.message)})},e.removeFavourite=function(e){r.removeFavourite(e).then(function(e){t.reload("dashboard")},function(e){console.log(e)})}}]),angular.module("rssreader").controller("AuthController",["$scope","$state","authService","$window","dashboardService",function(e,t,r,o,a){e.user={},e.session;var n={field_required:"This field is required",email_example:"Please, use example: jacksparrow@gmail.com",char_num6_required:"Please, enter at least 6 characters",char_num9_required:"Please, enter at least 9 characters",char_num20_required:"Please, enter at least 20 characters"};e.register=function(o){console.log(e.user),o.validate()&&r.register(e.user).error(function(t){e.error=t}).then(function(){t.go("dashboard."+a.currentView,{id:r.userID()})})},e.logIn=function(n){n.validate()&&r.logIn(e.user,e.session).error(function(t){e.error=t}).then(function(){e.session?t.go("dashboard."+a.currentView,{id:r.userID()}):(e.onExit=function(){auth.logOut()},t.go("dashboard."+a.currentView,{id:r.userID()}),o.onbeforeunload=e.onExit)})},e.validationLoginOptions={rules:{mail:{required:!0,email:!0},pwd:{required:!0}},messages:{mail:{required:n.field_required,email:n.email_example},pwd:{required:n.field_required}}},e.validationRegistrOptions={rules:{mail:{required:!0,email:!0,minlength:9,maxlength:20},pwd:{required:!0,minlength:6,maxlength:20},reppwd:{required:!0,minlength:6,maxlength:20}},messages:{mail:{required:n.field_required,email:n.email_example,minlength:n.char_num9_required,maxlength:n.char_num20_required},pwd:{required:n.field_required,minlength:n.char_num6_required,maxlength:n.char_num20_required},reppwd:{required:n.field_required,minlength:n.char_num6_required,maxlength:n.char_num20_required}}}}]),angular.module("rssreader").controller("DashboardController",["$scope","$state","dashboardService","feedsService",function(e,t,r,o){e.headTitle=r.getTitle,e.feed=r.getFeedId,e.toggle1=!1,e.toggle2=!1,e.toggle3=!0,e.hideViewBtns=function(){return"Add Feed"===e.headTitle()||0==o.getDictionary().length},e.onViewChange=function(o,a){switch(o.currentTarget.id){case"viewBtnOne":e.toggle1=!0,e.toggle2=!1,e.toggle3=!1;break;case"viewBtnTwo":e.toggle1=!1,e.toggle2=!0,e.toggle3=!1;break;case"viewBtnThree":e.toggle1=!1,e.toggle2=!1,e.toggle3=!0}r.currentView=a,t.go("dashboard."+r.currentView)},e.onFeedDelete=function(){o.removeFeed(r.getFeedId()).then(function(e){t.reload("dashboard")},function(e){console.log(e)})}}]),angular.module("rssreader").controller("FeedsController",["$scope","$state","feedsService","dashboardService","articlesService",function(e,t,r,o,a){e.obj={},e.feeds=r.feedsDictionary,e.categories=r.CATEGORIES,e.addFeed=function(){e.error="",r.addFeed(e.obj).then(function(e){a.getAllArticles(),t.reload("dashboard"),a.getAllArticles(),t.go("dashboard."+o.currentView)},function(t){console.log(t),t.data?e.error=t.data.message:e.error=t.message})}}]),angular.module("rssreader").controller("HomeController",["$scope","$state","authService","dashboardService","feedsService",function(e,t,r,o,a){e.isLoggedIn=r.isLoggedIn,e.currentUser=r.currentUser,e.OnFeeds=function(){r.isLoggedIn()?t.go("dashboard."+o.currentView,{id:r.userID()}):alert("Unauthtorized")},e.OnRegister=function(){t.go("register")},e.OnLogin=function(){t.go("login")}}]),angular.module("rssreader").controller("IndexController",["$scope","$state","authService","$window","themeService",function(e,t,r,o,a){e.layout=a.getTheme,e.text="some text"}]),angular.module("rssreader").controller("NavbarController",["$scope","$state","authService",function(e,t,r){e.isLoggedIn=r.isLoggedIn,e.currentUser=r.currentUser,e.logOut=function(){r.logOut(),t.go("home")},e.goHome=function(){e.isLoggedIn()?t.go("dashboard"):t.go("home")}}]),angular.module("rssreader").controller("ProfileController",["Upload","$http","$state","profileService","$scope","authService","$window","themeService","dashboardService",function(e,t,r,o,a,n,i,s,l){a.submit=function(){console.log(a.file),a.upload_form.file.$valid&&a.file&&a.upload(a.file)},a.upload=function(t){e.upload({url:"http://localhost:8080/upload",headers:{Authorization:"Bearer "+n.getToken()},data:{file:t}}).then(function(e){0===e.data.error_code?i.alert("Success "+e.config.data.file.name+"uploaded. Response: "):i.alert("an error occured")},function(e){console.log("Error status: "+e.status),i.alert("Error status: "+e.status)},function(e){console.log(e);var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.data.file.name),a.progress="progress: "+t+"% "})},a.newUserData={email:n.currentUser(),currentPass:"",newPass:"",newPassRepeat:""},a.changePass=function(){return console.log("Submit change password"),t.post("/changePassword",a.newUserData,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){n.saveToken(e.token),r.go("dashboard."+l.currentView,{id:n.userID()})}).error(function(e){a.err=e,console.log(e.message)})},a.user=n.currentUser,a.updateTheme=function(){s.layout=a.layout,console.log("Theme update"),console.log("Theme:"+s.layout)},a.layout=s.layout,a.layouts=s.layouts}]),angular.module("rssreader").controller("SidebarController",["$scope","$state","feedsService","articlesService","dashboardService",function(e,t,r,o,a){e.feeds=r.feedsDictionary,e.favs=r.favourites,e.getAll=function(){console.log("getAll"),1===e.feeds.length&&1===e.feeds[0].values.length?e.getByFeed(e.feeds[0].values[0]):o.getAllArticles(),t.go("dashboard."+a.currentView)},e.getByFeed=function(e){o.getArticlesByFeed(e),t.go("dashboard."+a.currentView)},e.getByCat=function(r,n){1==e.feeds[n].values.length?e.getByFeed(e.feeds[n].values[0]):o.getArticlesByCat(r),t.go("dashboard."+a.currentView)},e.getFavourites=function(){o.getFavourites(),t.go("dashboard."+a.currentView)},e.getFavArticle=function(e){o.getFavArticle(e),t.go("dashboard."+a.currentView)},e.hideFavourites=function(){return e.favs.length},e.checkIfEmpty=function(){return 0!=r.getDictionary().length},e.toggle=!1}]),angular.module("rssreader").service("articlesService",["$http","$q","authService","dashboardService","feedsService",function(e,t,r,o,a){var n={articles:[],isFavourites:!1},i=50,s=function(t){return e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num="+i+"&q="+encodeURIComponent(t.rsslink)+"&method=JSON&callback=JSON_CALLBACK").then(function(e){for(var t=e.data.responseData.feed,r=0;r<t.entries.length;r++){var o={},a=document.createElement("content");a.innerHTML=t.entries[r].content;var i;i=void 0===$(a).find("img")[0]?"":$(a).find("img")[0].src,o.title=t.entries[r].title,o.link=t.entries[r].link,o.content=t.entries[r].contentSnippet,o.img=i,o.date=t.entries[r].publishedDate,n.articles.push(o)}},function(e){console.log(e)})};return n.checkIfFavourites=function(){return n.isFavourites},n.getAllArticles=function(){console.log("all"),n.isFavourites=!1,n.articles.length=0,o.setTitle("All"),o.resetFeedId(),angular.forEach(a.feedsDictionary,function(e,t){angular.forEach(e.values,function(e,t){s(e)})})},n.getArticlesByFeed=function(e){n.isFavourites=!1,n.articles.length=0,o.setTitle(e.title),o.setFeedId(e._id),s(e)},n.getArticlesByCat=function(e){n.isFavourites=!1,n.articles.length=0,o.setTitle(e),o.resetFeedId(),angular.forEach(a.feedsDictionary,function(t,r){t.key===e&&angular.forEach(t.values,function(e,t){s(e)})})},n.getFavourites=function(){n.isFavourites=!0,n.articles.length=0,o.setTitle("Favourites"),o.resetFeedId(),console.log(a.favourites),angular.copy(a.favourites,n.articles)},n.getFavArticle=function(e){n.isFavourites=!0,o.setTitle("Favourites"),o.resetFeedId(),n.articles.length=0,n.articles.push(e)},n.addFavourite=function(t){return e.post("/users/"+r.userID()+"/addFavArticle",t,{headers:{Authorization:"Bearer "+r.getToken()}})},n.removeFavourite=function(t){return console.log("Removing:"),console.log("ArticleId:"+t._id),e["delete"]("/users/"+r.userID()+"/deleteFavFeed/"+t._id,{headers:{Authorization:"Bearer "+r.getToken()}})},n}]),angular.module("rssreader").factory("authService",["$http","$window",function(e,t){var r={};return r.saveToken=function(e){t.localStorage["rss-reader-token"]=e},r.getToken=function(){return t.localStorage["rss-reader-token"]},r.isLoggedIn=function(){var e=r.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},r.currentUser=function(){if(r.isLoggedIn()){var e=r.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o.email}},r.userID=function(){if(r.isLoggedIn()){var e=r.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o._id}},r.register=function(t){return e.post("/register",t).success(function(e){r.saveToken(e.token)}).error(function(e){console.log(e.message)})},r.logIn=function(t){return e.post("/login",t).success(function(e){r.saveToken(e.token)}).error(function(e){console.log(e.message)})},r.logOut=function(){t.localStorage.removeItem("rss-reader-token")},r}]),angular.module("rssreader").service("dashboardService",[function(){this.DEFAULT_VIEW="th-large",that=this,this.title="",this.setTitle=function(e){"Add Feed"==e&&this.resetFeedId(),that.title=e},this.getTitle=function(){return that.title},this.currentView=this.DEFAULT_VIEW,this.currentFeed="",this.getFeedId=function(){return that.currentFeed},this.setFeedId=function(e){that.currentFeed=e},this.resetFeedId=function(){that.currentFeed=""}}]),angular.module("rssreader").service("feedsService",["$http","$state","authService","dashboardService",function(e,t,r,o){that=this,this.feedsDictionary=[],this.favourites=[],this.allArticles=[],this.CATEGORIES=["News","IT","Sport","Design","Movies","Music","Culture","Nature","Economics","Science"],this.getAllFeeds=function(){return e.get("/users/"+r.userID(),{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){angular.copy(e.data,that.feedsDictionary),console.log("dictionary:"),console.log(that.feedsDictionary),that.getAllFavourites().then(function(e){angular.copy(e.data,that.favourites),console.log("favs:"),console.log(that.favourites)})})},this.getAllFavourites=function(){return e.get("/users/"+r.userID()+"/favourites",{headers:{Authorization:"Bearer "+r.getToken()}})},this.getDictionary=function(){return that.feedsDictionary},this.addFeed=function(t){return e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&q="+encodeURIComponent(t.link)+"&method=JSON&callback=JSON_CALLBACK").then(function(o){if(void 0===t.category)throw new Error("Choose category");if(null===o.data.responseData)throw new Error("URL is incorrect or does not contain RSS Feed data");var a,n={};return a=o.data.responseData.feed,n.title=a.description||a.title,n.link=a.link,n.rsslink=t.link,n.category=t.category,e.post("/users/"+r.userID()+"/addFeed",n,{headers:{Authorization:"Bearer "+r.getToken()}})},function(e){console.log(e)})},this.removeFeed=function(t){return console.log("Removing:"),console.log("feedId:"+t),e["delete"]("/users/"+r.userID()+"/deleteFeed/"+t,{headers:{Authorization:"Bearer "+r.getToken()}})}}]),angular.module("rssreader").service("profileService",["$window","Upload",function(e,t){}]),angular.module("rssreader").service("themeService",["authService","$window",function(e,t){that=this,this.layout="style",this.getTheme=function(){return void 0!==that.layout?that.layout:"style"},this.layouts=[{name:"Blue",url:"style"},{name:"Black",url:"style2"},{name:"Grey",url:"style3"}]}]);